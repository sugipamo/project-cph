# DockerRunnerのデバッグ記録

## 問題の概要

DockerRunnerのテストが失敗し、以下のエラーが発生：

- C++: `main.cpp: No such file or directory`
- PyPy: `can't open file /compile/main.py`
- Python: `can't open file /compile/main.py`
- Rust: `couldn't read main.rs`

## アプローチ1: ファイルの配置修正

### 試行内容
- `temp_dir/compile`ディレクトリを作成
- ソースファイルを`compile`ディレクトリに配置
- マウントポイントを`/compile`に設定

### 結果
- 失敗：ファイルが見つからないエラーが継続

## アプローチ2: パーミッションの設定

### 試行内容
- 親ディレクトリに`0o777`を設定
- ソースファイルに`0o644`を設定
- コンパイルディレクトリに`0o777`を設定

### 結果
- 失敗：パーミッションは正しいが、ファイルが見つからない

## アプローチ3: マウントポイントの変更

### 試行内容
- マウントポイントを`.`に変更
- 作業ディレクトリを`.`に設定

### 結果
- 失敗：Dockerが相対パスを受け付けない

## アプローチ4: 絶対パスの使用

### 試行内容
- マウントポイントを`/workspace`に変更
- 作業ディレクトリを`/workspace`に設定
- コマンドに`cd /workspace`を追加

### 結果
- 失敗：ファイルが見つからないエラーが継続

## アプローチ5: デバッグ情報の強化

### 試行内容
- `ls -la`コマンドを追加
- ローカルディレクトリの内容を表示
- Dockerコンテナ内のディレクトリを確認

### 結果
- ローカルファイルは正しく作成されている
- コンテナ内のディレクトリが空

## アプローチ6: ユーザーマッピングとマウントオプションの改善

### 試行内容
1. ユーザーマッピングの追加
   - ホストのUID/GIDをコンテナ内で使用
   - `--user`オプションの追加

2. マウントオプションの改善
   - `rw,z`オプションの追加
   - `delegated`オプションの追加
   - SELinux/AppArmorの設定調整

3. 事前準備の追加
   - マウントポイントの所有者を事前に設定
   - 初期化用コンテナの実行

### 結果
- 改善：デバッグ情報が充実
- 課題：ファイルの同期に問題が残る

## アプローチ7: エラー処理とデバッグ機能の強化

### 試行内容
1. エラー型の改善
   - `DockerError`に`Filesystem`バリアントを追加
   - エラー変換の実装（`From`トレイトの実装）

2. デバッグ機能の強化
   - 詳細なログ出力の追加
   - マウントポイントの検証機能
   - ファイルシステムの状態確認

3. テストの改善
   - マウントポイント専用のテストケース
   - デバッグ情報の出力強化
   - エラー時の詳細情報収集

### 結果
- 改善：問題の切り分けが容易に
- 課題：マウントの問題が依然として存在

## 現在の状態

1. ファイルシステムの状態：
   - ローカル：ファイルが存在し、パーミッションも正しい
   - Docker：マウントポイントは認識されるが、ファイルが同期されない

2. 試したアプローチ：
   - ファイルの配置場所の変更
   - パーミッションの調整
   - マウントオプションの設定変更
   - ユーザーマッピングの追加
   - デバッグ情報の強化

3. 次のステップ：
   - Dockerのボリュームドライバーの検証
   - 別のマウント方式の検討（バインドマウント以外）
   - コンテナ実行前の同期確認メカニズムの追加 