# 複雑なものをきれいにしたい - リファクタリング計画

## 🎯 目標
高複雑性モジュールを**純粋関数中心**の設計に段階的リファクタリングし、テスト容易性・保守性・可読性を向上させる

## 🧠 設計方針: 純粋関数優先
- **状態変更を最小化**: 可能な限り入力→出力の純粋関数で実装
- **副作用の分離**: I/O・状態変更は専用レイヤーに集約
- **関数型思考**: map/filter/reduce パターンの活用
- **不変性重視**: dataclass(frozen=True) とimmutableな操作

## 📊 現状分析

### ✅ 緊急度: 高 - 対応完了
1. **RequestExecutionGraph.execute_parallel()** → 純粋関数に分割済み
2. **GraphBasedWorkflowBuilder._build_dependencies()** → 純粋関数に分割済み

### 🟡 緊急度: 中 - 段階的対応
1. **request_execution_graph.py** (665行) - ファイル分割
2. **graph_based_workflow_builder.py** (464行) - 責務分離
3. **docker_command_builder.py** (335行) - コマンド生成ロジック

### 🟢 緊急度: 低 - 長期改善
1. 設定システムの統一化
2. 継承階層の見直し

## 📅 実行計画

### ✅ Phase 1: 緊急対応 (完了済み)

Phase 1は完全に実装済みです。以下のリファクタリングが完了しました：

- ✅ **関数型ユーティリティ** (`functional_utils.py`) 実装完了
- ✅ **グラフ操作モジュール** (`graph_ops/`) ディレクトリ作成完了
- ✅ **RequestExecutionGraph.execute_parallel()** の純粋関数分割完了
- ✅ **GraphBasedWorkflowBuilder._build_dependencies()** の純粋関数分割完了
- ✅ すべての副作用を適切に分離
- ✅ 関数型パイプラインパターンの実装

### Phase 2: ファイル分割 (3-5日)

#### 2.1 RequestExecutionGraph → 純粋関数モジュール分割
```
src/workflow/builder/
├── request_execution_graph.py (現在665行 → 100行以下に削減)
└── execution/  # 新ディレクトリ (純粋関数中心)
    ├── planning.py               # 実行計画生成 (純粋関数群)
    ├── dependency_analysis.py    # 依存関係分析 (純粋関数群)
    ├── result_processing.py      # 結果処理 (純粋関数群)
    ├── validation.py             # バリデーション (純粋関数群)
    └── effects.py                # 副作用操作 (I/O・実行のみ)
```

**作業項目:**
- [ ] `planning.py` - 純粋関数による実行計画生成
- [ ] `dependency_analysis.py` - 純粋関数による依存関係解析
- [ ] `result_processing.py` - 純粋関数による結果変換・集約
- [ ] `validation.py` - 純粋関数によるバリデーション
- [ ] `effects.py` - 副作用操作を集約 (テストはモック使用)
- [ ] RequestExecutionGraph を薄いコーディネーターに変更

#### 2.2 GraphBasedWorkflowBuilder → 純粋関数モジュール分割
```
src/workflow/builder/
├── graph_based_workflow_builder.py (現在464行 → 80行以下に削減)
└── graph_ops/  # 新ディレクトリ (純粋関数中心)
    ├── metadata_extraction.py   # リクエストメタデータ抽出 (純粋関数)
    ├── dependency_mapping.py    # 依存関係マッピング (純粋関数)
    ├── cycle_detection.py       # 循環依存検出 (純粋関数)
    ├── graph_optimization.py    # グラフ最適化 (純粋関数)
    └── functional_utils.py      # pipe, compose 等の関数型ユーティリティ
```

**作業項目:**
- [ ] `metadata_extraction.py` - 純粋関数によるメタデータ抽出
- [ ] `dependency_mapping.py` - 純粋関数による依存関係構築
- [ ] `cycle_detection.py` - 純粋関数による循環依存検出
- [ ] `graph_optimization.py` - 純粋関数による最適化
- [ ] `functional_utils.py` - 関数型プログラミングユーティリティ
- [ ] GraphBasedWorkflowBuilder を関数型パイプラインのコーディネーターに変更

### Phase 3: 品質向上 (1週間)

#### 3.1 関数型パターン + 不変データ構造
- [ ] **Pure Function パターン**: すべてのビジネスロジックを純粋関数化
- [ ] **Pipeline パターン**: データ変換の連鎖を明示的に
- [ ] **Immutable パターン**: `@dataclass(frozen=True)` による不変オブジェクト
- [ ] **Function Composition**: 小さな関数の組み合わせで複雑な処理を実現

#### 3.2 関数型品質指標
- [ ] **純粋関数率**: 90%以上のロジックを純粋関数化
- [ ] **関数サイズ**: 1関数15行以下を目標
- [ ] **循環複雑度**: 純粋関数は5以下、副作用関数は8以下
- [ ] **副作用分離**: I/O・状態変更を専用モジュールに集約

#### 3.3 関数型テスト戦略
- [ ] **純粋関数テスト**: モック不要の高速単体テスト
- [ ] **Property-based テスト**: hypothesis を使った網羅的テスト
- [ ] **Composition テスト**: 関数の組み合わせが正しく動作することを確認
- [ ] **副作用テスト**: 分離された副作用のみモックテスト

## 🚧 リスク管理

### 既存機能への影響
- **対策**: 段階的リファクタリング + 既存テスト維持
- **検証**: 各Phase完了時に全テスト実行

### パフォーマンス影響
- **対策**: ベンチマークテスト実装
- **基準**: 実行時間の5%以内の変動に抑制

### API互換性
- **対策**: 公開APIは変更せず、内部実装のみ変更
- **検証**: インターフェーステスト実行

## 📈 成功指標

### 定量的指標 (関数型品質重視)
- [ ] **純粋関数率**: 0% → 90%以上
- [ ] **循環複雑度**: 20+ → 純粋関数5以下、副作用関数8以下  
- [ ] **最大関数行数**: 103行 → 15行以下
- [ ] **最大ファイル行数**: 665行 → 150行以下
- [ ] **副作用関数数**: 最小限に削減 (全体の10%以下)

### 定性的指標 (関数型メリット)
- [ ] **テスト実行速度**: モック減少により50%高速化
- [ ] **バグ再現性**: 純粋関数により100%再現可能
- [ ] **並行安全性**: 状態共有なしで安全な並行処理
- [ ] **理解容易性**: 入力→出力の明確な関数で可読性向上

## 🔄 実施順序

1. **Week 1**: Phase 1 (緊急対応)
2. **Week 2-3**: Phase 2 (ファイル分割)
3. **Week 4**: Phase 3 (品質向上)
4. **Week 5**: 検証・ドキュメント更新

## 📝 関数型実装の注意事項

### 純粋関数の実装ガイドライン
- **入力のみに依存**: グローバル変数・インスタンス変数は使用禁止
- **戻り値のみで結果表現**: print文・ログ出力は副作用関数に委譲
- **不変性の徹底**: 引数の変更禁止、新しいオブジェクト返却
- **例外は純粋関数**: 計算エラーは例外で表現可能

### 副作用の適切な分離
- **I/O操作**: ファイル読み書き・DB操作・HTTP通信
- **状態変更**: グローバル変数・キャッシュ・ログ出力
- **時間依存**: 現在時刻取得・タイマー操作
- **ランダム**: 乱数生成 (テスト用シード対応)

### テスト戦略
- **純粋関数**: アサーション中心の高速テスト
- **副作用**: モック・スタブを最小限使用
- **組み合わせ**: 関数合成の動作確認

---

*この計画により、**テスト容易で保守性の高い関数型アーキテクチャ**に変革し、開発効率が飛躍的に向上します。*