# アーキテクチャおよびCLAUDE.md違反調査レポート
作成日: 2025/06/28 17:06

## エグゼクティブサマリー

CPHプロジェクトのコードベースを詳細に調査した結果、以下の重大な違反を発見しました：

1. **循環依存**: 4ファイルで遅延インポートによる回避
2. **クリーンアーキテクチャ違反**: ドメイン層・アプリケーション層が直接インフラ層に依存
3. **CLAUDE.md規約違反**: デフォルト値使用、フォールバック処理が多数存在
4. **技術的負債**: 「互換性維持」という名目で短期的解決が常態化

これらの違反は、システムの保守性、テスタビリティ、拡張性に深刻な影響を与えています。

## 1. 循環依存の詳細

### 1.1 遅延インポートを使用しているファイル

#### src/domain/step_runner.py
- **場所**: create_step関数内（行366）
- **遅延インポート**: `from src.configuration.config_resolver import resolve_best`
- **理由**: config_resolverがstep_runnerを参照している可能性
- **影響**: ステップ作成時のパフォーマンス低下、依存関係の不明瞭化

#### src/infrastructure/drivers/generic/persistence_driver.py
- **場所**: __init__メソッド内（行102）
- **遅延インポート**: `from src.infrastructure.sqlite_provider import SystemSQLiteProvider`
- **理由**: SQLiteProviderとの循環参照
- **影響**: 初期化時のオーバーヘッド、テストの困難化

#### src/presentation/user_input_parser.py
- **場所**: _setup_context_persistence_and_docker関数内（行422）
- **遅延インポート**: `from src.infrastructure.docker_naming_provider import DockerNamingProvider`
- **理由**: DockerNamingProviderとの循環参照の可能性
- **影響**: Docker設定時の遅延、依存関係の複雑化

#### src/configuration/di_config.py
- **場所**: _create_request_creator関数内（行75-78）
- **遅延インポート**: 
  ```python
  from src.application.execution_requests import DockerRequest, FileRequest, ShellRequest, PythonRequest, DockerOpType
  from src.infrastructure.requests.file.file_op_type import FileOpType
  from src.operations.error_converter import ErrorConverter
  from src.operations.results.result_factory import ResultFactory
  ```
- **理由**: リクエスト作成時の循環参照回避
- **影響**: DIコンテナの初期化が複雑化

## 2. クリーンアーキテクチャ違反

### 2.1 ドメイン層の違反

#### src/domain/workflow_logger_adapter.py
- **違反内容**: インフラ層のDIContainerを直接インポート（行5）
- **問題点**: 
  - ドメインロジックがインフラ実装に依存
  - ドメイン層の独立性が失われる
  - 単体テストが困難

### 2.2 アプリケーション層の違反（8ファイル）

1. **src/application/mock_output_manager.py**
   - DIContainerを直接インポート

2. **src/application/execution_requests.py**
   - 5つのインフラ実装を直接インポート
   - JsonProvider, OsProvider, RegistryProvider, FileOpType, TimeProvider

3. **src/application/contest_manager.py**
   - DIKey, FileOpType, SystemTimeProviderを直接インポート

4. **src/application/config_manager.py**
   - DIKeyを直接インポート
   - コメントで「クリーンアーキテクチャ違反要修正」と明記

5. **src/application/services/debug_service.py**
   - DIContainerを直接インポート

6. **src/application/services/config_loader_service.py**
   - DIContainer, DIKeyを直接インポート

7. **src/application/sqlite_manager.py**
   - SystemSQLiteProviderを直接インポート

8. **src/application/fast_sqlite_manager.py**
   - SystemSQLiteProviderを直接インポート

## 3. CLAUDE.md規約違反

### 3.1 デフォルト値使用違反（27ファイル）

主要な違反例：
- **src/infrastructure/drivers/generic/execution_driver.py**
  - 複数の関数でデフォルト引数を使用
- **src/application/execution_requests.py**
  - timeout=None, kwargs=Noneなど多数

### 3.2 フォールバック処理違反

#### getattr()によるフォールバック
- **src/infrastructure/drivers/generic/execution_driver.py**（行37-45）
  ```python
  python_executable = getattr(self.config_provider, 'python_executable', 'python')
  docker_login_registry = getattr(self.config_provider, 'docker_login_registry', '')
  ```

#### .get()によるフォールバック
- **src/domain/step_runner.py**（行349-351）
  ```python
  json_step.get("type", "shell"),
  json_step.get("command", ""),
  json_step.get("when", "")
  ```

#### 明示的なフォールバックコード
- **src/domain/step_runner.py**（行374-387）
  ```python
  # 設定が取得できない場合のフォールバック
  defaults = {
      "type": "shell",
      "command": "",
      "depends_on": [],
      "timeout": 30000,
      "ignore_errors": False
  }
  ```

## 4. 技術的負債の証拠

### 4.1 「互換性維持」コメント
複数のファイルで「互換性維持」というコメントとともに、本来あるべきでない実装が残されている：

- **src/application/config_manager.py**（行12-14）
  ```python
  # 互換性維持: DIContainerはmain.pyから注入されるべき
  # 一時的な直接使用（クリーンアーキテクチャ違反要修正）
  ```

### 4.2 短期的解決の常態化
- 循環依存を遅延インポートで回避
- 設定システムがあるにも関わらず、ハードコードされたデフォルト値
- アーキテクチャ違反を認識しながら修正されていない

## 5. 影響分析

### 5.1 テスタビリティへの影響
- ドメイン層が独立してテストできない
- モックの作成が複雑化
- 統合テストに依存せざるを得ない

### 5.2 保守性への影響
- 依存関係が不明瞭で、変更の影響範囲が予測困難
- 新機能追加時に既存の違反パターンを踏襲する可能性

### 5.3 パフォーマンスへの影響
- 遅延インポートによる初回実行時のオーバーヘッド
- 不要な依存関係による起動時間の増加

## 6. 修正優先順位マトリクス

| 違反タイプ | ビジネス影響 | 技術的複雑さ | 優先度 |
|-----------|------------|------------|--------|
| ドメイン層のインフラ依存 | 高 | 中 | 1 |
| デフォルト値・フォールバック処理 | 高 | 低 | 2 |
| アプリケーション層のインフラ依存 | 中 | 中 | 3 |
| 循環依存（遅延インポート） | 低 | 高 | 4 |

## 7. 推奨事項

### 7.1 即座に対応すべき事項
1. ドメイン層（workflow_logger_adapter.py）からインフラ依存を除去
2. step_runner.pyのフォールバック処理を設定ベースに変更

### 7.2 段階的に対応すべき事項
1. インターフェースを定義し、依存性逆転を実装
2. DIコンテナの使用をmain.pyに限定
3. 設定システムを活用した適切なデフォルト値管理

### 7.3 長期的な改善
1. アーキテクチャガイドラインの策定と遵守
2. 自動チェックツールの導入
3. リファクタリングの定期的な実施

## 結論

現在のコードベースは、CLAUDE.mdの理念に反して短期的な解決策が蓄積された状態です。特に、明確に禁止されているデフォルト値やフォールバック処理が広範囲に使用されており、これらは「必要なエラーを見逃す」という重大なリスクを内包しています。

段階的かつ計画的な修正により、中長期的に保守可能なシステムへの改善が必要です。