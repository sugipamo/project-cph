# ドメイン層

## 概要
ビジネスロジックとビジネスルールを含む層。外部依存を持たない純粋な業務ロジックを実装。

## 含まれるファイル

### コアドメインモデル
- **domain.md** - ワークフロー管理、ステップ処理、依存関係解決、リクエスト抽象化
  - Workflow、Step、Dependency などのコアエンティティ
  - ビジネスルールの実装
  - ドメインイベント

### 基盤インターフェース・型定義
- **base_request.py** - リクエスト種別と操作インターフェース
  - `RequestType`列挙型: リクエスト種別の型安全な識別（Docker, File, Shell, Python, Composite等）
  - `ExecutionInterface`: 基本実行操作
  - `FileOperationInterface`: ファイル操作
  - `DockerOperationInterface`: Docker操作
  - `PythonOperationInterface`: Python実行
  - `ShellOperationInterface`: シェル実行

- **base_composite_request.py** - 複合リクエストの基盤
  - `CompositeRequestFoundation`: 複数リクエストを集約する基盤クラス
  - サブリクエストの型安全な管理
  - 階層的な実行単位の提供
  - リーフリクエスト数のカウント機能

- **config_node.py** - 階層的設定データ構造
  - `ConfigNode`: 階層的設定データの単一ノード表現
  - 親子関係の管理
  - エイリアス対応のマッチセット
  - 設定の木構造を効率的に表現

### ステップ処理システム
- **step.py** - 実行ステップの定義
  - `StepType`列挙型: 実行可能な操作種別（Shell, Python, Copy, Docker等33種類）
  - `StepContext`: ステップ生成に必要な全ての不変コンテキスト情報
  - `Step`: 実行可能な単一ステップの不変表現
  - `StepGenerationResult`: ステップ生成結果（ステップ配列・エラー・警告）

- **step_runner.py** - ステップ実行パイプライン
  - `ExecutionContext`: ステップ実行時のコンテキスト
  - テンプレート展開: `{variable}`形式の文字列置換
  - ファイルパターン処理: ワイルドカードパターンの実ファイル展開
  - test条件評価: `test -d path`形式の条件式評価
  - JSON→Step変換→実行の流れ

- **dependency.py** - 依存関係解決
  - `resolve_dependencies`: メイン解決関数
  - `generate_preparation_steps`: MKDIR/TOUCHステップの自動生成
  - `analyze_step_dependencies`: ファイル作成/使用の依存分析
  - `optimize_mkdir_steps`: 連続MKDIRステップの最適化
  - `optimize_copy_steps`: 冗長コピー操作の除去

### ワークフロー管理
- **workflow.py** - ワークフローパイプライン
  - `generate_workflow_from_json`: メインパイプライン関数
  - `steps_to_requests`: Step配列のリクエスト変換
  - `optimize_workflow_steps`: ステップ最適化の統合
  - `validate_workflow_execution`: 実行前検証
  - 完全純粋関数パイプライン

### エラーハンドリング
- **composite_step_failure.py** - 複合ステップエラー
  - `CompositeStepFailureError`: 複合ステップ失敗時の専用例外
  - エラーコード自動分類
  - 一意エラーID生成
  - 提案・回復手順の提供
  - 構造化されたエラーメッセージ

### ログ・結果管理
- **workflow_logger_adapter.py** - ワークフローログアダプター
  - `WorkflowLoggerAdapter`: src/loggingとワークフロー固有ログの橋渡し
  - 設定駆動のアイコン・フォーマット管理
  - ステップライフサイクルログ（開始・成功・失敗）
  - 環境情報・準備フェーズのログ
  - 動的ログレベル変更

- **workflow_result.py** - ワークフロー実行結果
  - `WorkflowExecutionResult`: ワークフロー実行結果の統一表現
  - 成功/失敗状態
  - 実行結果配列
  - 準備フェーズ結果
  - エラー・警告リスト

### サービス層
- **services/config_node_service.py** - 設定ノード操作
  - `init_matches`: エイリアス初期化
  - `add_edge`: ノード間関係の構築
  - `path`: ノードパスの取得
  - `next_nodes_with_key`: キーマッチによる子ノード検索
  - `find_nearest_key_node`: BFS による最近傍ノード検索

- **services/step_generation_service.py** - ステップ生成統合
  - `StepGenerationService`: 新旧システム互換性を持つステップ生成サービス
  - コンテキスト変換（Typed↔Simple ExecutionContext）
  - JSON→Step変換パイプライン
  - テンプレート・ファイルパターン展開
  - ステップシーケンス検証・最適化

- **services/workflow_execution_service.py** - ワークフロー実行
  - `WorkflowExecutionService`: EnvWorkflowServiceの代替実装
  - 設定取得（並列実行設定・ワークフローステップ）
  - ワークフロー準備（JSON→最適化済みCompositeRequest）
  - 環境準備フェーズ実行
  - メインワークフロー実行（並列/逐次選択）
  - 結果分析・エラーハンドリング

### 操作標準化
- **operations.md** - アプリケーション層とドメイン層間の操作リクエスト/レスポンスの標準化
  - コマンドパターンの実装
  - Result型による明示的なエラーハンドリング
  - 操作の抽象化
  - **エラー処理詳細**:
    - `ErrorCode` enum: 標準化されたエラーコード定義（ファイル、シェル、Docker、Python、設定、ワークフロー、ネットワーク）
    - `ErrorSuggestion`: エラー回復のための提案機能
    - `ErrorConverter`: 例外をResult型に変換（CLAUDE.md準拠の唯一のtry-catch実装箇所）
    - `PythonExceptions`: Python固有の例外クラス定義
  - **リクエスト/レスポンス処理**:
    - `RequestFactory`: ステップオブジェクトからリクエストオブジェクトの生成
    - `CompositeRequest`: 複数リクエストの順次・並列実行
    - `CompositeStructure`: 複合リクエストの構造管理
    - `ResultFactory`: 標準化された結果オブジェクトの生成
  - **データ型定義**:
    - `PathOperationResult`: パス操作結果の統一データクラス
    - `PathInfo`: 不変パス情報クラス（依存性注入対応）
    - `FileResult`: ファイル操作専用の結果クラス
    - `CheckResult`: インポートチェック専用の結果クラス
    - `ValidationResult`: バリデーション結果型と検証関数群

## 依存関係とデータフロー

### 層間依存関係
```
domain/ (本層)
├── ← operations/ (Request作成、エラー分類)
├── ← configuration/ (設定解決)
├── ← logging/ (ログ出力)
└── ← utils/ (フォーマット情報)
```

### 内部データフロー
```
JSON Steps → StepGenerationService → Step[] → dependency.py → Step[] (resolved)
                                                           ↓
CompositeRequest ← workflow.py ← optimize_workflow_steps ← Step[] (optimized)
       ↓
WorkflowExecutionService → infrastructure drivers → WorkflowExecutionResult
```

### 主要な変換パイプライン
1. **設定→コンテキスト**: 環境設定からStepContext/ExecutionContext生成
2. **JSON→ステップ**: 設定JSONから実行可能Step配列生成
3. **依存解決**: ステップ間依存関係分析と準備ステップ挿入
4. **最適化**: 冗長ステップ除去とシーケンス効率化
5. **リクエスト化**: StepからCompositeRequest変換
6. **実行**: infrastructure経由での実際の操作実行

## 設計パターンと実装方針

### 採用パターン
- **Strategy Pattern**: 各種操作インターフェースによる実装切り替え
- **Composite Pattern**: CompositeRequestFoundationによる階層的構造
- **Template Method Pattern**: ワークフロー実行の共通フレームワーク
- **Factory Pattern**: Step/Request生成の統一インターフェース
- **Adapter Pattern**: WorkflowLoggerAdapterによるログシステム統合

### 関数型プログラミング要素
- **純粋関数**: dependency.py, workflow.pyの変換関数群
- **不変データ**: Step, StepContext, StepGenerationResult
- **関数合成**: パイプライン形式のデータ変換

### 設計原則
- **単一責任**: 各クラス・関数が明確な単一責務
- **開放閉鎖**: インターフェースによる拡張性確保
- **依存性逆転**: 抽象への依存、具象からの独立
- **設定駆動**: ハードコードを排除し設定ファイルから値取得

## 注意事項とメンテナンス要点

### 設定管理の重要事項
- **デフォルト値禁止**: CLAUDE.mdに従い、設定ファイルから必須取得
- **フォールバック処理禁止**: エラーを隠蔽せず明示的な例外発生
- **設定パス**: 階層的パス指定による構造化アクセス

### 依存性注入の徹底
- **infrastructure層**: 全てmain.pyから注入
- **副作用の局所化**: infrastructure層のみに制限
- **テスト容易性**: モックインターフェースによる単体テスト

### 互換性維持
- **新旧システム対応**: TypedExecutionConfiguration ↔ ExecutionContext変換
- **段階的移行**: 既存コードとの共存期間を考慮
- **明示的コメント**: 互換性維持箇所の文書化

### エラーハンドリング
- **構造化例外**: エラーコード・提案・回復手順の統一
- **ログ統合**: 統一ログシステムによる一貫した出力
- **デバッグ支援**: 実行段階の詳細な状態追跡

### パフォーマンス考慮
- **並列実行**: ステップレベル・ワークフローレベルの並列化
- **最適化**: 冗長操作除去・シーケンス効率化
- **メモリ効率**: 不変データによるコピー最小化

### コードベース全体との整合性
- **命名規則**: 一貫したクラス・関数名
- **型安全性**: 列挙型・データクラスによる型チェック
- **文書化**: 各モジュール・関数の目的と責務の明記

## 設計原則
- 外部システムへの依存を持たない
- ビジネスロジックに集中
- テスト可能性の確保
- 不変性とイミュータブルデータ構造の活用