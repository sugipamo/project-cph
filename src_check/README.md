# src_check - コード品質チェックシステム

## 概要

`src_check`は、プロジェクトのコーディング規約とアーキテクチャパターンを自動的に検証するコード品質チェックシステムです。CLAUDE.mdに定義された厳格なルールに基づいて、コードベースを分析し、違反を検出します。

## ディレクトリ構造

```
src_check/
├── main.py                 # エントリーポイント・オーケストレーター
├── models/                 # データ構造定義
│   └── check_result.py     # CheckResult, FailureLocationモデル
├── rules/                  # チェッカーモジュール群（20+個のチェッカー）
├── auto_correct/           # 自動修正スクリプト（現在は空）
└── src_check_result/       # チェック結果の出力先
```

## 主要コンポーネント

### 1. main.py
- すべてのチェッカールールを動的にロード・実行
- `src/`ディレクトリに焦点を当てた結果のフィルタリング
- 結果の保存と表示
- `rules/`と`auto_correct/`ディレクトリの両方を処理

### 2. models/check_result.py
- `FailureLocation`: 違反箇所（ファイルパス+行番号）を表現
- `CheckResult`: 違反箇所、修正方針、例示コードを含む結果データ

### 3. rules/（チェッカーモジュール）
各チェッカーは特定の品質ルールを実装し、同じパターンに従います：
- `main()`関数を実装し、`CheckResult`を返す
- ASTパーシングを使用してPythonコードを分析

## 主要なチェッカー

| チェッカー名 | 検証内容 |
|------------|---------|
| default_value_checker.py | 関数引数のデフォルト値を禁止 |
| fallback_checker.py | フォールバックエラー処理パターンを検出・禁止 |
| clean_architecture_checker.py | クリーンアーキテクチャのレイヤー依存関係を検証 |
| pytest_runner.py | pytestを実行してテスト失敗を報告 |
| dependency_injection_checker.py | 適切な依存性注入パターンを確保 |
| infrastructure_operations_checker.py | 許可されたディレクトリ外での副作用をチェック |
| mypy_checker.py | 型チェックの統合 |
| print_statement_checker.py | プロダクションコード内のprint文を検出 |
| naming_checker.py | 命名規則を検証 |

## 実行フロー

1. **初期化フェーズ**
   - プロジェクト構造の識別
   - 出力ディレクトリのセットアップ

2. **発見フェーズ**
   - `rules/`ディレクトリ内のすべての`.py`ファイルをスキャン
   - `auto_correct/`ディレクトリもスキャン

3. **実行フェーズ**
   - 各チェッカーモジュールを動的にインポート
   - 各チェッカーの`main()`関数を呼び出し
   - ASTパーシングによるコード分析
   - 各チェッカーが違反を含む`CheckResult`を返す

4. **フィルタリングフェーズ**
   - `src/`ディレクトリに焦点を当てて結果をフィルタリング
   - テスト関連ルール（例：`pytest_runner`）はフィルタリングから除外

5. **出力フェーズ**
   - 結果を`src_check_result/`内の個別のテキストファイルに保存
   - サマリーを表示：
     - 違反が少ない（≤10）ルールは簡潔なリスト表示
     - 違反が多い（>10）ルールは修正方針のみ表示

## 設計パターン

- **プラグインアーキテクチャ**: チェッカーは動的に発見・ロード
- **Visitorパターン**: ほとんどのチェッカーが`ast.NodeVisitor`を使用
- **データ駆動**: 各チェッカーは構造化データ（`CheckResult`）を返す
- **関心の分離**: 分析、フィルタリング、表示が独立

## CLAUDE.mdルールとの統合

このシステムは、CLAUDE.mdで定義された厳格なコーディング標準を強制します：
- 関数引数のデフォルト値禁止
- フォールバックエラー処理の禁止
- 適切な依存性注入
- 副作用はinfrastructureディレクトリのみ
- クリーンアーキテクチャのレイヤー境界
- グローバル設定の使用禁止

## 使用方法

```bash
python src_check/main.py
```

実行後、`src_check_result/`ディレクトリに詳細な違反レポートが生成されます。

## 新しいチェッカーの追加

1. `rules/`ディレクトリに新しい`.py`ファイルを作成
2. `main()`関数を実装し、`CheckResult`を返すようにする
3. 必要に応じてASTビジターを実装
4. システムが自動的に新しいチェッカーを検出・実行

## 今後の拡張予定

- `auto_correct/`ディレクトリへの自動修正機能の実装
- より詳細な違反レポートの生成
- CI/CDパイプラインとの統合強化