# テスト実行エラーパターン分析

## 1. Docker関連のテスト失敗パターン

### 1.1 DockerDriverのカバレッジ問題
- **現象**: DockerDriverのテストカバレッジが61%と低い
- **原因**: 
  - 実際のDockerデーモンとの通信部分がモックされていない
  - エラーハンドリングパスのテスト不足
  - 複雑な条件分岐のテスト不足
- **繰り返し発生頻度**: 全ての履歴で一貫して低カバレッジ

### 1.2 Docker関連のAPI変更
- **現象**: DockerCommandBuilderのカバレッジが0%→62%に改善したが、まだ低い
- **原因**: 新しいコマンドオプションの追加に対するテスト更新遅れ

## 2. 属性エラー（_config_manager vs config_manager）

### 2.1 プライベート属性名の不一致
- **現象**: `AttributeError: '_config_manager'`
- **原因**: 
  - DIコンテナの実装変更で属性名が変更された
  - テストでのモック設定が古い属性名を参照
- **具体例**: 
  ```python
  # 旧: self._config_manager
  # 新: self.config_manager
  ```
- **発生履歴**: 202506290019, 202506290036で修正された

## 3. API変更に伴うテスト失敗

### 3.1 LogFormatType Enumの値変更
- **現象**: テストが `RAW` と `CUSTOM` を期待するが、実際には存在しない
- **原因**: 
  - Enum値の変更: `RAW`→`STRUCTURED`/`PLAIN`、`CUSTOM`→`COLORED`
  - テストの更新漏れ
- **影響範囲**: `test_format_info.py`の4テスト
- **発生履歴**: 202506290411で詳細分析

### 3.2 FileDriver APIの必須パラメータ追加
- **現象**: メソッドシグネチャの変更によるテスト失敗
- **変更内容**:
  - `glob(pattern)` → `glob(pattern, root)`
  - `hash_file(path)` → `hash_file(path, algorithm)`
  - `create_file(path, content)` → `create_file(path, content, create_parents)`
- **原因**: CLAUDE.mdのデフォルト値禁止ルールによる必須パラメータ化
- **影響範囲**: `test_file_driver.py`の3テスト

### 3.3 TimeProvider必須化
- **現象**: FileRequestのインスタンス化時に`time_ops`パラメータが必須
- **原因**: タイムスタンプ処理の明示的な依存性注入
- **影響範囲**: ContestManagerの例外処理テスト11件

## 4. ContestManager関連の繰り返し失敗

### 4.1 例外処理テストの一貫した失敗
- **現象**: 11個の例外処理テストが繰り返し失敗
- **共通パターン**: 全て`time_ops`パラメータの欠如
- **テスト名パターン**: `test_*_exception`
- **根本原因**: FileRequestの作成時にSystemTimeProviderのインスタンスが必要

### 4.2 修正の繰り返し
- **202506290411**: 問題を特定
- **202506290436**: 部分的に修正
- **202506290529**: まだ53件のテストが失敗
- **パターン**: 同じ問題が複数回の実行で繰り返し発生

## 5. テスト実行時の不安定性の原因

### 5.1 依存性の順序問題
- **現象**: テスト実行順序によって結果が変わる
- **原因**: 
  - グローバル状態の共有
  - モックのリセット不足
  - 遅延インポートの副作用

### 5.2 カバレッジ測定の不一致
- **現象**: 同じコードでカバレッジ率が変動
- **例**: 
  - workflow_execution_service.py: 68%→75%→82%
  - sqlite_manager.py: 59%→83%
- **原因**: 
  - テストの実行順序
  - 条件分岐のテストケース追加

### 5.3 モック設定の複雑性
- **現象**: Mockオブジェクトの設定エラー
- **具体例**: `test_run_migrations`でのopen()メソッドの設定問題
- **原因**: 
  - ネストしたモックの設定ミス
  - コンテキストマネージャーのモック化の複雑性

## 6. 推奨される対策

### 6.1 即時対応
1. **API変更時のテスト同期更新**
   - コード変更とテスト更新を同一PRで実施
   - API変更チェックリストの作成

2. **必須パラメータの明示的な設定**
   - テストでのデフォルト値依存を排除
   - ファクトリーメソッドでの一元管理

### 6.2 中期的改善
1. **テストの安定性向上**
   - テスト間の独立性確保
   - setUp/tearDownでの確実なリセット
   - グローバル状態の排除

2. **カバレッジの継続的改善**
   - 低カバレッジファイルの定期的なレビュー
   - エラーパスの重点的なテスト追加

### 6.3 長期的改善
1. **アーキテクチャの簡素化**
   - 過度な抽象化の削減
   - テストしやすい設計への移行

2. **CI/CDの強化**
   - API変更検知の自動化
   - テストカバレッジの閾値設定