# 壊れたインポート自動修正ツール実装計画書（改訂版）

## 1. 概要

### 1.1 背景
- ファイル移動後に発生する壊れたインポートを動的に検出・修正する仕組みが必要
- 移動時の同時修正には限界があり、より汎用的かつ堅牢なアプローチが求められている
- 中長期的な保守性を考慮した設計が重要

### 1.2 目的
壊れたインポートを自動的に検出し、プロジェクト内を探索して本来の依存先を見つけ、自動修正するツールを開発する。CLAUDE.mdの指針に従い、堅牢で拡張性の高い実装を目指す。

### 1.3 期待される効果
- ファイル移動後のインポートエラーを確実に検出・修正
- 手動でのインポート修正作業を削減
- リファクタリング時の生産性向上
- エラーの原因を明確に報告

## 2. 技術仕様

### 2.1 設計原則
- **設定の外部化**: すべての設定は`settings/broken_import_fixer.json`で管理
- **依存性注入**: main.pyから全ての依存関係を注入
- **副作用の分離**: 副作用は`src/infrastructure`と`scripts/infrastructure`に限定
- **エラーハンドリング**: フォールバック処理を行わず、明示的にエラーを報告
- **デフォルト値の禁止**: すべての引数は呼び出し元で明示的に指定

### 2.2 主要コンポーネント

#### 2.2.1 BrokenImportDetector (src/domain/broken_import_fixer/)
```python
class BrokenImportDetector:
    def __init__(self, ast_parser: ASTParser, import_validator: ImportValidator):
        # 依存性は全て注入される
        self.ast_parser = ast_parser
        self.import_validator = import_validator
    
    def detect_broken_imports(self, file_path: Path, python_path: List[Path]) -> List[BrokenImport]:
        # デフォルト値なし、全て明示的に指定
        pass
```

#### 2.2.2 ModuleRepository (src/domain/broken_import_fixer/)
- プロジェクト全体のモジュール情報を管理
- インターフェースとして定義し、実装は`infrastructure`層に配置

#### 2.2.3 ImportResolver (src/domain/broken_import_fixer/)
```python
class ImportResolver:
    def __init__(self, strategies: List[SearchStrategy], scorer: CandidateScorer):
        self.strategies = strategies  # 戦略パターンで拡張可能
        self.scorer = scorer
    
    def resolve_import(self, broken_import: BrokenImport, 
                       module_repository: ModuleRepository,
                       confidence_threshold: float) -> Optional[ResolvedImport]:
        # 閾値は設定から注入、デフォルト値なし
        pass
```

#### 2.2.4 ImportFixer (src/application/broken_import_fixer/)
- ユースケースを実装
- ドメイン層のコンポーネントを組み合わせて修正を実行

### 2.3 探索戦略

```python
# src/domain/broken_import_fixer/strategies/
class SearchStrategy(Protocol):
    def search(self, broken_import: BrokenImport, 
               repository: ModuleRepository,
               config: SearchConfig) -> List[Candidate]:
        pass

# 具体的な戦略実装
class SymbolBasedStrategy(SearchStrategy):
    # シンボル名で検索
    pass

class PathSimilarityStrategy(SearchStrategy):
    # パスの類似性で検索
    pass

class DirectoryPatternStrategy(SearchStrategy):
    # ディレクトリ構造から推測
    pass

class GitHistoryStrategy(SearchStrategy):
    # Git履歴から追跡（複雑なマージ・リベースにも対応）
    pass
```

### 2.4 設定管理

`settings/broken_import_fixer.json`:
```json
{
  "search": {
    "confidence_threshold": 0.8,
    "max_candidates": 10,
    "timeout_seconds": 30
  },
  "strategies": {
    "symbol_based": {
      "enabled": true,
      "weight": 1.0
    },
    "path_similarity": {
      "enabled": true,
      "weight": 0.8,
      "min_similarity": 0.6
    },
    "directory_pattern": {
      "enabled": true,
      "weight": 0.7
    },
    "git_history": {
      "enabled": true,
      "weight": 0.9,
      "max_depth": 100
    }
  },
  "index": {
    "cache_enabled": true,
    "cache_ttl_seconds": 3600,
    "parallel_workers": 4
  },
  "output": {
    "dry_run": false,
    "backup_enabled": true,
    "verbose": true
  }
}
```

## 3. 実装フェーズ

### Phase 1: 基盤構築（7-10日）

#### Week 1: アーキテクチャとドメイン層
- [ ] プロジェクト構造のセットアップ
- [ ] ドメインモデルの定義（BrokenImport, Module, Candidate等）
- [ ] リポジトリインターフェースの定義
- [ ] 基本的な探索戦略インターフェースの定義
- [ ] 設定管理システムの実装

#### Week 2前半: インフラストラクチャ層
- [ ] ASTパーサーの実装
- [ ] モジュールインデックスの実装（キャッシュ機能含む）
- [ ] ファイルシステム操作の実装
- [ ] Git操作ラッパーの実装

### Phase 2: コア機能実装（10-14日）

#### Week 2後半-Week 3: 検出と探索
- [ ] BrokenImportDetectorの実装
- [ ] 各探索戦略の実装
  - [ ] SymbolBasedStrategy
  - [ ] PathSimilarityStrategy
  - [ ] DirectoryPatternStrategy
- [ ] スコアリングシステムの実装
- [ ] 単体テストの作成

#### Week 4: 修正機能とGit統合
- [ ] ImportFixerの実装
- [ ] バックアップ・リストア機能
- [ ] GitHistoryStrategyの実装（複雑なケース対応）
- [ ] 統合テストの作成

### Phase 3: 品質向上と最適化（5-7日）

#### Week 5: 最適化とエラーハンドリング
- [ ] パフォーマンス最適化
  - [ ] 並列処理の実装
  - [ ] インデックスの増分更新
- [ ] 詳細なエラーレポート機能
- [ ] 循環インポート検出
- [ ] エッジケースの対応

#### Week 6前半: ドキュメントとCI/CD
- [ ] APIドキュメントの作成
- [ ] 使用ガイドの作成
- [ ] CI/CDパイプラインの設定
- [ ] E2Eテストの作成

## 4. ファイル構成

```
src/
├── domain/
│   └── broken_import_fixer/
│       ├── __init__.py
│       ├── models/
│       │   ├── __init__.py
│       │   ├── broken_import.py
│       │   ├── module.py
│       │   ├── candidate.py
│       │   └── resolved_import.py
│       ├── services/
│       │   ├── __init__.py
│       │   ├── detector.py
│       │   ├── resolver.py
│       │   └── scorer.py
│       ├── strategies/
│       │   ├── __init__.py
│       │   ├── base.py
│       │   ├── symbol_based.py
│       │   ├── path_similarity.py
│       │   ├── directory_pattern.py
│       │   └── git_history.py
│       └── repositories/
│           ├── __init__.py
│           └── module_repository.py
├── application/
│   └── broken_import_fixer/
│       ├── __init__.py
│       └── use_cases/
│           ├── __init__.py
│           ├── fix_broken_imports.py
│           └── analyze_imports.py
├── infrastructure/
│   └── broken_import_fixer/
│       ├── __init__.py
│       ├── ast_parser.py
│       ├── module_indexer.py
│       ├── file_updater.py
│       ├── git_client.py
│       └── repositories/
│           ├── __init__.py
│           └── module_repository_impl.py
└── configuration/
    └── broken_import_fixer/
        ├── __init__.py
        └── config_loader.py

scripts/
└── infrastructure/
    └── broken_import_fixer/
        ├── __init__.py
        └── main.py  # エントリーポイント、全ての依存性を注入

settings/
└── broken_import_fixer.json

tests/
├── unit/
│   └── broken_import_fixer/
│       ├── test_detector.py
│       ├── test_resolver.py
│       └── test_strategies.py
├── integration/
│   └── broken_import_fixer/
│       └── test_fix_imports.py
└── e2e/
    └── test_broken_import_fixer.py
```

## 5. 技術スタック

- **言語**: Python 3.8+
- **主要ライブラリ**:
  - `ast`: 構文解析
  - `pathlib`: ファイルパス操作
  - `difflib`: 類似性計算
  - `GitPython`: Git操作
  - `click`: CLI（scripts層でのみ使用）
  - `pydantic`: 設定バリデーション

## 6. 成功指標

### 定量的指標
- インポートエラーの95%以上を検出
- 検出したエラーの85%以上を正しく修正
- 1000ファイルを10分以内で処理（キャッシュ利用時は2分以内）
- 誤修正率を1%未満に抑制

### 定性的指標
- エラー時の原因が明確に報告される
- 設定により動作をカスタマイズ可能
- 既存のコードベースとの整合性を保持
- 中長期的な保守が容易

## 7. リスクと対策

### リスク1: 誤った修正
**対策**: 
- 信頼度スコアによる明示的な閾値判定
- dry-runモードでの事前確認
- 修正前の必須バックアップ
- 詳細な修正レポートの生成

### リスク2: パフォーマンス問題
**対策**:
- インデックスの永続的キャッシュ
- 並列処理による高速化
- 増分更新による効率化
- タイムアウト設定による無限ループ防止

### リスク3: 複雑なインポートパターン
**対策**:
- 明示的なエラー報告（フォールバックなし）
- 手動修正のためのヒント提供
- 除外設定による特定パターンのスキップ
- 段階的な信頼度による部分的自動化

### リスク4: Git履歴の複雑性
**対策**:
- リベース・マージを考慮したアルゴリズム
- 履歴探索の深さ制限
- 複数の移動経路の追跡
- Git操作のエラーハンドリング強化

## 8. 将来の拡張性

- IDE統合（VS Code拡張機能）
- リアルタイムインポート修正
- 機械学習によるパターン認識（長期的目標）
- 他言語への対応（JavaScript/TypeScript）
- インポート最適化機能（未使用インポートの削除等）

## 9. 実装上の注意事項

1. **CLAUDE.mdの厳守**
   - デフォルト値の使用を完全に禁止
   - すべての設定は外部ファイルから読み込む
   - 副作用は指定されたディレクトリに限定
   - フォールバック処理を行わない

2. **責務の明確化**
   - 各層の責務を厳密に分離
   - ドメインロジックにインフラの詳細を混入させない
   - 適切な抽象化レベルを維持

3. **テスタビリティ**
   - すべての依存関係を注入可能に
   - 副作用を持つ処理を分離
   - モックしやすい設計

## 10. 承認事項

本計画書に基づいて実装を開始する前に、以下の点について確認が必要：

1. ディレクトリ構成とClean Architectureの適用
2. 設定ファイルの構造と配置
3. 実装スケジュール（3-4週間）
4. エラーハンドリング方針（フォールバックなし）
5. 依存性注入の徹底

---

作成日: 2024年12月26日
改訂日: 2024年12月26日
作成者: Claude Code Assistant