# 永続化層実装計画

## 概要
old_srcのinfrastructure/persistence/に実装されているSQLiteベースの永続化層をRustに移植する計画。

## 背景と目的
- **現状**: 現在のRustプロジェクトには永続化機能が未実装
- **old_srcの実装**: SQLiteを使用した実行履歴、設定、セッション情報の永続化
- **目的**: 実行履歴の記録、設定の永続化、統計情報の蓄積

## 実装すべき機能

### 1. データモデル
- 実行履歴の記録
- コンテスト情報の管理
- 設定値の永続化
- Dockerコンテナの追跡情報

### 2. リポジトリパターン
- 各エンティティごとのリポジトリ
- トランザクション管理
- クエリビルダーの抽象化

### 3. マイグレーション管理
- スキーマバージョン管理
- 自動マイグレーション実行
- ロールバック機能

### 4. パフォーマンス最適化
- コネクションプーリング
- プリペアドステートメントのキャッシュ
- バッチ処理のサポート

## 実装方針

### ディレクトリ構造
```
src/infrastructure/persistence/
├── mod.rs
├── connection.rs     # DB接続管理
├── schema.rs        # スキーマ定義
├── models/          # データモデル
│   ├── mod.rs
│   ├── execution.rs
│   ├── contest.rs
│   └── config.rs
├── repositories/    # リポジトリ実装
│   ├── mod.rs
│   ├── execution_repository.rs
│   └── config_repository.rs
├── migrations/      # マイグレーション
│   ├── mod.rs
│   └── v1__initial.sql
└── types.rs
```

### 主要な型定義
```rust
// リポジトリトレイト
#[async_trait]
trait Repository<T> {
    async fn find(&self, id: &str) -> Result<Option<T>>;
    async fn find_all(&self) -> Result<Vec<T>>;
    async fn save(&self, entity: &T) -> Result<()>;
    async fn delete(&self, id: &str) -> Result<()>;
}

// 実行履歴モデル
#[derive(Serialize, Deserialize, sqlx::FromRow)]
struct ExecutionHistory {
    id: String,
    problem_name: String,
    language: String,
    status: ExecutionStatus,
    started_at: DateTime<Utc>,
    finished_at: Option<DateTime<Utc>>,
    stdout: String,
    stderr: String,
    exit_code: Option<i32>,
}

// マイグレーション管理
struct MigrationManager {
    connection: SqlitePool,
}

impl MigrationManager {
    async fn run_migrations(&self) -> Result<()>;
    async fn rollback(&self, version: u32) -> Result<()>;
}
```

## 技術選定
- **sqlx**: 非同期SQLライブラリ（コンパイル時のクエリ検証）
- **sea-orm**: 高レベルORM（代替案）
- **refinery**: マイグレーション管理
- **uuid**: ID生成
- **chrono**: 日時処理

## 実装の詳細

### 1. 型安全なクエリ
```rust
// sqlxのマクロを使用
let execution = sqlx::query_as!(
    ExecutionHistory,
    r#"
    SELECT * FROM execution_history
    WHERE problem_name = ? AND status = ?
    ORDER BY started_at DESC
    LIMIT 1
    "#,
    problem_name,
    status
)
.fetch_optional(&pool)
.await?;
```

### 2. トランザクション管理
```rust
// トランザクションヘルパー
async fn with_transaction<F, R>(&self, f: F) -> Result<R>
where
    F: FnOnce(&mut Transaction<'_, Sqlite>) -> BoxFuture<'_, Result<R>>,
{
    let mut tx = self.pool.begin().await?;
    let result = f(&mut tx).await?;
    tx.commit().await?;
    Ok(result)
}
```

### 3. キャッシュ層
```rust
// インメモリキャッシュ
struct CachedRepository<T> {
    inner: Box<dyn Repository<T>>,
    cache: Arc<RwLock<LruCache<String, T>>>,
}
```

## データスキーマ

### 基本テーブル
1. **execution_history**: 実行履歴
2. **contests**: コンテスト情報
3. **problems**: 問題情報
4. **configurations**: 設定値
5. **docker_containers**: コンテナ追跡

### インデックス戦略
- 頻繁に検索されるカラムにインデックス
- 複合インデックスの活用
- カバリングインデックスの検討

## 期待される効果
1. 実行履歴の永続的な記録
2. 統計情報の蓄積と分析
3. 設定の永続化と共有
4. デバッグ情報の保存

## 実装優先度
**中**: 基本機能は動作するが、長期的な利用には必要な機能のため