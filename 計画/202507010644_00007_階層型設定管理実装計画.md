# 階層型設定管理実装計画

## 概要
分散している設定管理を統一し、階層型の設定管理システムを実装する。

## 背景と現状
- 設定管理が複数ファイルに分散している
- デフォルト値がコード内に散在
- エラーハンドリングが不統一
- CLAUDE.mdルールに違反している箇所が多数

## 目標
1. 統一された設定管理サービスの実装
2. 階層型設定の実現（グローバル→プロジェクト→問題別）
3. 型安全な設定アクセス
4. 動的な設定更新機能

## 実施内容

### Phase 1: 現状分析と設計（1週間）
- 既存設定ファイルの棚卸し
- 設定項目の分類と階層化
- インターフェース設計

### Phase 2: 基盤実装（2週間）
- ConfigurationServiceの実装
- ConfigSchemaRegistryの実装
- 設定検証機能の実装

### Phase 3: 移行作業（2週間）
- 既存設定の統合
- デフォルト値の外部化
- コード内のハードコーディング除去

### Phase 4: 高度な機能（1週間）
- ファイル監視と動的リロード
- 設定の暗号化対応
- 設定履歴管理

## 技術仕様

### 設定階層
```
global_config.json
├── project_config.json
│   └── problem_config.json
└── user_config.json (override)
```

### 設定スキーマ定義
```rust
#[derive(Debug, Deserialize, Schema)]
pub struct GlobalConfig {
    #[schema(min = 1, max = 3600)]
    pub timeout_seconds: u32,
    
    #[schema(min = 1, max = 4096)]
    pub memory_limit_mb: u32,
    
    #[schema(pattern = "^[a-z0-9-]+$")]
    pub default_language: String,
}
```

### 設定アクセスAPI
```rust
// 型安全なアクセス
let timeout = config.get::<u32>("execution.timeout")?;

// セクション単位の取得
let docker_config = config.get_section::<DockerConfig>("docker")?;

// 動的更新
config.update("execution.timeout", 10)?;
```

## 移行計画

### 統合対象ファイル
- infrastructure_defaults.json
- docker_config.json
- execution_limits.json
- 各種defaults.json

### 除去対象
- コード内のデフォルト値
- フォールバック処理
- .get()によるデフォルト値設定

## 期待される成果
- 設定管理の一元化
- 設定変更の追跡可能性
- エラーの早期発見
- 開発効率の向上

## リスクと対策
- **リスク**: 既存システムへの影響
- **対策**: 互換性レイヤーの提供、段階的移行

## 成功指標
- 設定関連のCLAUDE.md違反: ゼロ
- 設定読み込み時間: 100ms以内
- 設定エラー率: 0.1%以下
- コード内デフォルト値: 完全除去