# 設定管理システム計画

## 概要
old_srcの純粋関数的な設定管理システムをRustに移植し、副作用の分離と型安全な設定管理を実現する。

## 現状分析
### old_srcの実装
- `config/`配下で階層的な設定管理
- PureConfigManagerによる副作用のない設定解決
- ConfigResolverによる環境変数とファイルの統合
- ランタイム設定のオーバーレイ機能

### 現在のRustプロジェクト
- 基本的な設定構造体は存在
- 設定の読み込みは単純なファイル読み込みのみ
- 環境変数やオーバーレイ機能なし

## 実装方針
### 1. 設定構造の定義
```rust
// src/domain/config/
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SystemConfig {
    pub execution: ExecutionConfig,
    pub output: OutputConfig,
    pub docker: DockerConfig,
    pub persistence: PersistenceConfig,
}

#[derive(Debug, Clone)]
pub struct ConfigNode {
    value: ConfigValue,
    source: ConfigSource,
    precedence: u8,
}
```

### 2. 純粋な設定解決器
```rust
// src/domain/config/resolver.rs
pub struct PureConfigResolver {
    nodes: HashMap<String, Vec<ConfigNode>>,
}

impl PureConfigResolver {
    pub fn resolve(&self) -> Result<SystemConfig> {
        // 優先順位に基づいて設定を解決（副作用なし）
    }
    
    pub fn overlay(&mut self, overlay: ConfigOverlay) {
        // ランタイム設定のオーバーレイ
    }
}
```

### 3. 設定ローダー（副作用あり）
```rust
// src/infrastructure/providers/config_loader.rs
pub struct SystemConfigLoader {
    file_system: Arc<dyn FileSystem>,
    env_provider: Arc<dyn EnvProvider>,
}

impl ConfigLoader for SystemConfigLoader {
    async fn load(&self) -> Result<Vec<ConfigNode>> {
        // ファイル、環境変数、デフォルト値を読み込み
    }
}
```

## 主要な機能
### 1. 設定ソースの優先順位
1. コマンドライン引数
2. 環境変数
3. ユーザー設定ファイル
4. システム設定ファイル
5. デフォルト値

### 2. 型安全な設定アクセス
- 強い型付けによる設定値の安全性
- Option<T>による任意設定の表現
- バリデーション機能

### 3. 設定のマージと継承
- 階層的な設定の継承
- 部分的なオーバーライド
- 配列とオブジェクトのマージ戦略

## 使用するクレート
- `serde`: シリアライズ/デシリアライズ
- `toml`/`yaml`: 設定ファイル形式
- `config`: 設定管理ユーティリティ（オプション）

## 実装ステップ
1. 設定構造体の定義とスキーマ
2. ConfigNodeとConfigValueの実装
3. PureConfigResolverの実装
4. 設定ローダーの実装
5. 環境変数とファイルの統合
6. バリデーションとエラーハンドリング

## 考慮事項
- 設定の後方互換性
- 設定ファイルのマイグレーション
- 秘密情報の管理（環境変数経由）
- 設定のホットリロード（将来的な拡張）