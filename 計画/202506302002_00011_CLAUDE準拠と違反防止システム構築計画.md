# CLAUDE準拠と違反防止システム構築計画

## 概要
CLAUDE.md準拠を徹底し、Pythonコードベースで確認された97箇所以上の違反を未然に防ぐシステムを構築する。

## 現状分析
Pythonコードベースでの主要違反:
- Infrastructure層以外での副作用: 36箇所以上
- デフォルト引数の使用: 27ファイル、75箇所以上
- フォールバック処理: 8箇所以上
- テスト不備: 21ファイル

## 目標
- **違反の事前防止**: コンパイル時・CI時での検出
- **開発者支援**: IDE統合による即時フィードバック
- **継続的監視**: 品質メトリクスの自動収集

## 実装方針

### 1. Rustの型システムを活用した違反防止
```rust
// デフォルト引数の禁止（Rustでは構造体でのみ可能）
pub struct Config {
    // Defaultトレイトを実装しない
    pub value: String, // 必須フィールド
}

// 副作用の型レベル分離
pub struct SideEffect<T>(T);

// Infrastructure層でのみSideEffect型を使用可能に
```

### 2. カスタムリンタールールの実装
```rust
// clippy.tomlでの設定
disallowed-methods = [
    "std::fs::*",           // Infrastructure層以外で禁止
    "std::process::*",      // Infrastructure層以外で禁止
    "tokio::fs::*",         // Infrastructure層以外で禁止
]
```

### 3. ビルドスクリプトでの検証
```rust
// build.rs
fn main() {
    // レイヤー違反チェック
    check_layer_dependencies();
    // CLAUDE.md準拠チェック
    check_claude_compliance();
}
```

## 実施計画

### Phase 1: 検出システムの構築（2週間）
- [ ] カスタムリンタールールの作成
- [ ] ビルドスクリプトでの検証実装
- [ ] CI/CDパイプラインへの統合

### Phase 2: 開発者支援ツール（2週間）
- [ ] VSCode拡張機能の開発
- [ ] エラーメッセージの改善
- [ ] 修正提案機能の実装

### Phase 3: 監視システムの構築（1週間）
- [ ] 品質メトリクス収集の自動化
- [ ] ダッシュボードの作成
- [ ] アラート機能の実装

## 成功指標
- 新規違反発生: 0件/月
- 違反検出率: 100%
- 開発者満足度: 80%以上

## 具体的な実装例

### 副作用の分離
```rust
// Domain層（純粋関数のみ）
pub fn calculate_score(data: &Data) -> Score {
    // 副作用なしの計算ロジック
}

// Infrastructure層（副作用を含む）
pub struct FileSystem {
    // 実際のファイル操作
}

impl FileSystem {
    pub fn read_file(&self, path: &Path) -> Result<String> {
        // ファイル読み込みの実装
    }
}
```

### エラーハンドリング
```rust
// フォールバックの禁止
// NG: unwrap_or_default()の使用
// let value = config.get("key").unwrap_or_default();

// OK: 明示的なエラーハンドリング
let value = config.get("key")
    .ok_or(ConfigError::KeyNotFound("key"))?;
```

## 教育・啓発活動
- CLAUDE.md勉強会の定期開催
- ペアプログラミングでの知識共有
- ベストプラクティスドキュメントの作成

## 継続的改善
- 月次での違反分析レポート
- 四半期でのルール見直し
- 年次でのCLAUDE.md更新