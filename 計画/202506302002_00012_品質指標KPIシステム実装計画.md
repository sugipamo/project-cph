# 品質指標KPIシステム実装計画

## 概要
src_checkをベースとしたKPIシステムをRustで実装し、コード品質の可視化と継続的改善を実現する。

## 目標
- **スコアリング**: 50点基準の加点減点方式（0-100点）
- **目標範囲**: 30-80点を維持
- **自動化**: CI/CDでの自動計測と監視

## KPI指標設計

### 1. コード品質（基準点: 50点）
| 項目 | 減点/加点 | 説明 |
|------|-----------|------|
| 不適切なunwrap使用 | -5点/件 | エラーハンドリング不備 |
| 過度なclone使用 | -3点/件 | パフォーマンス問題 |
| 未使用のコード | -2点/件 | デッドコード |
| 適切なResult使用 | +2点/件 | エラーハンドリング |

### 2. アーキテクチャ品質（基準点: 50点）
| 項目 | 減点/加点 | 説明 |
|------|-----------|------|
| 循環依存 | -10点/件 | モジュール間の循環参照 |
| レイヤー違反 | -5点/件 | 依存方向の違反 |
| 過度な公開API | -2点/件 | 不必要なpub宣言 |
| 適切なトレイト使用 | +3点/件 | 抽象化の実現 |

### 3. テスト品質（基準点: 50点）
| 項目 | 減点/加点 | 説明 |
|------|-----------|------|
| テストカバレッジ不足 | -1点/5%不足 | 80%を基準 |
| 統合テスト不足 | -3点/モジュール | 重要モジュールのテスト |
| プロパティベーステスト | +5点/件 | 高度なテスト手法 |

## 実装設計

### 1. コアシステム
```rust
pub struct KpiSystem {
    metrics: Vec<Box<dyn Metric>>,
    database: Database,
}

pub trait Metric {
    fn calculate(&self, codebase: &Codebase) -> Score;
    fn get_violations(&self) -> Vec<Violation>;
}
```

### 2. AST解析
```rust
use syn::{File, Item, visit::Visit};

pub struct CodeAnalyzer {
    violations: Vec<Violation>,
}

impl Visit<'_> for CodeAnalyzer {
    fn visit_expr(&mut self, expr: &Expr) {
        // unwrap検出、clone検出など
    }
}
```

### 3. データ永続化
```sql
CREATE TABLE kpi_history (
    id INTEGER PRIMARY KEY,
    timestamp DATETIME,
    total_score REAL,
    code_quality_score REAL,
    architecture_score REAL,
    test_quality_score REAL
);

CREATE TABLE violations (
    id INTEGER PRIMARY KEY,
    file_path TEXT,
    line_number INTEGER,
    violation_type TEXT,
    severity TEXT,
    score_impact INTEGER
);
```

## 実施計画

### Phase 1: 基本システム構築（2週間）
- [ ] スコアリングエンジンの実装
- [ ] 基本的な違反検出機能
- [ ] データベース設計と実装

### Phase 2: 高度な解析機能（3週間）
- [ ] AST解析の実装
- [ ] 依存関係グラフの構築
- [ ] テストカバレッジ統合

### Phase 3: 可視化と自動化（2週間）
- [ ] Webダッシュボードの実装
- [ ] CI/CD統合
- [ ] アラート機能

### Phase 4: AIエージェント統合（2週間）
- [ ] ビームサーチ戦略の実装
- [ ] 自動改善提案システム
- [ ] worktree統合

## 出力形式

### JSON形式
```json
{
  "timestamp": "2024-06-30T12:00:00Z",
  "total_score": 65.5,
  "scores": {
    "code_quality": 68.0,
    "architecture_quality": 62.5,
    "test_quality": 66.0
  },
  "violations": [
    {
      "file": "src/main.rs",
      "line": 42,
      "type": "unwrap_usage",
      "severity": "high",
      "impact": -5
    }
  ]
}
```

### Markdownレポート
```markdown
# KPI Report - 2024-06-30

## サマリー
- **総合スコア**: 65.5/100 (Normal)
- **トレンド**: 改善傾向 ↑
- **重要課題**: 3件のクリティカル違反

## 詳細分析
[各指標の詳細]

## 改善提案
1. unwrap使用箇所のResult化
2. テストカバレッジの向上
3. レイヤー依存の整理
```

## 成功指標
- プロジェクト全体のKPIスコア: 30-80点で安定
- 月次改善率: 5%以上
- 違反の再発率: 50%削減

## 長期展望
- リアルタイムコード品質フィードバック
- 機械学習による改善提案
- チーム間での品質競争システム