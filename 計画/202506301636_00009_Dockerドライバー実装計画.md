# Dockerドライバー実装計画

## 概要
old_srcのinfrastructure/drivers/docker/に実装されているDockerドライバーをRustに移植する計画。

## 背景と目的
- **現状**: 現在のRustプロジェクトにはDocker操作機能が未実装
- **old_srcの実装**: Dockerコンテナの作成、実行、追跡機能を提供
- **目的**: 競技プログラミング環境の隔離実行とテスト環境の統一

## 実装すべき機能

### 1. コンテナライフサイクル管理
- コンテナの作成、起動、停止、削除
- イメージのビルド、プル、削除
- ボリュームとネットワークの管理

### 2. 実行環境の隔離
- 言語別の実行環境の提供
- リソース制限（CPU、メモリ、時間）
- セキュアな実行環境

### 3. ファイルシステムの連携
- ホストとコンテナ間のファイル転送
- バインドマウントの管理
- 作業ディレクトリの同期

### 4. 実行結果の収集
- 標準出力/エラー出力の取得
- 終了コードの取得
- 実行時間の計測

## 実装方針

### ディレクトリ構造
```
src/infrastructure/drivers/docker/
├── mod.rs
├── client.rs         # Docker APIクライアント
├── container.rs      # コンテナ管理
├── image.rs         # イメージ管理
├── executor.rs      # 実行管理
└── types.rs         # 型定義
```

### 主要な型定義
```rust
// Dockerドライバーのトレイト
#[async_trait]
trait DockerDriver {
    async fn create_container(&self, config: ContainerConfig) -> Result<ContainerId>;
    async fn start_container(&self, id: &ContainerId) -> Result<()>;
    async fn exec_in_container(&self, id: &ContainerId, cmd: &str) -> Result<ExecResult>;
    async fn copy_to_container(&self, id: &ContainerId, src: &Path, dst: &str) -> Result<()>;
}

// コンテナ設定
struct ContainerConfig {
    image: String,
    command: Vec<String>,
    environment: HashMap<String, String>,
    mounts: Vec<Mount>,
    resource_limits: ResourceLimits,
}

// 実行結果
struct ExecResult {
    stdout: String,
    stderr: String,
    exit_code: i32,
    duration: Duration,
}
```

## 技術選定
- **bollard**: Docker APIのRustクライアント
- **tokio**: 非同期ランタイム
- **bytes**: バイナリデータの処理
- **tar**: アーカイブの作成/展開

## 実装の優先順位

### フェーズ1: 基本機能
1. コンテナの作成と実行
2. 標準的な言語イメージのサポート（C++, Python, Rust）
3. 基本的なファイル転送

### フェーズ2: 高度な機能
1. カスタムDockerfileのサポート
2. マルチステージビルド
3. キャッシュ管理
4. 並列実行のサポート

## セキュリティ考慮事項
1. **リソース制限**
   - CPU使用率の制限
   - メモリ使用量の制限
   - 実行時間の制限

2. **ネットワーク隔離**
   - 外部ネットワークへのアクセス制限
   - コンテナ間の通信制限

3. **ファイルシステムの保護**
   - 読み取り専用マウント
   - 一時ファイルの自動削除

## 期待される効果
1. 環境依存の問題の解消
2. 安全な実行環境の提供
3. 複数言語の統一的な実行管理
4. 再現可能なテスト環境

## 実装優先度
**中**: 重要な機能だが、初期段階ではローカル実行でも対応可能なため