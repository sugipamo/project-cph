# src_check → KPI システム移行計画 - インテグレーター視点

## 1. 統合戦略概要

### 1.1 基本方針
- **完全な後方互換性の維持**: 既存のsrc_checkユーザーに影響を与えない
- **段階的移行**: リスクを最小化する漸進的アプローチ
- **並列実行期間**: 新旧システムの同時稼働による検証期間の確保

### 1.2 移行アプローチ
```
Phase 1: Adapter Layer （既存システムを変更せずに拡張）
Phase 2: Parallel Mode （新旧システムの並列実行）
Phase 3: Migration Mode （段階的な機能移行）
Phase 4: Legacy Mode （旧システムの段階的縮退）
```

## 2. 互換性レイヤー設計

### 2.1 既存インターフェース保護
```python
# src_check/compatibility/legacy_wrapper.py
class LegacyCompatibilityWrapper:
    """既存のCLI/API呼び出しを新システムに透過的に転送"""
    
    def __init__(self):
        self.use_kpi = self._detect_kpi_mode()
        self.legacy_executor = CheckExecutor()
        self.kpi_executor = KPICheckExecutor()
    
    def execute(self, args):
        if self.use_kpi:
            # KPIモードで実行し、結果を旧形式に変換
            kpi_results = self.kpi_executor.execute(args)
            return self._convert_to_legacy_format(kpi_results)
        else:
            # 従来通りの実行
            return self.legacy_executor.execute(args)
```

### 2.2 データモデル変換
```python
# src_check/compatibility/converters.py
class ResultConverter:
    """CheckResult ⇔ KPIScore 相互変換"""
    
    @staticmethod
    def check_result_to_kpi_score(result: CheckResult) -> KPIScore:
        """既存の結果をKPIスコアに変換"""
        severity_map = {
            LogLevel.ERROR: -10,
            LogLevel.WARNING: -5,
            LogLevel.INFO: 0
        }
        
        return KPIScore(
            category=_categorize_result(result),
            impact=severity_map.get(result.log_level, 0),
            details=result.to_dict()
        )
    
    @staticmethod
    def kpi_score_to_check_result(score: KPIScore) -> CheckResult:
        """KPIスコアを既存形式に変換"""
        # 逆変換ロジック
        pass
```

## 3. 段階的移行計画

### 3.1 Phase 1: 透過的アダプター実装（週1）
```bash
# 既存コマンド（変更なし）
python -m src_check

# 内部的にKPIシステムを使用（ユーザーには見えない）
python -m src_check --experimental-kpi-backend
```

**実装タスク**:
- [ ] 互換性レイヤーの基本実装
- [ ] 結果フォーマット変換器
- [ ] 既存テストケースの通過確認
- [ ] パフォーマンス比較ベンチマーク

### 3.2 Phase 2: 並列実行モード（週2）
```python
# src_check/parallel_executor.py
class ParallelModeExecutor:
    """新旧システムを並列実行して結果を比較"""
    
    def execute_and_compare(self):
        legacy_results = self.legacy_system.execute()
        kpi_results = self.kpi_system.execute()
        
        # 結果の一致性検証
        discrepancies = self.compare_results(legacy_results, kpi_results)
        
        if discrepancies:
            self.log_discrepancies(discrepancies)
            # デフォルトは旧システムの結果を採用
            return legacy_results
        
        return kpi_results
```

**検証項目**:
- [ ] 結果の一致性（95%以上）
- [ ] パフォーマンス劣化なし
- [ ] メモリ使用量の許容範囲内
- [ ] エラーハンドリングの一貫性

### 3.3 Phase 3: 機能別移行（週3）
```yaml
# migration_config.yaml
migration_phases:
  week3_day1:
    - naming_checker: kpi
    - syntax_checker: kpi
  week3_day3:
    - import_checker: kpi
    - circular_import_checker: kpi
  week3_day5:
    - all_architecture_checkers: kpi
  week3_day7:
    - all_remaining_checkers: kpi
```

**移行スクリプト**:
```python
# tools/migration_manager.py
class MigrationManager:
    def migrate_checker(self, checker_name: str):
        # 1. 設定を更新
        self.update_config(checker_name, use_kpi=True)
        
        # 2. 並列実行で検証
        self.verify_parallel_execution(checker_name)
        
        # 3. 切り替え実行
        self.switch_to_kpi(checker_name)
        
        # 4. ロールバック準備
        self.prepare_rollback(checker_name)
```

### 3.4 Phase 4: レガシーモード（週4）
```python
# src_check/main.py
def main():
    if args.legacy_mode:
        warnings.warn(
            "Legacy mode is deprecated and will be removed in v3.0. "
            "Please migrate to KPI mode.",
            DeprecationWarning
        )
        return legacy_main(args)
    
    return kpi_main(args)
```

## 4. データ移行戦略

### 4.1 履歴データの移行
```python
# tools/history_migrator.py
class HistoryMigrator:
    def migrate_text_results_to_db(self):
        """既存のテキスト結果をデータベースに移行"""
        for result_file in glob("check_result/*.txt"):
            # 1. テキストファイルをパース
            legacy_data = self.parse_legacy_result(result_file)
            
            # 2. KPIスコアに変換
            kpi_score = self.convert_to_kpi(legacy_data)
            
            # 3. データベースに保存
            self.db.save_historical_score(kpi_score)
```

### 4.2 設定ファイルの移行
```python
# 既存の設定（.src_check.json）
{
    "ignore_patterns": ["test_*"],
    "max_line_length": 120
}

# 新しい設定（.src_check.yaml）との共存
kpi:
  enabled: true
  scoring:
    base_score: 50
    weights:
      code_quality: 0.333
legacy:
  # 既存設定をそのまま保持
  ignore_patterns: ["test_*"]
  max_line_length: 120
```

## 5. ロールバック計画

### 5.1 即時ロールバック
```bash
# 環境変数による切り替え
export SRC_CHECK_USE_LEGACY=true
python -m src_check
```

### 5.2 部分的ロールバック
```python
# 特定のチェッカーのみレガシーモードに戻す
python -m src_check --legacy-checkers=import_checker,naming_checker
```

### 5.3 データ復旧
```python
# tools/rollback_manager.py
class RollbackManager:
    def restore_legacy_state(self, backup_date):
        # 1. データベースのバックアップから復元
        self.restore_db_backup(backup_date)
        
        # 2. 設定ファイルを旧バージョンに戻す
        self.restore_config_backup(backup_date)
        
        # 3. キャッシュをクリア
        self.clear_all_caches()
```

## 6. テスト戦略

### 6.1 回帰テスト
```python
# tests/compatibility/test_regression.py
class RegressionTests:
    def test_all_legacy_commands_work(self):
        """全ての既存コマンドが動作することを確認"""
        legacy_commands = [
            "python -m src_check",
            "python -m src_check --fix",
            "python -m src_check specific_file.py"
        ]
        
        for cmd in legacy_commands:
            result = run_command(cmd)
            assert result.returncode == 0
```

### 6.2 A/Bテスト
```python
# tests/compatibility/test_ab_comparison.py
def test_results_consistency():
    """新旧システムの結果一致性をテスト"""
    test_projects = load_test_projects()
    
    for project in test_projects:
        legacy_results = run_legacy_check(project)
        kpi_results = run_kpi_check(project)
        
        # 許容範囲内での一致を確認
        assert_results_equivalent(legacy_results, kpi_results, tolerance=0.05)
```

## 7. 監視とアラート

### 7.1 移行メトリクス
```python
# monitoring/migration_metrics.py
MIGRATION_METRICS = {
    "compatibility_score": "新旧システムの結果一致率",
    "performance_ratio": "新旧システムの実行時間比",
    "error_rate": "エラー発生率の差分",
    "memory_usage_delta": "メモリ使用量の増減"
}
```

### 7.2 アラート設定
```yaml
alerts:
  - name: compatibility_degradation
    condition: compatibility_score < 0.95
    action: notify_team
  
  - name: performance_regression
    condition: performance_ratio > 1.2
    action: rollback_checker
```

## 8. ドキュメント更新計画

### 8.1 移行ガイド
- ユーザー向け移行ガイドの作成
- API変更点の詳細ドキュメント
- トラブルシューティングガイド

### 8.2 内部ドキュメント
- アーキテクチャ変更の記録
- 意思決定ログ
- 将来の拡張計画