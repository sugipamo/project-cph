# アダプターパターン実装計画

## 背景
old_srcにはアダプターパターン（adapters/）を使用した外部システムとの統合実装がある。このパターンにより、アプリケーション層と外部依存の分離が実現されている。現在のRustプロジェクトでも同様の分離が必要。

## 目的
- ロギングシステムの抽象化
- 時刻操作の抽象化
- 外部システムとの疎結合な統合
- テスタビリティの向上

## 現状分析

### old_srcのアダプター実装
- `ApplicationLoggerAdapter`: アプリケーションログの抽象化
- `TimeAdapter`: システム時刻の抽象化
- `WorkflowLoggerAdapter`: ワークフロー専用ログ

### 現在のプロジェクトの課題
- ロギングが直接実装に依存
- 時刻のモック化が困難
- テスト時の外部依存の制御が難しい

## 実装方針

### 1. ロガーアダプター
```rust
// src/infrastructure/adapters/logger.rs
pub trait LoggerAdapter: Send + Sync {
    fn log(&self, level: LogLevel, message: &str);
    fn log_with_context(&self, level: LogLevel, message: &str, context: &Context);
}

pub struct DefaultLoggerAdapter {
    inner: Arc<dyn Logger>,
}

pub struct TestLoggerAdapter {
    logs: Arc<Mutex<Vec<LogEntry>>>,
}
```

### 2. 時刻アダプター
```rust
// src/infrastructure/adapters/time.rs
pub trait TimeAdapter: Send + Sync {
    fn now(&self) -> DateTime<Utc>;
    fn elapsed(&self, from: DateTime<Utc>) -> Duration;
}

pub struct SystemTimeAdapter;
pub struct MockTimeAdapter {
    current_time: Arc<Mutex<DateTime<Utc>>>,
}
```

### 3. ファイルシステムアダプター
- 既存のFileSystemトレイトを拡張
- より高度な操作の抽象化
- トランザクション的な操作のサポート

### 4. 外部コマンドアダプター
- シェルコマンドの実行抽象化
- 標準入出力の制御
- タイムアウト処理の統一

## 技術的課題
- トレイトオブジェクトのパフォーマンス
- 非同期トレイトの扱い
- 依存性注入の実装

## 実装優先度
高：テスタビリティとメンテナビリティの基盤

## 必要なリソース
- mockall crate（モック生成）
- async-trait crate（非同期トレイト）

## 成功指標
- 全ての外部依存がモック可能
- テストの実行速度向上
- 新しいアダプターの追加が容易