# 永続化層実装計画

## 概要
old_srcのSQLiteベースの永続化機能を現在のRustプロジェクトに統合し、セッション管理、実行履歴、設定の永続化を実現する。

## 背景と目的
### old_srcの分析結果
- `infrastructure/persistence/sqlite/`: SQLite実装
  - マイグレーション機能
  - セッション管理
  - 実行履歴の記録
  - 設定の永続化
- `repositories/`: リポジトリパターンによるデータアクセス抽象化
  - 基底リポジトリインターフェース
  - 各エンティティ専用リポジトリ

### 現在のプロジェクトの状況
- `src/infrastructure/persistence/`: ディレクトリは存在するが実装なし
- データの永続化機能が完全に欠如

## 実装方針

### 1. SQLite基盤の構築
```rust
// src/infrastructure/persistence/sqlite/connection.rs
- SQLite接続管理
- コネクションプール実装
- トランザクション管理
```

### 2. マイグレーションシステム
```rust
// src/infrastructure/persistence/migrations/
- スキーマバージョン管理
- 自動マイグレーション実行
- ロールバック機能
```

### 3. エンティティとリポジトリ実装
```rust
// src/domain/repositories/
- BaseRepository trait定義
- SessionRepository
- ExecutionHistoryRepository
- ConfigurationRepository
- ContestRepository
```

### 4. 永続化対象データ
- **セッション情報**: 実行コンテキスト、開始/終了時刻
- **実行履歴**: コマンド実行結果、成功/失敗、実行時間
- **設定データ**: ユーザー設定、システム設定のキャッシュ
- **コンテスト情報**: 問題情報、テストケース、提出結果

### 5. スキーマ設計
```sql
-- セッションテーブル
CREATE TABLE sessions (
    id TEXT PRIMARY KEY,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    status TEXT,
    context JSON
);

-- 実行履歴テーブル
CREATE TABLE execution_history (
    id TEXT PRIMARY KEY,
    session_id TEXT,
    command TEXT,
    result JSON,
    executed_at TIMESTAMP,
    duration_ms INTEGER,
    FOREIGN KEY (session_id) REFERENCES sessions(id)
);

-- 設定テーブル
CREATE TABLE configurations (
    key TEXT PRIMARY KEY,
    value JSON,
    updated_at TIMESTAMP
);
```

## 実装優先順位
1. SQLite接続管理とマイグレーション基盤
2. セッション管理機能
3. 実行履歴記録機能
4. 設定永続化機能
5. クエリ最適化とインデックス設計

## 技術的考慮事項
- sqlx crateを使用した型安全なSQL操作
- 非同期処理対応（tokio-sqlite）
- トランザクション分離レベルの適切な設定
- データベースファイルの配置場所（XDG Base Directory準拠）

## 期待される効果
- 実行履歴の保持による問題解決履歴の追跡
- セッション管理による作業継続性の向上
- 設定の永続化によるユーザビリティ向上
- 統計情報の収集と分析基盤

## 参考実装
old_srcのSQLite実装は以下の特徴を持つ:
- 自動マイグレーション機能
- JSONフィールドによる柔軟なデータ構造
- リポジトリパターンによる抽象化
- トランザクション管理

これらの機能をRustの型システムを活用してより安全に再実装する。