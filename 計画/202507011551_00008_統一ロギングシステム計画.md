# 統一ロギングシステム計画

## 概要
old_srcの統一ロギングシステムとカラー管理機能をRustに移植し、アプリケーションとワークフローの両方のロギングニーズに対応する。

## 現状分析
### old_srcの実装
- ApplicationLoggerAdapterとWorkflowLoggerAdapterの分離
- ColorManagerによる出力の色付け
- OutputManagerによる出力先の抽象化
- モック可能な設計でテスト容易性を確保

### 現在のRustプロジェクト
- 基本的なLoggerトレイトのみ定義
- 実装は最小限
- 構造化ログやカラー出力なし

## 実装方針
### 1. ロガートレイトの拡張
```rust
// src/interfaces/logger.rs
pub trait Logger: Send + Sync {
    fn log(&self, level: LogLevel, message: &str);
    fn log_structured(&self, level: LogLevel, message: &str, fields: &HashMap<String, Value>);
    fn child(&self, name: &str) -> Box<dyn Logger>;
}

pub trait OutputManager: Send + Sync {
    fn write(&self, output: Output);
    fn write_error(&self, output: Output);
    fn supports_color(&self) -> bool;
}
```

### 2. 統一ロガー実装
```rust
// src/infrastructure/drivers/logger/unified_logger.rs
pub struct UnifiedLogger {
    output_manager: Arc<dyn OutputManager>,
    color_manager: ColorManager,
    context: LogContext,
}

impl UnifiedLogger {
    pub fn application_logger(&self) -> ApplicationLogger {
        ApplicationLogger::new(self.clone())
    }
    
    pub fn workflow_logger(&self) -> WorkflowLogger {
        WorkflowLogger::new(self.clone())
    }
}
```

### 3. カラー管理
```rust
// src/infrastructure/drivers/logger/color_manager.rs
pub struct ColorManager {
    enabled: bool,
    theme: ColorTheme,
}

impl ColorManager {
    pub fn colorize(&self, text: &str, color: Color) -> String {
        if self.enabled {
            // ANSIエスケープシーケンスで色付け
        } else {
            text.to_string()
        }
    }
}
```

## 主要な機能
### 1. ログレベル管理
- TRACE, DEBUG, INFO, WARN, ERROR
- 環境変数によるレベル制御
- モジュール別のフィルタリング

### 2. 構造化ログ
- JSON形式での出力オプション
- メタデータの付加
- トレーシングとの統合

### 3. 出力フォーマット
- 人間が読みやすい形式
- 機械処理可能な形式（JSON）
- タイムスタンプとコンテキスト情報

### 4. パフォーマンス考慮
- 非同期ログ出力
- バッファリング
- 条件付きログ評価

## 使用するクレート
- `tracing`: 構造化ログとトレーシング
- `tracing-subscriber`: ログ出力の設定
- `colored`/`termcolor`: ターミナルカラー
- `serde_json`: JSON形式の出力

## 実装ステップ
1. 基本的なロガートレイトとOutputManagerの実装
2. UnifiedLoggerの基本実装
3. ColorManagerとテーマ設定
4. ApplicationLoggerとWorkflowLoggerの特化実装
5. tracingクレートとの統合
6. テスト用モックロガーの実装

## 考慮事項
- Windows/Unix のカラー出力の違い
- ログローテーション（ファイル出力時）
- パフォーマンスへの影響最小化
- CI環境での適切な動作（カラー無効化等）