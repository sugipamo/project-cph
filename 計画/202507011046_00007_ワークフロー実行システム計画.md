# ワークフロー実行システム計画

## 概要
old_srcのワークフロー/ステップ実行システムを現在のRustプロジェクトに統合し、複雑な処理の段階的実行と依存関係管理を実現する。

## 背景と目的
### old_srcの分析結果
- `workflow/`: ワークフロー実行エンジン
  - ステップ定義と依存関係管理
  - ワークフローランナー
  - 実行結果の集約
- `operations/`: 各種操作の定義
  - Shell、File、Docker、Python操作
  - Composite操作（複数操作の組み合わせ）
  - Request/Result パターン
- `services/workflow_execution_service.py`: ワークフロー実行サービス

### 現在のプロジェクトの状況
- 基本的なコマンド実行機能のみ
- ステップ実行や依存関係管理機能なし
- 複雑な処理フローの構築が困難

## 実装方針

### 1. ワークフロー基本構造
```rust
// src/domain/workflow/
pub trait Step {
    type Input;
    type Output;
    type Error;
    
    async fn execute(&self, input: Self::Input) -> Result<Self::Output, Self::Error>;
    fn dependencies(&self) -> Vec<StepId>;
}

pub struct Workflow {
    steps: HashMap<StepId, Box<dyn Step>>,
    execution_order: Vec<StepId>,
}
```

### 2. 操作（Operation）定義
```rust
// src/domain/operations/
pub enum Operation {
    Shell(ShellOperation),
    File(FileOperation),
    Docker(DockerOperation),
    Composite(Vec<Operation>),
}

pub struct OperationRequest<T> {
    operation: T,
    context: ExecutionContext,
}

pub struct OperationResult<T> {
    output: T,
    duration: Duration,
    metadata: HashMap<String, Value>,
}
```

### 3. ワークフロー実行エンジン
```rust
// src/application/services/workflow_service.rs
pub struct WorkflowExecutor {
    step_runner: StepRunner,
    dependency_resolver: DependencyResolver,
    result_aggregator: ResultAggregator,
}

impl WorkflowExecutor {
    pub async fn execute(&self, workflow: Workflow) -> WorkflowResult {
        // 依存関係解決
        // 並列実行可能なステップの識別
        // 実行とエラーハンドリング
        // 結果の集約
    }
}
```

### 4. ステップ種別
- **準備ステップ**: 環境セットアップ、ファイル準備
- **実行ステップ**: プログラム実行、テスト実行
- **検証ステップ**: 出力検証、正解との比較
- **後処理ステップ**: クリーンアップ、結果保存

### 5. 依存関係管理
```rust
// src/domain/workflow/dependency.rs
pub struct DependencyGraph {
    edges: HashMap<StepId, Vec<StepId>>,
}

impl DependencyGraph {
    pub fn topological_sort(&self) -> Result<Vec<StepId>, CycleError>;
    pub fn parallel_groups(&self) -> Vec<Vec<StepId>>;
}
```

### 6. 実行コンテキストと状態管理
```rust
// src/domain/workflow/context.rs
pub struct WorkflowContext {
    variables: HashMap<String, Value>,
    step_results: HashMap<StepId, StepResult>,
    global_state: State,
}
```

## 実装優先順位
1. 基本的なStep traitとWorkflow構造
2. 単純な順次実行エンジン
3. 依存関係解決と並列実行
4. エラーハンドリングとリトライ機能
5. 実行結果の永続化連携

## 技術的考慮事項
- async/awaitを活用した非同期実行
- rayon crateによる並列処理
- 型安全な依存関係定義
- 実行時のメモリ効率

## 期待される効果
- 複雑な競技プログラミングタスクの自動化
  - コンパイル→実行→検証の一連の流れ
  - 複数テストケースの並列実行
- 再利用可能なワークフロー定義
- 実行プロセスの可視化と追跡
- エラー時の部分的な再実行

## 使用例
```rust
// 競技プログラミング実行ワークフロー
let workflow = WorkflowBuilder::new()
    .add_step("compile", CompileStep::new("main.cpp"))
    .add_step("test1", ExecuteStep::new("./a.out", "test1.in"))
    .add_step("test2", ExecuteStep::new("./a.out", "test2.in"))
    .add_step("verify1", VerifyStep::new("test1.out", "expected1.out"))
    .add_step("verify2", VerifyStep::new("test2.out", "expected2.out"))
    .add_dependency("test1", "compile")
    .add_dependency("test2", "compile")
    .add_dependency("verify1", "test1")
    .add_dependency("verify2", "test2")
    .build();

let result = workflow_executor.execute(workflow).await?;
```

## 参考実装の特徴
old_srcのワークフロー実装は:
- 柔軟なステップ定義
- DAGベースの依存関係管理
- 実行時コンテキストの共有
- 詳細な実行ログとメトリクス

これらの機能をRustの型システムとパフォーマンスを活かして改良実装する。