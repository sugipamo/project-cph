# 統合ドライバー実装計画

## 背景
old_srcには統合ドライバー（infrastructure/drivers/unified/）という、複数のドライバーを統合して管理する仕組みがある。これにより、複雑な操作を単一のインターフェースで実行できる。

## 目的
- 複数ドライバーの協調動作
- 複雑な操作の簡略化
- トランザクション的な操作の実現
- エラー処理の統一

## 現状分析

### old_srcの統合ドライバー
- `UnifiedDriver`: 複数ドライバーの統合管理
- ファイル、シェル、Docker操作の組み合わせ
- 一貫性のあるエラー処理

### 現在のプロジェクトの課題
- 各ドライバーが独立して動作
- 複雑な操作時のエラー処理が分散
- ロールバック機能なし

## 実装方針

### 1. 統合ドライバーインターフェース
```rust
// src/infrastructure/drivers/unified.rs
pub struct UnifiedDriver {
    file_system: Arc<dyn FileSystem>,
    shell: Arc<dyn Shell>,
    docker: Arc<dyn DockerDriver>,
    logger: Arc<dyn Logger>,
}

impl UnifiedDriver {
    pub async fn execute_test_workflow(&self, config: &TestConfig) -> Result<TestResult> {
        // ファイル準備、Docker実行、結果収集を統合
    }
}
```

### 2. トランザクション管理
- 操作の開始前にスナップショット作成
- エラー時の自動ロールバック
- 部分的な成功の適切な処理

### 3. 操作パイプライン
```rust
pub struct OperationPipeline {
    operations: Vec<Box<dyn Operation>>,
    rollback_stack: Vec<Box<dyn Rollback>>,
}
```

### 4. エラー集約
- 複数のエラーを構造的に管理
- エラーのコンテキスト情報追加
- リカバリー可能なエラーの識別

## 技術的課題
- 非同期操作の順序制御
- メモリ効率的なスナップショット
- デッドロックの回避

## 実装優先度
中：複雑な操作の信頼性向上に寄与

## 必要なリソース
- futures crate（非同期ユーティリティ）
- tempfile crate（一時ファイル管理）

## 成功指標
- 複雑な操作の成功率向上
- エラー時の適切な状態復元
- 操作時間の短縮