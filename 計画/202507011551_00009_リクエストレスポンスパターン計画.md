# リクエスト/レスポンスパターン計画

## 概要
old_srcのリクエスト/レスポンスパターンをRustに移植し、すべての操作を統一的なインターフェースで扱えるようにする。

## 現状分析
### old_srcの実装
- BaseRequestを基底とした階層的なリクエスト構造
- 各種ドライバー用の特化したリクエスト型
- CompositeRequestによる複数操作の組み合わせ
- RequestFactoryによる動的なリクエスト生成

### 現在のRustプロジェクト
- 操作は直接的なメソッド呼び出し
- 統一的な操作抽象化なし
- リトライやタイムアウトの一元管理なし

## 実装方針
### 1. 基本的なリクエスト/レスポンス型
```rust
// src/domain/operations/request.rs
pub trait Request: Send + Sync {
    type Response: Response;
    
    fn operation_type(&self) -> OperationType;
    fn validate(&self) -> Result<()>;
    fn timeout(&self) -> Option<Duration>;
}

pub trait Response: Send + Sync {
    fn is_success(&self) -> bool;
    fn error(&self) -> Option<&Error>;
}
```

### 2. 具体的なリクエスト実装
```rust
// src/domain/operations/shell_request.rs
#[derive(Debug, Clone)]
pub struct ShellRequest {
    pub command: String,
    pub args: Vec<String>,
    pub working_dir: Option<PathBuf>,
    pub env: HashMap<String, String>,
    pub timeout: Option<Duration>,
}

impl Request for ShellRequest {
    type Response = ShellResponse;
    // 実装
}
```

### 3. コンポジットリクエスト
```rust
// src/domain/operations/composite_request.rs
pub struct CompositeRequest {
    requests: Vec<Box<dyn Request>>,
    execution_mode: ExecutionMode,
}

pub enum ExecutionMode {
    Sequential,
    Parallel,
    Pipeline, // 前の出力を次の入力に
}
```

### 4. リクエストファクトリ
```rust
// src/domain/operations/request_factory.rs
pub struct RequestFactory {
    validators: HashMap<OperationType, Box<dyn Validator>>,
}

impl RequestFactory {
    pub fn create_shell_request(&self, config: ShellConfig) -> Result<ShellRequest>;
    pub fn create_file_request(&self, config: FileConfig) -> Result<FileRequest>;
    pub fn create_composite(&self, requests: Vec<Box<dyn Request>>) -> CompositeRequest;
}
```

## 主要な機能
### 1. 操作の種類
- ShellRequest: シェルコマンド実行
- FileRequest: ファイル操作（読み書き、コピー、削除）
- DockerRequest: Dockerコンテナ操作
- HttpRequest: HTTP通信（将来的な拡張）

### 2. 共通機能
- タイムアウト管理
- リトライポリシー
- バリデーション
- メトリクス収集フック

### 3. エラーハンドリング
- 操作固有のエラー型
- エラーの分類（一時的/永続的）
- エラーコンテキストの保持

## 利点
1. **統一的なインターフェース**: すべての操作を同じ方法で扱える
2. **テスタビリティ**: リクエストの記録と再生が容易
3. **拡張性**: 新しい操作タイプの追加が簡単
4. **監視**: すべての操作にフックを挿入可能

## 実装ステップ
1. Request/Responseトレイトの定義
2. 基本的なリクエスト型の実装（Shell, File）
3. レスポンス型とエラー処理
4. CompositeRequestの実装
5. RequestFactoryとバリデーション
6. 既存コードのリファクタリング

## 考慮事項
- トレイトオブジェクトのパフォーマンス影響
- 型消去による実行時エラーの可能性
- シリアライズ可能性（永続化やネットワーク送信用）