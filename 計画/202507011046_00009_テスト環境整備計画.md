# テスト環境整備計画

## 概要
old_srcのモック実装とテスト構造を参考に、現在のRustプロジェクトに包括的なテスト環境を構築し、高品質なコードベースを維持する。

## 背景と目的
### old_srcの分析結果
- `infrastructure/drivers/mock/`: 各種ドライバーのモック実装
  - MockFileDriver、MockShellDriver、MockDockerDriver
- `infrastructure/providers/mock/`: プロバイダーのモック実装
  - OS、ファイルシステム、時刻などのモック
- `tests/`: テスト関連の実装
  - 複合ステップの失敗処理テスト
  - コンテスト機能のテスト
- 依存性注入によるテスタビリティの確保

### 現在のプロジェクトの状況
- 基本的なユニットテストのみ
- モック実装が不足
- 統合テスト環境の未整備
- E2Eテストの仕組みなし

## 実装方針

### 1. モックフレームワークの構築
```rust
// src/test_utils/mocks/mod.rs
use mockall::automock;

#[automock]
pub trait FileDriver: Send + Sync {
    async fn read(&self, path: &Path) -> Result<String, FileError>;
    async fn write(&self, path: &Path, content: &str) -> Result<(), FileError>;
}

#[automock]
pub trait ShellDriver: Send + Sync {
    async fn execute(&self, command: &str) -> Result<CommandOutput, ShellError>;
}

#[automock]
pub trait DockerDriver: Send + Sync {
    async fn run_container(&self, config: ContainerConfig) -> Result<ContainerId, DockerError>;
}
```

### 2. テストフィクスチャ管理
```rust
// src/test_utils/fixtures/mod.rs
pub struct TestFixture {
    temp_dir: TempDir,
    mock_drivers: MockDrivers,
    test_data: TestData,
}

impl TestFixture {
    pub fn new() -> Self {
        // テスト用の一時ディレクトリ作成
        // モックドライバーの初期化
        // テストデータの準備
    }
    
    pub fn with_sample_contest(&mut self) -> &mut Self {
        // サンプルコンテストデータの設定
    }
    
    pub fn with_config(&mut self, config: TestConfig) -> &mut Self {
        // テスト用設定の適用
    }
}
```

### 3. テストケース生成システム
```rust
// src/test_utils/generators/mod.rs
use proptest::prelude::*;

prop_compose! {
    fn arb_contest_input()
        (problem_count in 1..10usize)
        (problems in prop::collection::vec(arb_problem(), problem_count))
        -> Contest {
        Contest { problems }
    }
}

prop_compose! {
    fn arb_test_case()
        (input in "[0-9\\n]+", expected in "[0-9\\n]+")
        -> TestCase {
        TestCase { input, expected }
    }
}
```

### 4. 統合テストフレームワーク
```rust
// tests/integration/framework.rs
pub struct IntegrationTest {
    app: Application,
    fixture: TestFixture,
}

impl IntegrationTest {
    pub async fn new() -> Self {
        // アプリケーション初期化
        // モック環境構築
    }
    
    pub async fn run_command(&self, cmd: &str) -> CommandResult {
        // CLIコマンドの実行
    }
    
    pub async fn assert_output(&self, expected: &str) {
        // 出力の検証
    }
}
```

### 5. E2Eテストシナリオ
```rust
// tests/e2e/scenarios.rs
#[tokio::test]
async fn test_complete_contest_workflow() {
    let test = E2ETest::new().await;
    
    // 1. コンテスト問題のダウンロード（モック）
    test.mock_contest_api()
        .expect_download()
        .returning(|_| Ok(sample_contest()));
    
    // 2. 解答ファイルの作成
    test.create_solution("A/main.cpp", SAMPLE_CPP_CODE);
    
    // 3. テスト実行
    let result = test.run_tests("A").await;
    assert!(result.all_passed());
    
    // 4. 提出（モック）
    test.mock_submission_api()
        .expect_submit()
        .returning(|_| Ok(SubmissionId::new()));
}
```

### 6. パフォーマンステスト
```rust
// benches/performance.rs
use criterion::{criterion_group, criterion_main, Criterion};

fn benchmark_file_operations(c: &mut Criterion) {
    c.bench_function("read_large_file", |b| {
        b.iter(|| {
            // 大きなファイルの読み込みテスト
        })
    });
}

fn benchmark_docker_execution(c: &mut Criterion) {
    c.bench_function("docker_run", |b| {
        b.iter(|| {
            // Dockerコンテナ実行のベンチマーク
        })
    });
}
```

### 7. テストカバレッジとレポート
```rust
// テストカバレッジ設定
// tarpaulin.toml
[coverage]
exclude-files = ["*/test_utils/*", "*/tests/*"]
minimum-coverage = 80

// CI/CDでのカバレッジチェック
// .github/workflows/test.yml
- name: Run tests with coverage
  run: cargo tarpaulin --out Xml
- name: Upload coverage reports
  uses: codecov/codecov-action@v3
```

## 実装優先順位
1. 基本的なモック実装（FileDriver、ShellDriver）
2. テストフィクスチャとヘルパー関数
3. 統合テストフレームワーク
4. プロパティベーステスト
5. E2Eテストシナリオ
6. パフォーマンステスト

## 技術的考慮事項
- mockall crateによるモック生成
- proptest crateによるプロパティベーステスト
- criterion crateによるベンチマーク
- insta crateによるスナップショットテスト
- cargo-tarpaulinによるカバレッジ測定

## 期待される効果
- バグの早期発見と修正
- リファクタリング時の安全性確保
- 新機能追加時の既存機能への影響確認
- パフォーマンス劣化の検出
- ドキュメントとしてのテストコード

## テスト戦略
```
- Unit Tests: 個々の関数・メソッドの動作確認
  - 全ての公開APIをカバー
  - エッジケースの検証
  
- Integration Tests: モジュール間の連携確認  
  - 主要なユースケースのカバー
  - エラーハンドリングの検証
  
- E2E Tests: 実際の利用シナリオの検証
  - ユーザーワークフローの完全な実行
  - 外部サービスとの連携（モック使用）
  
- Performance Tests: パフォーマンスの監視
  - 主要な処理のベンチマーク
  - メモリ使用量の確認
```

## 参考実装の特徴
old_srcのテスト実装は:
- 包括的なモック実装
- 依存性注入を活用したテスタビリティ
- 実際の使用シナリオに基づくテスト
- エラーケースの網羅的なテスト

これらの良い点を継承しつつ、Rustのテストエコシステムを最大限活用する。