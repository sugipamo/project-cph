# 永続化レイヤー実装計画

## 概要
old_srcのSQLiteベースの永続化機構をRustに移植し、実行履歴、設定管理、セッション管理を実現する。

## 現状分析
### old_srcの実装
- `infrastructure/persistence/sqlite/`でSQLite管理
- マイグレーション機能
- リポジトリパターンによるデータアクセス抽象化
- 実行履歴、Docker状態、設定値の永続化

### 現在のRustプロジェクト
- `interfaces/persistence.rs`でトレイトは定義済み
- `infrastructure/persistence/`ディレクトリは存在するが未実装

## 実装方針
### 1. SQLite管理層
```rust
// src/infrastructure/persistence/sqlite_manager.rs
pub struct SqliteManager {
    pool: SqlitePool,
    migration_runner: MigrationRunner,
}

impl SqliteManager {
    pub async fn new(db_path: &Path) -> Result<Self> {
        // 接続プールの初期化とマイグレーション実行
    }
}
```

### 2. リポジトリ実装
```rust
// src/infrastructure/persistence/repositories/
pub struct ExecutionHistoryRepository {
    pool: SqlitePool,
}

pub struct ConfigurationRepository {
    pool: SqlitePool,
}

pub struct SessionRepository {
    pool: SqlitePool,
}
```

### 3. マイグレーション管理
```rust
// src/infrastructure/persistence/migrations/
pub struct Migration {
    version: u32,
    name: String,
    up_sql: &'static str,
    down_sql: Option<&'static str>,
}
```

## 使用するクレート
- `sqlx`: 非同期SQLite操作
- `tokio`: 非同期ランタイム
- `chrono`: 日時処理
- `uuid`: セッションID生成

## データモデル
### 1. 実行履歴
- コマンド実行結果
- タイムスタンプ
- 成功/失敗状態
- 関連するセッションID

### 2. 設定管理
- キー・バリュー形式
- 環境別設定
- デフォルト値サポート

### 3. Dockerコンテナ追跡
- コンテナID
- 作成/削除時刻
- 関連するタスク

## 実装ステップ
1. SQLitePool とデータベース初期化
2. マイグレーションシステムの実装
3. 基本的なリポジトリの実装
4. トランザクション管理
5. クエリビルダーまたは生SQLの選択
6. 単体テストと統合テスト

## 考慮事項
- 非同期処理での並行性制御
- SQLiteの制限（同時書き込み）への対処
- データベースファイルの場所（XDG Base Directory準拠）
- バックアップとリカバリ戦略