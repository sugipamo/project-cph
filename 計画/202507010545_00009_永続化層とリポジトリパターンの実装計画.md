# 永続化層とリポジトリパターンの実装計画

## 背景
old_srcでは、SQLiteを使用した永続化層が実装されており、リポジトリパターンによってデータアクセスが抽象化されている。実行履歴、セッション管理、Dockerコンテナの追跡など、競技プログラミング支援ツールに必要な状態管理機能を提供している。

## 現状分析
- SQLiteによる軽量な永続化
- マイグレーションシステムによるスキーマ管理
- リポジトリパターンによるデータアクセスの抽象化
- セッション単位での実行履歴管理
- Dockerリソースの追跡機能

## Rustでの実装設計

### 1. リポジトリトレイトの定義
```rust
// src/repositories/traits.rs
#[async_trait]
pub trait Repository<T, ID> {
    async fn find_by_id(&self, id: ID) -> Result<Option<T>>;
    async fn find_all(&self) -> Result<Vec<T>>;
    async fn save(&self, entity: &T) -> Result<ID>;
    async fn update(&self, entity: &T) -> Result<()>;
    async fn delete(&self, id: ID) -> Result<()>;
}

#[async_trait]
pub trait SessionRepository: Repository<Session, String> {
    async fn find_active(&self) -> Result<Option<Session>>;
    async fn find_by_contest_id(&self, contest_id: &str) -> Result<Vec<Session>>;
}
```

### 2. エンティティの定義
```rust
// src/domain/entities.rs
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Session {
    pub id: String,
    pub contest_id: Option<String>,
    pub started_at: DateTime<Utc>,
    pub ended_at: Option<DateTime<Utc>>,
    pub status: SessionStatus,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ExecutionHistory {
    pub id: String,
    pub session_id: String,
    pub command: String,
    pub result: ExecutionResult,
    pub executed_at: DateTime<Utc>,
    pub duration_ms: u64,
}
```

### 3. SQLite実装
```rust
// src/infrastructure/persistence/sqlite/connection.rs
pub struct SqliteConnectionPool {
    pool: Pool<Sqlite>,
}

impl SqliteConnectionPool {
    pub async fn new(database_url: &str) -> Result<Self>;
    pub async fn migrate(&self) -> Result<()>;
}

// src/infrastructure/persistence/sqlite/repositories/session.rs
pub struct SqliteSessionRepository {
    pool: Arc<SqliteConnectionPool>,
}

#[async_trait]
impl SessionRepository for SqliteSessionRepository {
    // 実装
}
```

### 4. マイグレーションシステム
```rust
// src/infrastructure/persistence/migrations/mod.rs
pub struct Migration {
    pub version: u32,
    pub name: String,
    pub up: String,
    pub down: Option<String>,
}

pub struct MigrationRunner {
    migrations: Vec<Migration>,
}

impl MigrationRunner {
    pub async fn run_pending(&self, conn: &SqliteConnection) -> Result<()>;
    pub async fn rollback(&self, conn: &SqliteConnection, version: u32) -> Result<()>;
}
```

## 実装ステップ

### フェーズ1: 基本インフラの構築
1. SQLiteコネクションプールの実装
2. 基本的なリポジトリトレイトの定義
3. エラーハンドリングの設計

### フェーズ2: マイグレーションシステム
1. マイグレーションファイルの管理
2. バージョン管理テーブルの実装
3. up/downマイグレーションの実行

### フェーズ3: 主要リポジトリの実装
1. SessionRepositoryの実装
2. ExecutionHistoryRepositoryの実装
3. ConfigurationRepositoryの実装

### フェーズ4: 高度な機能
1. トランザクション管理
2. バッチ操作の最適化
3. キャッシュレイヤーの追加

## データベーススキーマ例
```sql
-- セッションテーブル
CREATE TABLE sessions (
    id TEXT PRIMARY KEY,
    contest_id TEXT,
    started_at TEXT NOT NULL,
    ended_at TEXT,
    status TEXT NOT NULL
);

-- 実行履歴テーブル
CREATE TABLE execution_histories (
    id TEXT PRIMARY KEY,
    session_id TEXT NOT NULL,
    command TEXT NOT NULL,
    stdout TEXT,
    stderr TEXT,
    exit_code INTEGER,
    executed_at TEXT NOT NULL,
    duration_ms INTEGER NOT NULL,
    FOREIGN KEY (session_id) REFERENCES sessions(id)
);

-- インデックス
CREATE INDEX idx_sessions_contest_id ON sessions(contest_id);
CREATE INDEX idx_histories_session_id ON execution_histories(session_id);
```

## 期待される効果
- **履歴管理**: 実行コマンドと結果の永続化
- **セッション追跡**: 作業セッションの管理
- **統計分析**: 実行パターンの分析が可能
- **デバッグ支援**: 過去の実行結果の参照

## 課題と対策
- **課題**: 非同期処理とデータベースアクセスの効率化
- **対策**: sqlxのコネクションプールと非同期クエリの活用
- **課題**: スキーマの進化に伴う互換性
- **対策**: 段階的なマイグレーションとバージョン管理

## 参考実装
- old_src/infrastructure/persistence/sqlite/配下の実装
- old_src/repositories/配下の各リポジトリ
- old_src/infrastructure/persistence/sqlite/migrations/配下のマイグレーションファイル