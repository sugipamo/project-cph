# 永続化層実装計画

## 概要
old_srcのSQLiteベースの永続化層を参考に、競技プログラミング支援ツールとしての実行履歴、問題管理、セッション管理機能を実装する計画。

## 現状分析
### 現在のRustプロジェクト
- 永続化機能なし
- セッション管理なし
- 実行履歴の記録なし

### old_srcの永続化システム
- SQLiteによる軽量なデータベース
- マイグレーションシステム
- リポジトリパターン
- セッション管理
- Docker実行履歴
- 設定値の永続化

## 移行によるメリット
1. **問題解決の追跡**
   - 解いた問題の記録
   - 実行時間、メモリ使用量の履歴
   - 提出結果の管理

2. **学習効果の向上**
   - 過去の解法の参照
   - パフォーマンス改善の追跡

3. **ワークフローの最適化**
   - よく使う設定の保存
   - テンプレートの管理

## 実装方針
1. **データモデル設計**
   ```sql
   -- 問題管理
   CREATE TABLE problems (
       id INTEGER PRIMARY KEY,
       contest_id TEXT,
       problem_id TEXT,
       name TEXT,
       url TEXT,
       solved_at TIMESTAMP
   );

   -- 実行履歴
   CREATE TABLE executions (
       id INTEGER PRIMARY KEY,
       problem_id INTEGER,
       language TEXT,
       source_code TEXT,
       compile_time_ms INTEGER,
       execution_time_ms INTEGER,
       memory_usage_kb INTEGER,
       status TEXT,
       executed_at TIMESTAMP
   );

   -- テストケース結果
   CREATE TABLE test_results (
       id INTEGER PRIMARY KEY,
       execution_id INTEGER,
       test_case_name TEXT,
       status TEXT,
       execution_time_ms INTEGER,
       output TEXT
   );
   ```

2. **リポジトリ層**
   - トレイトベースの抽象化
   - SQLite実装
   - インメモリ実装（テスト用）

3. **マイグレーション管理**
   - バージョン管理
   - 自動マイグレーション

## 技術的考察
### Rustでの実装
- `sqlx`または`rusqlite`の使用
- 型安全なクエリビルダー
- 非同期対応

### 競技プログラミング特有の機能
1. **統計情報**
   - 言語別の使用頻度
   - 問題の難易度別成功率
   - 実行時間の推移

2. **テンプレート管理**
   - よく使うコードスニペット
   - 言語別のボイラープレート

3. **コンテスト管理**
   - 参加したコンテストの記録
   - レーティング変化の追跡

## 実装優先度
**中**：長期的な価値は高いが、コア機能ではない

## 想定される課題
1. データベーススキーマの設計
2. パフォーマンスの考慮
3. データのエクスポート/インポート

## 具体的な機能
### 1. 実行履歴の可視化
```
$ cph history --problem ABC123A
┌─────────────────┬────────┬──────────┬────────┐
│ Date            │ Lang   │ Time(ms) │ Result │
├─────────────────┼────────┼──────────┼────────┤
│ 2024-01-15 10:30│ C++    │ 1234     │ AC     │
│ 2024-01-15 10:25│ C++    │ 2345     │ TLE    │
│ 2024-01-15 10:20│ Python │ 3456     │ WA     │
└─────────────────┴────────┴──────────┴────────┘
```

### 2. 問題の検索
```
$ cph search --tag "DP" --difficulty "medium"
```

### 3. ベストプラクティスの記録
- 特定のアルゴリズムの実装例
- 最適化テクニック

## 次のステップ
1. データモデルの詳細設計
2. SQLiteライブラリの選定
3. プロトタイプ実装