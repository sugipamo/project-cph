# ワークフロー実行エンジンの導入計画

## 背景
old_srcでは、複雑な処理を段階的に実行するワークフローエンジンが実装されている。JSONベースのワークフロー定義、依存関係の解決、並列実行などの機能を持つ。競技プログラミング支援ツールとして、テストケースの実行、ビルド、提出などの一連の処理をワークフローとして定義・実行できることは重要である。

## 現状分析
- old_srcのワークフローシステムは`Step`ベースで構成
- 各ステップは依存関係を持ち、自動的に実行順序が決定される
- CompositeRequestにより複数の操作をバッチ実行可能
- JSON形式でワークフローを定義可能

## Rustでの実装設計

### 1. ワークフロー基本構造
```rust
// src/workflow/types.rs
pub struct Workflow {
    pub id: String,
    pub steps: Vec<Step>,
    pub metadata: WorkflowMetadata,
}

pub struct Step {
    pub id: String,
    pub name: String,
    pub request: UnifiedRequest,
    pub dependencies: Vec<String>,
    pub retry_policy: Option<RetryPolicy>,
}

pub struct WorkflowResult {
    pub workflow_id: String,
    pub step_results: HashMap<String, StepResult>,
    pub execution_time: Duration,
}
```

### 2. 実行エンジン
```rust
// src/workflow/engine.rs
pub struct WorkflowEngine {
    driver: Arc<dyn UnifiedDriver>,
    executor: Arc<dyn StepExecutor>,
}

impl WorkflowEngine {
    pub async fn execute(&self, workflow: Workflow) -> Result<WorkflowResult>;
    fn resolve_dependencies(&self, steps: &[Step]) -> Vec<Vec<&Step>>;
    async fn execute_parallel(&self, steps: Vec<&Step>) -> Vec<StepResult>;
}
```

### 3. ワークフロー定義
```rust
// src/workflow/builder.rs
pub struct WorkflowBuilder {
    steps: Vec<Step>,
}

impl WorkflowBuilder {
    pub fn new() -> Self;
    pub fn add_step(self, step: Step) -> Self;
    pub fn with_dependency(self, step_id: &str, depends_on: &str) -> Self;
    pub fn build(self) -> Result<Workflow>;
}
```

## 実装ステップ

### フェーズ1: 基本データ構造の実装
1. Workflow、Step、WorkflowResult型の定義
2. 依存関係グラフの実装
3. ワークフロービルダーの基本実装

### フェーズ2: 実行エンジンの実装
1. 依存関係の解決アルゴリズム
2. 並列実行のサポート（tokioを使用）
3. エラーハンドリングとリトライ機能

### フェーズ3: ワークフロー定義の拡張
1. JSONからのワークフロー読み込み
2. YAMLサポートの追加
3. ワークフローテンプレート機能

### フェーズ4: 高度な機能の実装
1. 条件分岐のサポート
2. ループ処理のサポート
3. ワークフローの一時停止・再開機能

## 競技プログラミング向けワークフロー例
```json
{
  "id": "test_and_submit",
  "steps": [
    {
      "id": "compile",
      "name": "Compile source",
      "request": { "type": "shell", "command": "rustc main.rs" }
    },
    {
      "id": "test_sample",
      "name": "Run sample tests",
      "request": { "type": "shell", "command": "./test_runner sample" },
      "dependencies": ["compile"]
    },
    {
      "id": "test_all",
      "name": "Run all tests",
      "request": { "type": "shell", "command": "./test_runner all" },
      "dependencies": ["test_sample"]
    },
    {
      "id": "submit",
      "name": "Submit solution",
      "request": { "type": "shell", "command": "oj submit" },
      "dependencies": ["test_all"]
    }
  ]
}
```

## 期待される効果
- **自動化**: 複雑な処理フローの自動実行
- **並列化**: 依存関係のないステップの並列実行による高速化
- **再利用性**: ワークフローテンプレートによる処理の再利用
- **可視性**: 実行状況の追跡とログ管理

## 課題と対策
- **課題**: 非同期処理と依存関係管理の複雑さ
- **対策**: tokioとpetgraphを活用した実装
- **課題**: エラー発生時のロールバック
- **対策**: 各ステップの冪等性を保証する設計

## 参考実装
- old_src/workflow/step/配下の実装
- old_src/services/workflow_execution/workflow_execution_service.py
- old_src/services/step_generation/step_generation_service.py