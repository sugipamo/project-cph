# 永続化層の強化計画

## 背景
old_srcには包括的な永続化層（infrastructure/persistence/）とリポジトリパターンの実装がある。現在のRustプロジェクトでは永続化層が最小限の実装に留まっており、実行履歴やセッション管理などの高度な機能が不足している。

## 目的
- 実行履歴の永続的な保存と検索
- セッション状態の管理
- 統計情報の収集と分析
- マイグレーション機能の実装

## 現状分析

### old_srcの永続化機能
- `SqliteManager`: SQLiteデータベース管理
- `FastSqliteManager`: 高速化されたSQLite実装
- リポジトリパターンによる抽象化
- マイグレーションシステム
- 複数のドメインモデル用リポジトリ

### 現在のプロジェクトの状態
- インターフェース定義のみ（`src/interfaces/persistence.rs`）
- 実装が存在しない
- データの永続化なし

## 実装方針

### 1. データベース層の設計
```rust
// src/infrastructure/persistence/database.rs
pub struct DatabaseManager {
    connection_pool: SqlitePool,
    migration_runner: MigrationRunner,
}
```

### 2. リポジトリパターンの実装
- 実行履歴リポジトリ
- 設定リポジトリ
- テスト結果リポジトリ
- 統計情報リポジトリ

### 3. マイグレーションシステム
- スキーマバージョン管理
- 自動マイグレーション実行
- ロールバック機能

### 4. データモデル
```rust
// 実行履歴
pub struct ExecutionHistory {
    id: Uuid,
    problem_id: String,
    language: Language,
    result: TestResult,
    executed_at: DateTime<Utc>,
}

// セッション情報
pub struct Session {
    id: Uuid,
    started_at: DateTime<Utc>,
    last_activity: DateTime<Utc>,
    state: SessionState,
}
```

## 技術的課題
- 非同期SQLite操作の実装
- トランザクション管理
- データ整合性の保証

## 実装優先度
中：長期的な使用には必須だが、基本機能は動作する

## 必要なリソース
- sqlx crate（非同期SQL）
- uuid crate（ID生成）
- chrono crate（時刻管理）

## 成功指標
- 実行履歴の完全な記録
- クラッシュ後のセッション復元
- パフォーマンス統計の表示