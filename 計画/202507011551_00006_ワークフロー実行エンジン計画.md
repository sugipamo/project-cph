# ワークフロー実行エンジン計画

## 概要
old_srcのステップベースのワークフロー実行エンジンをRustに移植し、依存関係を持つタスクの並列実行を実現する。

## 現状分析
### old_srcの実装
- `workflow/step/`でステップとその依存関係を管理
- ワークフロー実行サービスで並列実行を制御
- リクエスト/レスポンスパターンによる操作の抽象化
- コンポジットリクエストによる複数操作の組み合わせ

### 現在のRustプロジェクト
- 単純なサービス実行のみ
- ワークフロー概念は未実装
- 並列実行機能なし

## 実装方針
### 1. ステップの定義
```rust
// src/domain/workflow/step.rs
pub struct Step {
    id: StepId,
    operation: Box<dyn Operation>,
    dependencies: Vec<StepId>,
    status: StepStatus,
}

pub trait Operation: Send + Sync {
    async fn execute(&self, context: &ExecutionContext) -> Result<OperationResult>;
    fn validate(&self) -> Result<()>;
}
```

### 2. ワークフロー定義
```rust
// src/domain/workflow/workflow.rs
pub struct Workflow {
    steps: HashMap<StepId, Step>,
    graph: DiGraph<StepId, ()>,
}

impl Workflow {
    pub fn add_step(&mut self, step: Step) -> Result<()>;
    pub fn add_dependency(&mut self, from: StepId, to: StepId) -> Result<()>;
    pub fn topological_sort(&self) -> Result<Vec<StepId>>;
}
```

### 3. 実行エンジン
```rust
// src/application/workflow_executor.rs
pub struct WorkflowExecutor {
    runtime: tokio::runtime::Runtime,
    max_parallelism: usize,
}

impl WorkflowExecutor {
    pub async fn execute(&self, workflow: Workflow) -> Result<WorkflowResult> {
        // 依存関係を考慮した並列実行
    }
}
```

## 主要な機能
### 1. 依存関係管理
- DAG（有向非巡回グラフ）による依存関係表現
- トポロジカルソートによる実行順序決定
- 循環依存の検出

### 2. 並列実行
- tokioによる非同期タスク管理
- 依存関係を満たしたステップの並列実行
- リソース制限（最大並列数）

### 3. エラーハンドリング
- ステップ失敗時の伝播制御
- リトライ機構
- 部分的成功の処理

## 使用するクレート
- `petgraph`: グラフデータ構造
- `tokio`: 非同期ランタイム
- `futures`: 非同期ユーティリティ

## 実装ステップ
1. 基本的なステップとオペレーションの定義
2. DAGベースのワークフロー構造
3. トポロジカルソートの実装
4. 並列実行エンジンの基本実装
5. エラーハンドリングとリトライ
6. プログレストラッキング

## 考慮事項
- メモリ効率的なグラフ表現
- 大規模ワークフローへの対応
- 実行状態の永続化と再開機能
- タイムアウト処理