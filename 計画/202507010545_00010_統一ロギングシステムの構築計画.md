# 統一ロギングシステムの構築計画

## 背景
old_srcでは、UnifiedLoggerを中心とした統一的なロギングシステムが実装されている。構造化ログ、カラー出力、デバッグレベル管理など、開発とデバッグに必要な機能を提供している。競技プログラミング支援ツールとして、実行結果の見やすい表示は重要である。

## 現状分析
- UnifiedLoggerによる一元的なログ管理
- OutputManagerによる出力形式の制御
- カラーマネージャーによるターミナル色付け
- 構造化されたログフォーマット
- モック実装によるテスト対応

## Rustでの実装設計

### 1. ロガートレイトの定義
```rust
// src/infrastructure/logging/traits.rs
pub trait Logger: Send + Sync {
    fn debug(&self, message: &str, context: Option<LogContext>);
    fn info(&self, message: &str, context: Option<LogContext>);
    fn warn(&self, message: &str, context: Option<LogContext>);
    fn error(&self, message: &str, context: Option<LogContext>);
    fn with_context(&self, context: LogContext) -> Box<dyn Logger>;
}

#[derive(Debug, Clone)]
pub struct LogContext {
    pub session_id: Option<String>,
    pub operation: Option<String>,
    pub metadata: HashMap<String, String>,
}
```

### 2. 統一ロガーの実装
```rust
// src/infrastructure/logging/unified_logger.rs
pub struct UnifiedLogger {
    output_manager: Arc<dyn OutputManager>,
    log_level: LogLevel,
    color_manager: ColorManager,
}

impl UnifiedLogger {
    pub fn new(config: LogConfig) -> Self;
    
    fn format_message(&self, level: LogLevel, message: &str, context: Option<&LogContext>) -> String;
    
    fn should_log(&self, level: LogLevel) -> bool;
}
```

### 3. 出力マネージャー
```rust
// src/infrastructure/logging/output_manager.rs
pub trait OutputManager: Send + Sync {
    fn write_stdout(&self, message: &str);
    fn write_stderr(&self, message: &str);
    fn write_file(&self, message: &str, file_path: &Path);
}

pub struct StandardOutputManager {
    stdout_formatter: Box<dyn Formatter>,
    stderr_formatter: Box<dyn Formatter>,
    file_formatter: Box<dyn Formatter>,
}
```

### 4. カラー管理
```rust
// src/infrastructure/logging/color_manager.rs
pub struct ColorManager {
    enabled: bool,
    theme: ColorTheme,
}

impl ColorManager {
    pub fn colorize(&self, text: &str, color: Color) -> String;
    pub fn format_level(&self, level: LogLevel) -> String;
    pub fn format_timestamp(&self, timestamp: &DateTime<Local>) -> String;
}

pub enum Color {
    Red,
    Green,
    Yellow,
    Blue,
    Magenta,
    Cyan,
}
```

## 実装ステップ

### フェーズ1: 基本ロギング機能
1. Loggerトレイトの定義と基本実装
2. ログレベルとフィルタリング
3. 標準出力への基本的な出力

### フェーズ2: 構造化ログ
1. LogContextの実装
2. JSON形式での構造化ログ出力
3. メタデータの付与機能

### フェーズ3: 出力制御
1. OutputManagerの実装
2. 複数の出力先のサポート
3. フォーマッターの実装

### フェーズ4: 高度な機能
1. カラー出力のサポート
2. プログレスバーとの統合
3. ログローテーション機能

## ログフォーマット例
```
[2024-01-20 15:30:45] [INFO] [session:abc123] Starting test execution
  ├─ command: cargo test
  ├─ working_dir: /home/user/project
  └─ timeout: 30s

[2024-01-20 15:30:47] [SUCCESS] All tests passed (15/15)
  ├─ duration: 2.15s
  └─ coverage: 85.3%

[2024-01-20 15:30:48] [ERROR] [operation:submit] Submission failed
  ├─ reason: Network timeout
  ├─ retry_count: 3
  └─ next_retry: 5s
```

## 競技プログラミング特化機能
```rust
// src/infrastructure/logging/cp_logger.rs
pub trait CPLogger: Logger {
    fn test_result(&self, test_name: &str, passed: bool, execution_time: Duration);
    fn submission_result(&self, status: SubmissionStatus, details: &str);
    fn time_limit_warning(&self, used: Duration, limit: Duration);
}

impl CPLogger for UnifiedLogger {
    fn test_result(&self, test_name: &str, passed: bool, execution_time: Duration) {
        let icon = if passed { "✓" } else { "✗" };
        let color = if passed { Color::Green } else { Color::Red };
        // カラー付きでテスト結果を表示
    }
}
```

## 期待される効果
- **可読性**: 構造化された見やすいログ出力
- **デバッグ性**: コンテキスト情報による問題追跡の容易化
- **柔軟性**: 出力先とフォーマットのカスタマイズ
- **テスタビリティ**: モック実装によるテストの容易化

## 課題と対策
- **課題**: パフォーマンスへの影響
- **対策**: 条件付きログ出力とバッファリング
- **課題**: 並行処理時のログ順序
- **対策**: タイムスタンプとコンテキストIDによる追跡

## 参考実装
- old_src/infrastructure/drivers/logging/unified_logger.py
- old_src/infrastructure/drivers/logging/output_manager.py
- old_src/infrastructure/drivers/logging/color_manager.py