# プロバイダーパターン副作用管理計画

## 概要
old_srcのプロバイダーパターンを参考に、副作用をinfrastructure層に集中させる仕組みを強化する。

## 背景
- old_srcでは、OS、時間、ファイルシステムなどの副作用をプロバイダー経由で管理
- テスト時のモック化が容易
- 副作用の発生箇所が明確

## 目的
1. 現在のinfrastructure層の副作用管理をさらに体系化
2. 新しい種類の副作用（ネットワーク、乱数等）への対応
3. CLAUDE.mdの「副作用はsrc/infrastructure配下に集中」方針の徹底

## 実装方針
### フェーズ1: プロバイダー基盤
- Providerトレイトの定義
- 基本プロバイダーの実装（Time、OS、Random）
- プロバイダーレジストリの構築

### フェーズ2: 既存コードの移行
- 直接的なstd呼び出しをプロバイダー経由に変更
- ドメイン層からの副作用除去
- アプリケーション層での適切なプロバイダー使用

### フェーズ3: 高度な機能
- プロバイダーのチェイン機能
- 条件付きプロバイダー（環境変数による切り替え）
- プロバイダーの監視・ロギング

## 技術的詳細
- トレイトオブジェクトによる動的バインディング
- モックプロバイダーの自動生成マクロ
- 副作用の発生を型システムで追跡

## 期待される効果
- テストの決定性向上（時間や乱数の制御）
- 副作用の発生箇所の可視化
- 環境依存性の削減

## リスクと対策
- 過度な抽象化によるパフォーマンス低下
  - 対策: インライン化と最適化の活用
- APIの煩雑化
  - 対策: エルゴノミックなヘルパー関数の提供

## 参考
- old_src/infrastructure/providers/
- CLAUDE.mdの副作用管理方針
- 既存のインフラストラクチャ層副作用管理計画（202506302002_00014）との連携