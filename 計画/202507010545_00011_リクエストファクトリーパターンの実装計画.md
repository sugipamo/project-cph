# リクエストファクトリーパターンの実装計画

## 背景
old_srcでは、RequestFactoryパターンにより、各種操作リクエストの生成と検証を一元管理している。型安全な操作の定義、事前検証、エラーハンドリングの統一など、堅牢なシステム構築に重要な役割を果たしている。

## 現状分析
- RequestFactoryが全てのリクエスト生成を管理
- 事前検証により不正なリクエストを防止
- 型安全性により操作ミスを防止
- エラーの標準化により一貫したエラーハンドリング

## Rustでの実装設計

### 1. リクエスト型の定義
```rust
// src/operations/requests/mod.rs
#[derive(Debug, Clone)]
pub enum OperationType {
    Shell(ShellOperation),
    File(FileOperation),
    Docker(DockerOperation),
}

#[derive(Debug, Clone)]
pub enum ShellOperation {
    Execute,
    Background,
    Kill,
}

#[derive(Debug, Clone)]
pub enum FileOperation {
    Read,
    Write,
    Delete,
    Copy,
    Move,
}
```

### 2. リクエストファクトリー
```rust
// src/operations/factories/request_factory.rs
pub struct RequestFactory {
    validators: HashMap<OperationType, Box<dyn RequestValidator>>,
}

impl RequestFactory {
    pub fn create_shell_request(
        &self,
        command: String,
        options: ShellOptions,
    ) -> Result<ShellRequest> {
        let request = ShellRequest {
            id: Uuid::new_v4().to_string(),
            command,
            options,
            created_at: Utc::now(),
        };
        
        self.validate_shell_request(&request)?;
        Ok(request)
    }
    
    pub fn create_file_request(
        &self,
        operation: FileOperation,
        path: PathBuf,
        options: FileOptions,
    ) -> Result<FileRequest> {
        // パスの検証、権限チェックなど
    }
}
```

### 3. バリデーション
```rust
// src/operations/validation/mod.rs
pub trait RequestValidator: Send + Sync {
    fn validate(&self, request: &dyn Any) -> Result<()>;
}

pub struct ShellRequestValidator {
    forbidden_commands: HashSet<String>,
    max_command_length: usize,
}

impl RequestValidator for ShellRequestValidator {
    fn validate(&self, request: &dyn Any) -> Result<()> {
        let shell_request = request.downcast_ref::<ShellRequest>()
            .ok_or_else(|| ValidationError::InvalidType)?;
        
        // コマンドの安全性チェック
        self.check_forbidden_commands(&shell_request.command)?;
        self.check_command_length(&shell_request.command)?;
        self.check_injection_risks(&shell_request.command)?;
        
        Ok(())
    }
}
```

### 4. ビルダーパターンの活用
```rust
// src/operations/builders/mod.rs
pub struct ShellRequestBuilder {
    command: Option<String>,
    working_dir: Option<PathBuf>,
    environment: HashMap<String, String>,
    timeout: Option<Duration>,
}

impl ShellRequestBuilder {
    pub fn new() -> Self { 
        Self::default() 
    }
    
    pub fn command(mut self, cmd: String) -> Self {
        self.command = Some(cmd);
        self
    }
    
    pub fn working_dir(mut self, dir: PathBuf) -> Self {
        self.working_dir = Some(dir);
        self
    }
    
    pub fn build(self, factory: &RequestFactory) -> Result<ShellRequest> {
        let command = self.command.ok_or(BuildError::MissingRequired("command"))?;
        factory.create_shell_request(command, self.into_options())
    }
}
```

## 実装ステップ

### フェーズ1: 基本型システムの構築
1. 操作タイプの列挙型定義
2. 各リクエスト型の構造体定義
3. 基本的なファクトリーインターフェース

### フェーズ2: バリデーションシステム
1. RequestValidatorトレイトの定義
2. 各操作タイプ用のバリデーター実装
3. カスタムバリデーションルールのサポート

### フェーズ3: ビルダーパターンの実装
1. 各リクエストタイプ用のビルダー
2. 流暢なインターフェースの実装
3. 部分的な構築のサポート

### フェーズ4: エラーハンドリング
1. 統一エラー型の定義
2. エラー変換の実装
3. リカバリー戦略の実装

## 使用例
```rust
// シンプルなシェルコマンド実行
let request = factory.create_shell_request(
    "cargo test".to_string(),
    ShellOptions::default(),
)?;

// ビルダーパターンを使用した複雑なリクエスト
let request = ShellRequestBuilder::new()
    .command("cargo test --release")
    .working_dir("/home/user/project")
    .env("RUST_LOG", "debug")
    .timeout(Duration::from_secs(300))
    .build(&factory)?;

// ファイル操作
let request = FileRequestBuilder::new()
    .operation(FileOperation::Write)
    .path("/tmp/results.json")
    .content(serde_json::to_string(&results)?)
    .permissions(0o644)
    .build(&factory)?;
```

## 期待される効果
- **型安全性**: コンパイル時の操作検証
- **一貫性**: 統一されたリクエスト生成
- **拡張性**: 新しい操作タイプの追加が容易
- **セキュリティ**: 事前検証による安全性向上

## セキュリティ考慮事項
```rust
// コマンドインジェクション対策
pub struct SecurityValidator {
    pub fn validate_shell_command(&self, command: &str) -> Result<()> {
        // 危険な文字のチェック
        if command.contains("&&") || command.contains("||") || command.contains(";") {
            return Err(SecurityError::PotentialInjection);
        }
        
        // 環境変数展開の制限
        if command.contains("$") && !self.is_safe_variable(command) {
            return Err(SecurityError::UnsafeVariableExpansion);
        }
        
        Ok(())
    }
}
```

## 課題と対策
- **課題**: 多様な操作タイプへの対応
- **対策**: ジェネリックとトレイトオブジェクトの適切な使い分け
- **課題**: バリデーションルールの管理
- **対策**: ルールの外部設定化とホットリロード

## 参考実装
- old_src/operations/factories/request_factory.py
- old_src/infrastructure/request_factory.py
- old_src/validators/配下の各種バリデーター