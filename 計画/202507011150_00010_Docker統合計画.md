# Docker統合計画

## 概要
old_srcのDockerドライバーとコンテナ管理機能を参考に、競技プログラミング環境の完全な分離と再現性を実現するDocker統合を計画。

## 現状分析
### 現在のRustプロジェクト
- ローカル環境での直接実行
- 環境依存の問題
- 言語バージョンの管理が困難

### old_srcのDockerシステム
- 完全なDockerドライバー実装
- コンテナのライフサイクル管理
- イメージビルド機能
- ボリュームマウント
- 実行追跡機能

## 移行によるメリット
1. **環境の完全な分離**
   - ホスト環境の汚染防止
   - 言語バージョンの厳密な管理

2. **再現性の保証**
   - どの環境でも同じ結果
   - ジャッジ環境の再現

3. **セキュリティ**
   - サンドボックス実行
   - リソース制限

## 実装方針
1. **Dockerイメージ管理**
   ```dockerfile
   # 各言語用のベースイメージ
   FROM ubuntu:22.04
   RUN apt-get update && apt-get install -y \
       g++ \
       python3 \
       openjdk-17-jdk
   ```

2. **実行環境の抽象化**
   - 言語別のDockerfile
   - カスタムイメージのサポート

3. **リソース管理**
   - メモリ制限
   - CPU制限
   - 実行時間制限

## 技術的考察
### Rustでの実装
- `bollard`によるDocker API連携
- 非同期実行のサポート
- ストリーミングログ

### 競技プログラミング特有の要件
1. **ジャッジ環境の再現**
   - AtCoder環境
   - Codeforces環境
   - 各種オンラインジャッジ

2. **高速な実行**
   - イメージキャッシュ
   - レイヤーの最適化

3. **インタラクティブ問題対応**
   - 標準入出力の双方向通信
   - プロセス間通信

## 実装優先度
**低**：高度な機能だが、必須ではない

## 想定される課題
1. Dockerの依存性
2. 起動時間のオーバーヘッド
3. Windows/macOSでの動作

## 具体的な機能
### 1. 言語環境の管理
```yaml
environments:
  cpp:
    image: "cph/cpp:latest"
    compiler: "g++"
    flags: "-std=c++20 -O2"
  python:
    image: "cph/python:3.11"
    interpreter: "python3"
  rust:
    image: "cph/rust:1.75"
    compiler: "rustc"
```

### 2. カスタム環境の定義
```dockerfile
# .cph/Dockerfile.custom
FROM cph/base:latest
RUN pip install numpy scipy
```

### 3. 実行例
```bash
$ cph test --docker
Building C++ solution in container...
Running tests in isolated environment:
✓ Sample 1: PASSED (Memory: 256KB, Time: 12ms)
✓ Sample 2: PASSED (Memory: 512KB, Time: 15ms)
```

## セキュリティ考慮事項
1. **ネットワーク分離**
   - デフォルトでネットワーク無効
   - 必要時のみ有効化

2. **ファイルシステム保護**
   - 読み取り専用マウント
   - 一時ファイルの自動削除

3. **リソース制限**
   - fork bomb対策
   - メモリ爆弾対策

## 実装段階
1. **Phase 1: 基本的なDocker統合**
   - 単純な実行
   - 標準的な言語イメージ

2. **Phase 2: 高度な機能**
   - カスタムイメージ
   - リソース管理

3. **Phase 3: 最適化**
   - キャッシュ戦略
   - 並列実行

## 次のステップ
1. Docker APIの調査
2. 言語別イメージの設計
3. パフォーマンステスト