# 依存性注入コンテナ改善計画

## 概要
old_srcのDIコンテナ実装を参考に、現在のRustプロジェクトの依存性注入メカニズムを改善する。型安全性を保ちながら、テスタビリティと拡張性を向上させる。

## 背景
- old_srcでは、Enumベースの型安全なキー管理により、依存関係を明確に定義
- 自動的な依存関係解決により、初期化順序の問題を回避
- テスト用のオーバーライド機能により、モックの注入が容易

## 目的
1. 現在のmain.rsからの依存性注入をより体系的に管理
2. テスト時のモック注入を簡潔に実現
3. 依存関係の循環参照を検出・防止

## 実装方針
### フェーズ1: 基礎実装
- DIコンテナトレイトの定義
- 依存関係キーの型安全な管理（PhantomDataを活用）
- 基本的な登録・解決メカニズム

### フェーズ2: 高度な機能
- 自動的な依存関係解決（トポロジカルソート）
- 循環参照の検出
- ライフタイム管理（Singleton, Transient）

### フェーズ3: テストサポート
- テスト用オーバーライド機能
- モックの自動生成ヘルパー
- 依存関係の可視化（デバッグ用）

## 技術的詳細
- `Arc<dyn Any>`を使った型消去
- `TypeId`による型安全性の確保
- マクロによる登録の簡略化

## 期待される効果
- テストの書きやすさが大幅に向上
- 新しい依存関係の追加が容易
- 依存関係の明確化によるコードの理解性向上

## リスクと対策
- 過度な抽象化による複雑性
  - 対策: シンプルなAPIを維持し、必要最小限の機能に絞る
- パフォーマンスオーバーヘッド
  - 対策: 起動時のみの処理とし、ランタイムでの影響を最小化

## 参考
- old_src/infrastructure/di_container.py
- 既存のDIコンテナ実装計画（202506301636_00008）との統合を検討