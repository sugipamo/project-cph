# 副作用管理徹底計画

## 概要
CLAUDE.mdの原則に従い、すべての副作用をsrc/infrastructure配下に集中させ、main.rsから注入する仕組みを徹底する。

## 背景と課題
- 現状: Infrastructure層以外での副作用処理（最重要違反、スコア100）
- 副作用の分散による予測困難性
- テスタビリティの低下
- 依存性注入の不徹底

## 目標
1. 副作用の100% Infrastructure層への集約
2. 純粋関数とIOの明確な分離
3. 依存性注入による疎結合化
4. テスタビリティの向上

## 実装方針

### 副作用の定義と分類
```rust
// 副作用として扱うもの
- ファイルシステムアクセス
- ネットワーク通信
- データベース操作
- 環境変数読み取り
- 時刻取得
- 乱数生成
- ログ出力
```

### Infrastructure層の構造
```rust
// src/infrastructure/
├── adapters/      // 外部システムアダプター
│   ├── file_system.rs
│   ├── http_client.rs
│   └── database.rs
├── drivers/       // ドライバー実装
│   ├── docker.rs
│   └── podman.rs
├── repositories/  // 永続化実装
└── services/      // インフラサービス
    ├── logger.rs
    └── config.rs
```

### 依存性注入パターン
```rust
// main.rsでの注入例
fn main() -> Result<()> {
    // すべての副作用をここで初期化
    let config = Config::from_env()?;
    let logger = Logger::new(&config.log_level);
    let db = Database::connect(&config.db_url)?;
    let http_client = HttpClient::new();
    
    // アプリケーションコンテキストの構築
    let app = Application::new(
        logger,
        db,
        http_client,
    );
    
    app.run()
}
```

## 実装フェーズ

### フェーズ1: 副作用の洗い出し（3日）
- 全コードベースの副作用スキャン
- 違反箇所のリスト化
- 影響範囲の分析

### フェーズ2: インターフェース定義（1週間）
- 副作用のトレイト定義
- モックable な設計
- エラーハンドリング統一

### フェーズ3: 段階的移行（2週間）
- 優先度の高い副作用から移行
- テストの同時更新
- 動作確認の徹底

### フェーズ4: 注入システム構築（1週間）
- DIコンテナの実装検討
- main.rsでの統合
- 設定管理との連携

## 成功指標
- Infrastructure層外の副作用: 0件
- モックabilityスコア: 100%
- テストカバレッジ向上: +20%
- 結合度の低減: 測定可能な改善

## 実装例
```rust
// Before: ドメイン層での直接的な副作用
impl User {
    pub fn save(&self) -> Result<()> {
        std::fs::write("users.json", serde_json::to_string(self)?)?;
        Ok(())
    }
}

// After: 副作用の分離
// Domain層
impl User {
    pub fn to_persistence_model(&self) -> UserPersistence {
        // 純粋な変換のみ
    }
}

// Infrastructure層
impl UserRepository {
    pub fn save(&self, user: &User) -> Result<()> {
        let model = user.to_persistence_model();
        self.storage.write("users.json", &model)?;
        Ok(())
    }
}
```

## リスクと対策
- リスク: 大規模なリファクタリングによる不具合
- 対策: Feature Flag、段階的移行、包括的テスト

## 関連計画
- 202507011551_00003_依存性注入パターン導入計画.md
- 202507011551_00011_アーキテクチャ簡素化計画.md