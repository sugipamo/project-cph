# 共通ユーティリティ

## 概要
各層から利用される共通機能とユーティリティ。純粋関数と設定管理を提供し、副作用を持たない実装を原則とする。

## 含まれるファイル

### 設定管理
- **configuration.md** - 型安全な統一設定管理
  - マルチレイヤー設定マージ
  - 依存性注入のセットアップ
  - ランタイム設定オーバーレイ
  - 環境変数との統合
  - **設定解決機能**:
    - `ConfigResolver`: ConfigNodeベースの設定値解決エンジン（BFS、マッチランク、エイリアス機能）
    - `ConfigurationRepository`: 設定データの永続化レイヤー（SQLite、前回実行値管理）
    - `SystemConfigLoader`: SQLiteベースのシステム設定管理（実行コンテキスト、言語設定）
    - `SystemConfigRepository`: システム設定のSQLiteリポジトリ実装
  - **依存性注入管理**:
    - `DIConfig`: プロダクション・テスト環境の依存関係定義
    - `BuildInfrastructure`: DIContainerの構築とセットアップ
  - **実行環境管理**:
    - `EnvironmentManager`: ローカル・Docker環境の統一インターフェース
    - `ExecutionPaths`: 実行時パス情報の集約
    - `OutputConfig`: 出力設定の管理
  - **ランタイム設定**:
    - `RuntimeConfigOverlay`: 実行時設定オーバーレイシステム
    - `DebugConfigProvider`: デバッグモード専用設定プロバイダー

### 汎用ユーティリティ
- **utils.md** - 純粋なユーティリティ関数群
  - パス処理とバリデーション
  - Docker関連ユーティリティ
  - リトライ機構
  - プラットフォーム抽象化
  - 文字列処理とフォーマット
  - **データ処理ユーティリティ**:
    - `filter_and_transform_items()`: リストのフィルタリングと変換
    - `group_items_by_key()`: キーによるグループ化
    - `merge_dictionaries()`: 辞書のマージ（CLAUDE.mdルール準拠）

### 設定検証ユーティリティ
- **config_validation_utils.rs** - 設定関連のバリデーションと取得
  - `get_steps_from_resolver()`: ConfigResolverから言語・コマンドタイプに対応するstepsを取得
  - 設定ノードの配列処理とソート機能
  - エラーハンドリングとメッセージ生成

### Dockerユーティリティ
- **docker_path_ops.py** - Docker特化のパス操作
  - `should_build_custom_docker_image()`: イメージがローカルビルド対象かレジストリプル対象かを判定
  - `convert_path_to_docker_mount()`: ホストパスをDockerマウントパスに変換
  - `get_docker_mount_path_from_config()`: 設定からマウントパスを取得
  - 静的メソッドのみで構成、純粋関数として設計

- **docker_utils.py** - Docker操作の汎用ユーティリティ
  - `DockerUtils`: Docker操作ユーティリティクラス
  - `build_docker_cmd()`: Dockerコマンドの構築
  - `parse_image_tag()`: イメージ名とタグの分離
  - `format_container_name()`: コンテナ名のフォーマット
  - `validate_image_name()`: イメージ名の妥当性検証
  - `validate_docker_image_name()`関数で後方互換性を維持

### 実行検証ユーティリティ
- **execution_validation_utils.py** - 実行コンテキストのバリデーション
  - `validate_execution_context_data()`: ExecutionContextの基本バリデーション
  - 必須フィールドの存在チェック
  - 環境設定ファイルの検証
  - 純粋関数として設計、タプル形式で結果とエラーメッセージを返却

### フォーマット情報
- **format_info.py** - ログフォーマット情報の管理
  - `FormatInfo`: カラー、太字、インデント情報の保持
  - フォーマットタイプに応じた文字列変換
  - ANSI エスケープシーケンスの除去
  - 辞書型との相互変換

### 正規表現プロバイダー
- **regex_provider.py** / **mock_regex_provider.py** - 正規表現操作の抽象化
  - 設計パターン: Strategy Pattern + Dependency Injection
  - 正規表現パターンのコンパイル
  - 検索、置換、マッチング処理
  - `MockRegexProvider`: テスト用モック実装
  - `RegexInterface`を実装

### パス操作
- **path_operations.py** - ファイルパス操作の統合機能
  - `PathOperations`: パス操作クラス
  - パス解決とnormalization
  - 安全なパス結合
  - 相対パス取得
  - サブディレクトリ判定
  - ファイル拡張子操作
  - 依存性注入でconfig_providerを受け取り
  - strict mode対応（Result型 vs 例外ベース）
  - 互換性維持のコメント記載

### Python実行ユーティリティ
- **python_utils.py** - Python実行関連のユーティリティ
  - `PythonUtils`: Python実行ユーティリティクラス
  - スクリプトファイルの実行
  - コード文字列の実行
  - Pythonインタープリター管理
  - エラーコード変換
  - フォールバック処理禁止の実装
  - 設定必須の強制
  - 適切な例外型の使用

### リトライ機構
- **retry_decorator.py** - リトライ機構の提供
  - `RetryConfig`, `RetryableOperation`: リトライ設定と操作
  - 指数バックオフによるリトライ実装
  - Result型ベースのエラーハンドリング
  - 設定可能なリトライ条件
  - 事前定義された設定（NETWORK_RETRY_CONFIG等）
  - 例外ベースとResult型ベースの両方をサポート

### シェルユーティリティ
- **shell_utils.py** - シェルコマンド実行のユーティリティ
  - `ShellUtils`: シェル実行ユーティリティクラス
  - サブプロセス実行（同期/非同期）
  - インタラクティブプロセス管理
  - タイムアウト制御
  - 出力キューイング
  - 静的メソッドのみで構成

### システムプロバイダー
- **sys_provider.py** - sysモジュールの副作用抽象化
  - 設計パターン: Abstract Factory Pattern
  - `SysProvider` (抽象基底クラス)
  - `SystemSysProvider` (実装)
  - `MockSysProvider` (テスト用)
  - コマンドライン引数取得
  - プログラム終了制御
  - プラットフォーム情報取得
  - 標準出力操作

### 時間アダプター
- **time_adapter.py** - TimeProviderとTimeInterfaceの橋渡し
  - 設計パターン: Adapter Pattern
  - 現在時刻取得
  - スリープ機能
  - インフラストラクチャ層とオペレーション層の結合

## 依存関係とデータフロー

### 内部依存関係
```
utils → configuration (config_validation_utils)
utils → application (format_info)
utils → logging (format_info)
utils → operations (path_operations, retry_decorator)
utils → infrastructure (time_adapter)
```

### 外部依存関係
- **標準ライブラリ**: os, pathlib, subprocess, re, time, contextlib, io
- **サードパーティ**: なし（標準ライブラリのみ使用）

### データフロー
1. **設定データ** → config_validation_utils → バリデーション済み設定
2. **パス情報** → path_operations → 正規化済みパス
3. **Docker設定** → docker_utils → 構築済みコマンド
4. **実行コンテキスト** → execution_validation_utils → バリデーション結果
5. **外部プロセス** → shell_utils → 実行結果

## 設計パターンと実装方針

### 採用されている設計パターン
1. **Strategy Pattern**: RegexProvider/MockRegexProvider
2. **Abstract Factory Pattern**: SysProvider系
3. **Adapter Pattern**: TimeAdapter
4. **Dependency Injection**: PathOperations, PythonUtils
5. **Builder Pattern**: DockerUtils.build_docker_cmd

### 実装方針
1. **純粋関数優先**: 副作用を持たない関数を中心に設計
2. **依存性注入**: 外部依存をコンストラクタで注入
3. **インターフェース分離**: 機能ごとに明確なインターフェースを定義
4. **エラーハンドリング統一**: Result型と例外ベースの両方をサポート
5. **テスタビリティ**: モッククラスの提供

### アーキテクチャ原則の遵守
- **フォールバック処理禁止**: 明示的な設定を要求
- **デフォルト値禁止**: 引数にデフォルト値を設定しない
- **副作用の局所化**: infrastructure層のみに副作用を限定
- **互換性維持**: 既存インターフェースの保持

## 注意事項とメンテナンス要点

### 設計上の注意点
- **循環依存の回避**: 特にconfiguration層との相互依存に注意
- **純粋関数の維持**: 副作用を持つ処理はinfrastructure層に委譲
- **インターフェース安定性**: 既存のAPIを破壊しないよう慎重に変更

### パフォーマンス考慮事項
- **ファイルパス操作**: 大量のパス処理時は結果のキャッシュを検討
- **リトライ処理**: 適切なタイムアウトとバックオフ設定が必要
- **正規表現**: パターンのコンパイル結果をキャッシュ

### セキュリティ要点
- **パス操作**: パストラバーサル攻撃の防止
- **コマンド実行**: インジェクション攻撃の防止
- **Docker操作**: 不正なイメージ名の検証

### テスト戦略
- **単体テスト**: 各ユーティリティ関数の境界値テスト
- **統合テスト**: 依存性注入されたコンポーネントとの連携テスト
- **モックテスト**: 外部依存を持つ処理のモック化

### 将来の拡張ポイント
- **新しいプラットフォーム対応**: SysProviderの拡張
- **追加のリトライ戦略**: RetryConfigの設定パターン追加
- **パフォーマンス最適化**: キャッシュ機構の導入
- **ログ強化**: より詳細なデバッグ情報の提供

### 依存関係管理
- **上位層への依存**: configuration, application層への依存は最小限に
- **インターフェース使用**: 具象クラスではなくインターフェースに依存
- **循環依存監視**: 定期的な依存関係チェックの実施

## 設計原則
- 副作用を持たない純粋関数
- 高い再利用性
- テスト容易性
- 型安全性の確保