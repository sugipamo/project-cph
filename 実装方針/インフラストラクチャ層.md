# インフラストラクチャ層

## 概要
外部システムとの統合と副作用を管理する層。すべての副作用はこの層に集約される。

## 含まれるファイル

### 統合管理
- **infrastructure.md** - すべての副作用と外部システム統合の集約
  - Dockerプロバイダー
  - ファイルシステムプロバイダー
  - データベースプロバイダー
  - 依存性注入によるドライバー管理

### DIコンテナと依存性注入
- **di_container.py** - 依存性注入コンテナの実装
  - `DIContainer`: 依存関係の登録と解決
  - `DIKey`: 依存関係の識別子定義（Enum）
  - プロバイダー登録・解決機能
  - オーバーライド機能（テスト用）
  - 自動依存関係解決

### プロバイダー層（副作用集約）
- **file_provider.py** - ファイルシステム操作
  - `SystemFileProvider`: 実際のファイルシステム操作
  - `MockFileProvider`: テスト用モック実装
  - ファイル読み書き、ディレクトリ作成、存在チェック

- **json_provider.py** - JSON操作
  - `SystemJsonProvider`: JSON操作の実装
  - `MockJsonProvider`: テスト用モック実装
  - JSON シリアライゼーション・デシリアライゼーション

- **os_provider.py** - OS操作
  - `SystemOsProvider`: OS操作の実装
  - `MockOsProvider`: テスト用モック実装
  - パス操作、ディレクトリ操作、現在ディレクトリ取得

- **sqlite_provider.py** - SQLite操作
  - `SystemSQLiteProvider`: SQLite操作の実装
  - `MockSQLiteProvider`: テスト用モック実装
  - データベース接続、SQL実行、トランザクション管理

- **time_provider.py** - 時刻操作
  - `SystemTimeProvider`: 時刻操作の実装
  - `MockTimeProvider`: テスト用モック実装
  - 現在時刻取得、待機処理

- **registry_provider.py** - レジストリ管理
  - `SystemRegistryProvider`: レジストリ管理の実装
  - `MockRegistryProvider`: テスト用モック実装
  - グローバル状態管理、レジストリ操作

### ドライバー層
- **drivers/generic/base_driver.py** - 基底ドライバー実装
  - `ExecutionDriverInterface`: 全ドライバーの抽象基底クラス
  - `BaseDriverImplementation`: 共通機能を持つベース実装
  - `DriverUtils`: ドライバー用ユーティリティ関数
  - 設定ファイル読み込み（infrastructure_defaults.json）
  - ログ機能統合、パスバリデーション

- **drivers/generic/execution_driver.py** - シェル・Python実行
  - `ExecutionDriver`: シェル・Python実行の統一ドライバー
  - シェルコマンド実行、Pythonコード・スクリプト実行
  - 権限変更（chmod）、コマンド可用性チェック

- **drivers/generic/persistence_driver.py** - 永続化操作
  - `PersistenceDriver`: 永続化操作の抽象基底クラス
  - `SQLitePersistenceDriver`: SQLite永続化の実装
  - データベース接続管理、クエリ実行、リポジトリ管理

- **drivers/generic/unified_driver.py** - 統一ドライバー
  - `UnifiedDriver`: 全ドライバーを統合する統一ドライバー
  - リクエストタイプに基づくルーティング
  - Docker、ファイル、シェル、Python操作の統一インターフェース
  - 結果オブジェクトの変換

- **drivers/file/file_driver.py** - ファイル操作
  - `FileDriver`: ファイルシステム操作の統一ドライバー
  - ファイル・ディレクトリ操作（作成、削除、移動、コピー）
  - パス解決・存在チェック、Globパターンマッチング
  - ファイルハッシュ計算、Docker cp操作

- **drivers/docker/docker_driver.py** - Docker操作
  - `DockerDriver`: Docker操作の統一ドライバー
  - コンテナ操作（実行、停止、削除）
  - イメージビルド、ログ取得、コンテナ一覧
  - トラッキング機能（オプション）、コマンドビルド機能

### その他のコンポーネント
- **ast_analyzer.py** - Pythonコード解析
  - `ASTAnalyzer`: Pythonコード解析機能
  - `ImportInfo`: インポート情報のデータクラス
  - ソースコード解析、インポート・エクスポート情報抽出
  - 壊れたインポート検出

- **module_info.py** - モジュール情報管理
  - `ModuleInfo`: モジュール情報のデータクラス
  - `ExportedSymbol`: エクスポートシンボル情報
  - モジュールメタデータ管理

- **docker_naming_provider.py** - Docker命名規則
  - `DockerNamingProvider`: Docker命名規則プロバイダー
  - イメージ・コンテナ名の標準化生成

- **local_filesystem.py** - ローカルファイルシステム
  - `LocalFileSystem`: ローカルファイルシステムの実装
  - FileSystemInterfaceの実装

- **persistence_exceptions.py** - 永続化例外
  - 永続化操作専用の例外クラス群
  - `PersistenceError`: 基底例外
  - `ConnectionError`, `MigrationError`, `QueryError`等: 特定操作用例外

### 永続化コンポーネント
- **persistence/state/models/session_context.py** - セッション状態
  - `SessionContext`: セッション状態のデータモデル
  - 現在のコンテスト・問題・言語情報管理

- **persistence/sqlite/migrations/** - データベース移行
  - データベース移行スクリプト群
  - 001_initial.sql: 初期テーブル作成
  - 002_docker_tracking.sql: Dockerトラッキング機能
  - 003_nullable_config_values.sql: NULL対応設定値
  - 004, 006: コンテスト関連ファイル管理

- **requests/file/file_op_type.py** - ファイル操作タイプ
  - `FileOpType`: ファイル操作タイプの列挙

### データ永続化
- **data.md** - SQLiteを使用したリポジトリパターンの実装
  - コンテナ、イメージ、操作、セッションの永続化
  - トランザクション管理
  - マイグレーション
  - **リポジトリ実装詳細**:
    - `DatabaseRepositoryFoundation`: データベースリポジトリの共通基盤
    - `DockerContainerRepository`: コンテナレコードのCRUD操作、状態管理、ライフサイクルイベント
    - `DockerImageRepository`: イメージレコードのCRUD操作、ビルド結果更新、統計情報
    - `OperationRepository`: 操作履歴の永続化、統計生成、成功率計算
    - `SessionRepository`: セッションCRUD操作、アクティブセッション管理、平均作業時間計算
    - `StateRepository`: 実行履歴永続化、セッションコンテキスト管理、ユーザー指定値管理
    - `SQLiteStateRepository`: SystemConfigRepositoryを活用したJSON形式での状態管理

### ロギング
- **logging.md** - 統一されたロギング機能
  - シンプル/アドバンスド実装
  - フォーマットオプション
  - 構造化エラートラッキング
  - **実装詳細**:
    - `LogLevel(IntEnum)`: ログレベル定義（10-50の数値）
    - `BaseLogEntry`: ログエントリの基本構造（dataclass）
    - `LogEntry`: FormatInfo対応のログエントリ
    - `ApplicationLoggerAdapter`: LoggerInterfaceの基本実装
    - `UnifiedLogger`: 包括的なログ機能（アイコン、ワークフロー専用メソッド）

## 依存関係とデータフロー

### 主要な依存関係
1. **外向き依存**: 外部システム（ファイルシステム、データベース、Docker、OS）
2. **内向き依存**: Domain層・Application層のインターフェース
3. **DIコンテナ**: 全コンポーネントの依存関係を管理

### データフロー
```
Application層 → DIContainer → Infrastructure Driver → Provider → 外部システム
                    ↓
            設定ファイル読み込み
                    ↓
         infrastructure_defaults.json
```

### 主要なパターン
1. **Provider Pattern**: 副作用をProviderクラスに集約
2. **Driver Pattern**: 統一インターフェースで複数操作を提供
3. **Dependency Injection**: DIコンテナによる依存関係管理
4. **Mock Pattern**: テスト用Mock実装を全Providerで提供

## 設計パターンと実装方針

### 副作用の分離
- 全ての副作用的操作をInfrastructure層に集約
- SystemXxxProvider: 実際の副作用を持つ実装
- MockXxxProvider: 副作用なしのテスト実装

### 抽象化とテスタビリティ
- 抽象インターフェースによる実装の隠蔽
- モック実装による単体テストサポート
- 依存性注入による疎結合設計

### 統一ドライバーパターン
- UnifiedDriver: 全操作の統一エントリーポイント
- 専門ドライバー: 特定技術領域の詳細実装
- BaseDriver: 共通機能の提供

### 設定駆動設計
- infrastructure_defaults.json: インフラ設定の外部化
- デフォルト値の一元管理
- 実行時設定注入

### エラーハンドリング
- 専用例外クラス（persistence_exceptions.py）
- 操作固有のエラー情報
- フォールバック処理の明示的禁止

## 注意事項とメンテナンス要点

### 副作用の管理
- **重要**: 副作用は必ずInfrastructure層のProviderクラスに集約する
- main.pyからの依存性注入で副作用を制御
- テスト時はMockProviderを使用して副作用を排除

### 設定値管理
- **禁止事項**: デフォルト値の直接使用
- 設定は infrastructure_defaults.json または専用設定ファイルから取得
- 存在しない設定は適切な例外を発生させる

### 互換性維持
- 既存インターフェースの変更時は互換性コメントを追記
- hasattr()によるgetattr()デフォルト値の代替使用
- レガシーコードとの互換性を考慮した実装

### テスト戦略
- 全Providerにモック実装を提供
- DIコンテナのオーバーライド機能を活用
- 副作用なしでの単体テスト実施

### エラーハンドリング
- フォールバック処理は明示的に禁止
- 具体的で有用なエラーメッセージの提供
- 操作固有の例外クラス使用

### 拡張性
- 新しい外部システム統合時はProvider+Driverパターンを踏襲
- DIKeyへの新しい依存関係追加
- 既存パターンとの一貫性維持

### パフォーマンス
- 設定値のキャッシュ機能活用
- 遅延初期化（Lazy Loading）の実装
- リソースの適切なクリーンアップ

## 設計原則
- すべての副作用をsrc/infrastructureに集約
- main.pyからの依存性注入
- インターフェースによる抽象化
- テスト可能性のためのモック実装