# 統合ロギングシステム実装計画

## 概要
old_srcのinfrastructure/drivers/logging/に実装されている統合ロギングシステムをRustに移植する計画。

## 背景と目的
- **現状**: 現在のRustプロジェクトは基本的なtracing実装のみ
- **old_srcの実装**: カラー管理、出力レベル制御、モック機能を持つ統合ロガー
- **目的**: デバッグ効率の向上と、ユーザーフレンドリーな出力の実現

## 実装すべき機能

### 1. 階層的なロギング
- アプリケーションログとワークフローログの分離
- コンテキスト情報の付与
- 構造化ログの出力

### 2. 出力制御
- ログレベルによるフィルタリング
- 出力先の切り替え（標準出力、ファイル、メモリ）
- リアルタイム出力とバッファリング

### 3. フォーマッティング
- カラー出力のサポート
- プログレスバーとスピナー
- テーブル形式の出力
- JSON形式の構造化ログ

### 4. テスト支援
- ログ出力のキャプチャ
- モックロガーの提供
- アサーション用のユーティリティ

## 実装方針

### ディレクトリ構造
```
src/infrastructure/logging/
├── mod.rs
├── logger.rs         # ロガー実装
├── formatter.rs      # フォーマッター
├── color.rs         # カラー管理
├── progress.rs      # プログレス表示
├── mock.rs          # モック実装
└── types.rs         # 型定義
```

### 主要な型定義
```rust
// ロガートレイト
trait Logger: Send + Sync {
    fn log(&self, level: LogLevel, message: &str, context: Option<&Context>);
    fn log_structured(&self, event: LogEvent);
    fn start_progress(&self, total: usize) -> ProgressHandle;
}

// ログイベント
#[derive(Serialize)]
struct LogEvent {
    timestamp: DateTime<Utc>,
    level: LogLevel,
    message: String,
    context: HashMap<String, Value>,
    source: Option<String>,
}

// プログレスハンドル
struct ProgressHandle {
    // 実装詳細
}
```

## 技術選定
- **tracing**: 構造化ログとスパン
- **tracing-subscriber**: カスタムサブスクライバー
- **indicatif**: プログレスバーとスピナー
- **termcolor**: ターミナルカラー出力
- **serde_json**: JSON形式の出力

## 実装の詳細

### 1. レイヤーアーキテクチャ
```rust
// カスタムレイヤーの実装
struct CPHLayer {
    color_manager: ColorManager,
    output_manager: OutputManager,
}

impl<S> Layer<S> for CPHLayer
where
    S: Subscriber,
{
    // レイヤー実装
}
```

### 2. コンテキスト管理
```rust
// スパンを使用したコンテキスト
#[instrument(skip(self))]
async fn execute_workflow(&self, workflow: Workflow) {
    info!("Starting workflow execution");
    // 処理
}
```

### 3. 出力の統一
```rust
// 統一的な出力インターフェース
trait OutputManager {
    fn print(&self, output: Output);
    fn print_table(&self, table: Table);
    fn print_error(&self, error: &Error);
}
```

## ユーザビリティの向上

### 1. インタラクティブな出力
- 実行中のステップの可視化
- エラー時の詳細な情報表示
- サジェスチョンの提供

### 2. デバッグ支援
- RUST_LOG環境変数によるフィルタリング
- --verboseオプションによる詳細出力
- タイムスタンプとソースロケーション

## 期待される効果
1. デバッグ効率の大幅な向上
2. ユーザーエクスペリエンスの改善
3. 問題の迅速な特定と解決
4. テストの信頼性向上

## 実装優先度
**高**: すべての機能で使用される基盤機能であり、開発効率に直結するため