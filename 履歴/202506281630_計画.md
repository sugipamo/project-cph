# CPHプロジェクト 実行計画書
作成日時: 2025-06-28 16:30

## 1. 現状分析

### プロジェクト概要
- **プロジェクト名**: CPH (Competitive Programming Helper)
- **目的**: 競技プログラミング環境の統一と自動化ツール
- **理念**: プログラマーと問題解決の間の障壁を排除し、純粋にコーディングに集中できる環境を提供
- **現在のブランチ**: feature/dependency-reorganization

### 技術的現状
1. **アーキテクチャ**: Clean Architecture採用
   - presentation層: CLI/UI
   - application層: ビジネスロジック
   - domain層: ドメインモデル
   - infrastructure層: 外部依存（Docker、ファイルシステム、DB）
   - configuration層: 設定管理

2. **テスト状況**
   - 全テスト: 757 passed, 12 skipped
   - カバレッジ: 59%（目標80%）
   - カバレッジ0%のモジュール: 14ファイル

3. **CLAUDE.md違反状況**
   - デフォルト値使用: 200箇所以上
   - 副作用の不適切な配置: infrastructure層以外の9モジュールに存在
   - 引数のデフォルト値指定: 多数のファイルで違反

### 前回作業の成果（16:05実施）
- di_config.pyのハードコード除去完了
- テストエラーの完全解消
- 基本的なテストの追加（4ファイル）

## 2. 優先課題の整理

### 最優先課題（CLAUDE.md準拠）
1. **デフォルト値の完全除去**
   - src/配下すべてのファイルで引数のデフォルト値を除去
   - 設定はdefault_arguments.jsonから取得
   - 呼び出し元で明示的に値を指定

2. **副作用のinfrastructure層への集約**
   - Database操作
   - File I/O操作  
   - Subprocess実行
   - すべてmain.pyから注入

3. **中長期視点での実装**
   - 短期的な解決を避ける
   - 適切な責務配置の確認

### 重要課題（機能要件）
1. **基本ワークフロー実装の確認**
   - `cph new [URL]`: 問題取得と環境準備
   - `cph test`: 並列テスト実行
   - `cph submit`: 提出前チェックと形式変換

2. **パフォーマンス要件の確保**
   - 即応コマンド（< 1秒）: new, history, clean
   - 実行タイムアウト: 6秒（デフォルト）

## 3. 実行計画

### フェーズ1: CLAUDE.md違反の集中対応（2時間）

#### 1.1 コアモジュールのデフォルト値除去（優先度: 最高）
対象ファイル（影響範囲が大きい順）:
1. `src/domain/workflow.py`
2. `src/domain/step_runner.py`
3. `src/application/contest_manager.py`
4. `src/application/config_manager.py`
5. `src/infrastructure/di_container.py`

作業内容:
- 各ファイルのすべての関数・メソッドからデフォルト引数を除去
- 必要な設定をdefault_arguments.jsonに追加
- 呼び出し元での明示的な値指定

#### 1.2 副作用の移動（優先度: 高）
対象:
- application層のDatabase操作 → infrastructure層へ
- domain層のFile I/O → infrastructure層へ
- 各層のSubprocess実行 → infrastructure層へ

### フェーズ2: テストカバレッジ向上（1時間）

#### 2.1 プレゼンテーション層のテスト（0%カバレッジ対応）
- `src/presentation/cli_app.py`
- `src/presentation/main.py`
- `src/presentation/user_input_parser.py`

#### 2.2 重要ユーティリティのテスト
- `src/utils/path_operations.py`（168行）
- `src/utils/retry_decorator.py`（84行）

### フェーズ3: 機能確認と統合（30分）

#### 3.1 基本ワークフローの動作確認
- `cph new`コマンドの実行テスト
- `cph test`の並列実行確認
- `cph submit`の形式変換確認

#### 3.2 設定管理の統合確認
- default_arguments.jsonの完全性
- 設定の優先順位（user > project > global）

## 4. 実装方針

### CLAUDE.md準拠の徹底
1. **デフォルト値除去の手順**
   ```python
   # Before
   def method(arg1, arg2="default"):
       pass
   
   # After
   def method(arg1, arg2):
       pass
   # 呼び出し元で設定から取得して明示的に指定
   ```

2. **副作用の集約**
   ```python
   # infrastructure層に実装を移動
   # main.pyから依存性注入
   ```

3. **エラーハンドリング**
   - フォールバック処理禁止
   - 明示的なエラー通知

### 品質基準
- テストカバレッジ: 70%以上（最終目標80%）
- すべてのテストが成功
- CLAUDE.md完全準拠

## 5. リスク管理

### リスク
1. 大規模なデフォルト値除去による既存機能の破壊
2. 副作用移動によるアーキテクチャの複雑化
3. 時間制約による不完全な実装

### 対策
1. 段階的な変更と都度のテスト実行
2. 重要な変更前のgit状態確認
3. 優先順位に基づく着実な実装

## 6. 成功基準

### 今回の作業（16:30-19:00）
- [ ] コアモジュール5ファイルのCLAUDE.md完全準拠
- [ ] 副作用の50%以上をinfrastructure層へ移動
- [ ] テストカバレッジ65%達成
- [ ] 基本ワークフローの動作確認

### チェックポイント
- 17:30: フェーズ1完了確認
- 18:30: フェーズ2完了確認
- 19:00: 全体確認と結果報告

## 7. 次回への申し送り事項
- 残存するデフォルト値の一覧
- 未移動の副作用の詳細
- テストカバレッジ改善の優先順位