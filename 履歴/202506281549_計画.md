# CPH プロジェクト実行計画
## 作成日時: 2025-06-28 15:49

## 1. 現状分析サマリー

### プロジェクト概要
- **プロジェクト名**: CPH (Competitive Programming Helper)  
- **目的**: 競技プログラミング環境の統一と自動化
- **理念**: 競技プログラマーが問題解決に集中できる環境を提供
- **アーキテクチャ**: Clean Architecture (過度に複雑化している状態)
- **対応言語**: Python, C++, Rust
- **現在のブランチ**: feature/dependency-reorganization

### 技術スタック
- Python 3.8+
- Docker (実行環境の統一)
- SQLite (実行履歴管理)
- pytest (テスト)
- 138個のPythonファイル (src/配下)

### 前回作業からの状況
1. **テスト状態**: 757個のテストが全てパス (前回修正済み)
2. **テストカバレッジ**: 59% (目標70%未満)
3. **残存課題**:
   - カバレッジ0%のモジュールが複数存在
   - CLAUDE.md準拠違反 (デフォルト値、副作用の配置等)
   - アーキテクチャの過度な複雑性
   - 短期的解決による技術的負債

### CLAUDE.md違反の主要な問題
1. **デフォルト値の使用** (厳格に禁止されている)
2. **副作用がinfrastructure以外に存在**
3. **短期的解決の蓄積**
4. **フォールバック処理の存在**

## 2. 実行計画

### フェーズ1: CLAUDE.md準拠の徹底 (優先度: 最高)

#### 1.1 デフォルト値の完全除去
- 全モジュールのデフォルト引数をスキャン
- 呼び出し元での明示的な値指定に変更
- 設定ファイル経由での値取得に統一

#### 1.2 副作用の適切な配置
- infrastructure層以外の副作用を特定
- main.pyからの注入パターンに統一
- ファイルI/O、DB操作等の副作用を移動

#### 1.3 フォールバック処理の除去
- エラーを隠蔽する処理の特定と除去
- 明示的なエラーハンドリングへの変更

### フェーズ2: テストカバレッジの向上 (優先度: 高)

#### 2.1 カバレッジ0%モジュールの対応
最優先対象:
- `config_validation_utils.py`
- `docker_path_ops.py`
- `docker_utils.py`
- `execution_validation_utils.py`
- `path_operations.py`

#### 2.2 低カバレッジモジュールの改善
- `fast_sqlite_manager.py` (23% → 70%以上)
- `configuration_repository.py` (24% → 70%以上)
- `unified_logger.py` (25% → 70%以上)

### フェーズ3: アーキテクチャの簡素化 (優先度: 中)

#### 3.1 ドライバー層の統合
- UnifiedDriverとPersistenceDriverの重複解消
- 過度な抽象化の除去
- 実用性重視の設計への変更

#### 3.2 依存関係の整理
- 循環依存の完全除去
- 遅延インポートの解消
- 明確な依存方向の確立

### フェーズ4: 長期的視点での改善 (優先度: 中)

#### 4.1 責務の再配置
- 各モジュールの責務を明確化
- 凝集度の向上
- 結合度の低減

#### 4.2 拡張性の確保
- プラグイン機構の適切な実装
- 新言語追加時の影響範囲最小化

## 3. 実行手順と成果物

### ステップ1: 現状調査 (30分)
1. デフォルト値使用箇所の網羅的調査
2. 副作用の配置状況調査
3. テストカバレッジ詳細分析

### ステップ2: CLAUDE.md違反修正 (90分)
1. デフォルト値の除去と設定ファイル化
2. 副作用のinfrastructure層への移動
3. フォールバック処理の除去

### ステップ3: テスト追加 (60分)
1. カバレッジ0%モジュールのテスト作成
2. 重要モジュールのテスト強化
3. カバレッジレポートの生成

### ステップ4: 結果検証 (30分)
1. 全テストの実行と確認
2. CLAUDE.md準拠の検証
3. カバレッジ目標達成の確認

## 4. 成功基準

- [ ] CLAUDE.md違反の完全解消
  - [ ] デフォルト値の使用: 0件
  - [ ] infrastructure以外の副作用: 0件
  - [ ] フォールバック処理: 0件
- [ ] テストカバレッジ70%以上達成
- [ ] 全テスト(757個)のパス維持
- [ ] 長期的視点での設計改善

## 5. リスクと対策

### リスク1: 大規模な変更による既存機能への影響
- **対策**: 段階的な変更と継続的なテスト実行

### リスク2: 設定ファイル追加による複雑性増加
- **対策**: 明確な命名規則と構造化された設定体系

### リスク3: 時間内での完了困難
- **対策**: 優先度に基づく実行、残タスクの明確な記録

## 6. 注意事項

1. **CLAUDE.mdの厳格な遵守**
   - 短期的解決は一切行わない
   - 中長期を見据えた実装のみ許可
   - 指示が曖昧な場合は必ず確認

2. **品質管理の徹底**
   - src_check/とsrc/の明確な分離維持
   - テスト駆動での開発
   - コードレビューの視点での実装

3. **透明性の確保**
   - 全ての変更を明確に記録
   - 問題点の隠蔽は行わない
   - 技術的負債は正直に報告