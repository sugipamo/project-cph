# 202506281047_計画

## 実行日時
2025-06-28 10:47

## プロジェクト概要
**CPH (Competitive Programming Helper)** - 競技プログラミング環境統一ツール

### プロジェクトの現状
- **ブランチ**: feature/dependency-reorganization
- **直近の作業**: 循環インポート特定と依存グラフ可視化、Domain層テスト追加
- **アーキテクチャ**: Clean Architecture 7層構造（再編成中）
- **テスト状況**: 523個のテスト中、実行エラー発生中

### プロジェクトのビジョン（要件定義より）
- **理念**: 競技プログラマーが本質的な問題解決に集中できる環境の提供
- **差別化**: JSONによる柔軟なコマンド実行設定
- **対象**: 初心者から上級者まで、多言語対応（Python, C++, Rust）

## 現状の詳細分析

### アーキテクチャの状態
1. **層構成と問題点**
   - 7層のClean Architecture実装
   - レイヤー間の依存違反が多数存在
   - 循環インポート2箇所、遅延インポートで対処中
   - Infrastructure層が上位層に依存（依存逆転の原則違反）

2. **ファイル構成**
   - src/配下に134ファイル（過度な分割）
   - 高結合モジュール: main, di_container, di_config
   - 新機能追加時に5-8ファイルの編集が必要

3. **依存関係の複雑性**
   - TYPE_CHECKING依存が複数存在
   - DIコンテナの初期化順序問題
   - インターフェース定義の不整合

### テストの状態
1. **カバレッジ状況**
   - 全体カバレッジ: 約20%（目標80%）
   - テスト総数: 523個
   - 実行エラー: MockOutputManagerのテストで失敗

2. **テストの品質**
   - Domain層の単体テスト不足
   - E2Eテストが未整備
   - モックの過度な使用による脆弱性

### 技術的負債
1. **プロジェクト再生宣言（2025/06/25）の課題**
   - 75ディレクトリから134ファイルへの分散
   - 過度な抽象化による開発者疲弊
   - 理論的完璧性の追求による実用性の犠牲

2. **CLAUDE.md違反の懸念**
   - デフォルト値の使用が残存
   - 短期的解決の痕跡（遅延インポート）
   - 中長期的視点の欠如

## 本日の作業計画

### 優先度1: テスト実行環境の修復（1時間）
1. **失敗テストの修正**
   - MockOutputManagerのテスト失敗原因調査
   - 全テストの正常実行確保
   - テスト実行時間の計測

2. **テストカバレッジの確認**
   - pytest-covによる正確なカバレッジ測定
   - カバレッジレポートの生成
   - 優先改善箇所の特定

### 優先度2: 循環インポートの解消（2時間）
1. **遅延インポートの解消**
   - user_input_parser.py:423のDockerNamingProvider
   - main.py:41のRequestFactory
   - 適切な依存注入への変更

2. **レイヤー依存の修正**
   - Infrastructure → Domain/Operations依存の解消
   - Data → Application依存の解消
   - インターフェース導入による依存逆転

### 優先度3: アーキテクチャの簡素化計画（1時間）
1. **統合候補の特定**
   - 小規模ファイル（50行未満）のリスト作成
   - 機能的に関連の深いモジュール群の特定
   - 統合による影響範囲の評価

2. **段階的統合プラン**
   - Week 1: Driver系統統合（27ファイル→4ファイル）
   - Week 2: Request/Result統合（13ファイル→2ファイル）
   - Week 3: Provider/Adapter統合（47ファイル→1ファイル）

## 成功指標（本日）

### 必須達成項目
1. ✅ 全テストの正常実行（エラー0件）
2. ✅ テストカバレッジの正確な把握
3. ✅ 循環インポート1箇所以上の解消

### 努力目標
1. 📋 アーキテクチャ簡素化の詳細計画書作成
2. 📋 Domain層テスト5個以上の追加
3. 📋 依存グラフの更新と改善

## リスクと対策

### 技術的リスク
- **リスク**: テスト修正による既存機能の破壊
- **対策**: 修正前後での動作確認、段階的な修正

### アーキテクチャリスク
- **リスク**: 循環インポート解消による大規模な変更
- **対策**: 最小限の変更で解消、インターフェース活用

### 時間的リスク
- **リスク**: 作業量が予定を超過
- **対策**: 優先度に基づく作業、必須項目への集中

## 長期的な方向性の再確認

### プロジェクトの目指す姿
1. **実用的なアーキテクチャ**
   - ファイル数: 60-70個（現在の50%）
   - 新機能追加: 2-3ファイルの編集で完結
   - ナビゲーション: 直感的なディレクトリ構造

2. **高品質なコードベース**
   - テストカバレッジ: 80%以上
   - 型安全性: mypy --strict準拠
   - パフォーマンス: 起動100ms以内

3. **優れた開発者体験**
   - セットアップ: 5分以内
   - 学習曲線: 1日で基本習得
   - ドキュメント: 完全な日本語対応

## 次のステップ

### 本日中
1. テスト環境の完全修復
2. 循環インポート最低1箇所の解消
3. 簡素化計画の初版作成

### 今週中
1. 循環インポートの完全解消
2. Driver系統の統合開始
3. Domain層テストカバレッジ50%達成

### 今月中
1. ファイル数30%削減
2. 全体テストカバレッジ60%達成
3. ユーザードキュメント完成

## 備考
- 「完璧より実用」の精神を忘れずに
- CLAUDE.mdの遵守を徹底（中長期的視点）
- ユーザー価値（時間創出・ストレス解放・学習効率）を常に意識