# CPH プロジェクト残タスク
## 作成日時: 2025-06-28 16:30

## 1. CLAUDE.md準拠タスク（優先度: 最高）

### 1.1 デフォルト値の完全除去
残り22ファイルのデフォルト値除去が必要：

#### Domain層
- `composite_step_failure.py`: 5箇所
- `workflow_logger_adapter.py`: 3箇所
- `workflow_execution_service.py`: 2箇所

#### Data層
- `state_repository.py`: 1箇所
- `sqlite_state_repository.py`: 1箇所
- `docker_image_repository.py`: 1箇所
- `docker_container_repository.py`: 1箇所

#### Application層
- `execution_results.py`: 3箇所

#### Operations層
- `error_codes.py`: 1箇所
- `interfaces/utility_interfaces.py`: 4箇所
- `interfaces/infrastructure_interfaces.py`: 2箇所
- `results/result_factory.py`: 複数箇所

#### Presentation層
- `cli_app.py`: 2箇所
- `user_input_parser_integration.py`: 2箇所
- `string_formatters.py`: 1箇所
- `docker_command_builder.py`: 2箇所

#### Infrastructure層
- `time_provider.py`: 1箇所
- `persistence_exceptions.py`: 12箇所
- `ast_analyzer.py`: 1箇所
- `sqlite_provider.py`: 1箇所

#### Utils層
- `docker_path_ops.py`: 複数箇所

#### Logging層
- `application_logger_adapter.py`: 1箇所

### 1.2 副作用のinfrastructure層への移動

#### 高優先度（ビジネスロジックに直接影響）
1. **Database操作の移動**
   - `fast_sqlite_manager.py` → infrastructure層へ
   - `sqlite_manager.py` → infrastructure層へ
   - `configuration_repository.py` → infrastructure層へ

2. **File I/O操作の移動**
   - `module_parser.py`: file_path.open() → FileDriverへ
   - `result_factory.py`: open() → FileDriverへ
   - `config_manager.py`: file_provider経由に統一

3. **Subprocess操作の移動**
   - `shell_utils.py` → ExecutionDriverへ統合

#### 中優先度
4. **Print文の除去**
   - `output_manager.py`: print() → logger経由へ

5. **Time操作の抽象化**
   - 各モジュールのdatetime.now() → TimeProviderへ

### 1.3 フォールバック処理の除去

設定ファイル`docker_defaults.json`内の`fallback_handling`セクション：
```json
"fallback_handling": {
    "default_container_name": "default_container",
    "default_stdout_value": "",
    "error_handling": {
        "retry_attempts": 3,
        "retry_delay": 1.0,
        "raise_on_config_error": true
    }
}
```
これらのフォールバック設定を見直し、明示的なエラーハンドリングへ変更。

## 2. テストカバレッジ改善タスク（優先度: 高）

### 2.1 カバレッジ0%モジュール（14ファイル）
最優先で対応すべきモジュール：
1. `config_validation_utils.py`
2. `docker_path_ops.py`
3. `docker_utils.py`
4. `execution_validation_utils.py`
5. `path_operations.py`
6. `retry_decorator.py`
7. `persistence_exceptions.py`
8. `file_provider.py`

### 2.2 低カバレッジモジュール改善
目標: 各モジュール70%以上
1. `fast_sqlite_manager.py`: 23% → 70%
2. `configuration_repository.py`: 24% → 70%
3. `unified_logger.py`: 25% → 70%
4. `python_utils.py`: 27% → 70%
5. `workflow_logger_adapter.py`: 32% → 70%
6. `docker_naming_provider.py`: 35% → 70%

## 3. アーキテクチャ改善タスク（優先度: 中）

### 3.1 ドライバー層の統合
1. UnifiedDriverとPersistenceDriverの機能統合
2. 重複する機能の削除
3. インターフェースの簡素化

### 3.2 依存関係の最適化
1. 循環依存の完全除去（遅延インポートの解消）
2. 依存階層の平坦化
3. 依存性注入パターンの見直し

### 3.3 責務の再配置
1. 各モジュールの責務を単一責任原則に従って整理
2. 凝集度の向上
3. 結合度の低減

## 4. 修正が必要なテスト

### 4.1 即座に修正が必要
1. `test_docker_driver.py`: DockerDriver初期化の修正
2. その他のドライバーテスト: デフォルト値除去に伴う修正

### 4.2 新規作成が必要
1. カバレッジ0%モジュールの単体テスト
2. 統合テストの強化

## 5. 実装推奨順序

### Phase 1（1週間）
1. DockerDriverテストの修正
2. 残りのデフォルト値除去（22ファイル）
3. 最重要モジュールのテスト作成

### Phase 2（2週間）
1. 副作用のinfrastructure層への移動
2. フォールバック処理の除去
3. テストカバレッジ70%達成

### Phase 3（3週間）
1. アーキテクチャの簡素化
2. 依存関係の最適化
3. パフォーマンス改善

### Phase 4（4週間）
1. 完全なCLAUDE.md準拠
2. ドキュメンテーション整備
3. 最終的な品質保証

## 6. リスクと注意事項

### 技術的リスク
1. **大規模変更による不具合**
   - 段階的な変更と継続的テストで対応
   
2. **パフォーマンス劣化**
   - 設定の外部化によるI/O増加に注意
   
3. **複雑性の増加**
   - 設定ファイルの適切な管理が必要

### 組織的リスク
1. **開発速度の一時的低下**
   - 品質向上のための投資として理解を得る
   
2. **学習コストの増加**
   - ドキュメントと例の充実で対応

## 7. 成功指標

- [ ] CLAUDE.md違反: 0件
- [ ] テストカバレッジ: 70%以上
- [ ] 全テスト: グリーン
- [ ] パフォーマンス: 現状維持以上
- [ ] コード品質: 測定可能な改善

これらのタスクを段階的に実施することで、CPHプロジェクトを真に中長期的な視点で設計された、保守性の高いシステムへと進化させることができます。