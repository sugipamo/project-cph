# CPHプロジェクト - Week 2 リファクタリング計画
日時: 2025-06-28 05:26
計画策定者: Claude Code

## 1. 現状分析

### プロジェクト概要
CPH (Competitive Programming Helper) は競技プログラミング環境統一ツールで、以下の価値を提供：
- **多言語対応**: Python, C++, Rust を統一インターフェースで利用
- **環境一貫性**: ローカルとジャッジ環境の差異を解消
- **ワークフロー自動化**: テスト、ビルド、提出プロセスの効率化

### Week 1の成果
- **ドライバー統合完了**: 11ファイル → 4ファイルへ削減（64%削減）
- **ディレクトリ数削減**: 4ディレクトリ → 1ディレクトリ（75%削減）
- **重複ファイル排除**: 4つの重複ファイルを完全に削除
- **テスト成功**: Python/Rustテストが全て通過

### 現在の問題点
1. **Request/Result構造の複雑性**
   - `operations/requests/` に8つのファイルが分散
   - `operations/results/` に7つのファイルが分散
   - 新機能追加時に多数のファイル編集が必要

2. **設定システムの過剰な抽象化**
   - `configuration/` に12ファイル
   - `.get()`メソッドの使用禁止による冗長なコード
   - 型安全性とのトレードオフで複雑性が増大

3. **インターフェースの過剰分離**
   - `operations/interfaces/` に8つのインターフェース
   - 実装との結合が強く、分離の意味が薄い

## 2. Week 2 目標設定

### 主要目標
1. **Request/Result統合**: 15ファイル → 4-5ファイルへ削減
2. **インターフェース簡素化**: 8ファイル → 3-4ファイルへ統合
3. **設定システムの実用性向上**: アクセスパターンの簡素化

### 成功指標
- ファイル数: 30%以上削減
- 新機能追加時の編集ファイル数: 5ファイル以下
- テストカバレッジ: 現状維持または向上
- パフォーマンス: 劣化なし

## 3. 実施計画

### Phase 1: Request構造の統合（Day 1-2）

#### 3.1.1 現状分析
```
operations/requests/
├── __init__.py
├── composite_request.py
├── docker_request.py
├── file_request.py
├── python_request.py
├── request_factory.py
├── request_interfaces.py
├── request_types.py
└── shell_request.py
```

#### 3.1.2 統合方針
```
operations/requests/
├── __init__.py
├── base_request.py      # インターフェースと基底実装
├── execution_requests.py # Shell/Python/Docker統合
├── file_request.py      # ファイル操作（既存維持）
└── request_factory.py   # ファクトリー（既存維持）
```

#### 3.1.3 作業内容
1. `request_interfaces.py` と `request_types.py` を `base_request.py` に統合
2. `shell_request.py`, `python_request.py`, `docker_request.py` を `execution_requests.py` に統合
3. `composite_request.py` の機能を適切な場所に移動
4. インポートパスの更新

### Phase 2: Result構造の統合（Day 2-3）

#### 3.2.1 現状分析
```
operations/results/
├── __init__.py
├── base_result.py
├── check_result.py
├── docker_result.py
├── file_result.py
├── result.py
├── result_factory.py
└── shell_result.py
```

#### 3.2.2 統合方針
```
operations/results/
├── __init__.py
├── base_result.py       # 基底クラスと共通機能
├── execution_results.py # Shell/Python/Docker統合
├── file_result.py       # ファイル操作結果（既存維持）
└── result_factory.py    # ファクトリー（必要に応じて統合）
```

#### 3.2.3 作業内容
1. `shell_result.py`, `docker_result.py`, `check_result.py` を `execution_results.py` に統合
2. `result.py` の汎用機能を `base_result.py` に移動
3. 重複コードの削除と共通化
4. テストの更新

### Phase 3: インターフェース簡素化（Day 3-4）

#### 3.3.1 現状分析
```
operations/interfaces/
├── docker_interface.py
├── execution_interface.py
├── filesystem_interface.py
├── logger_interface.py
├── output_manager_interface.py
├── persistence_interface.py
├── regex_interface.py
└── time_interface.py
```

#### 3.3.2 統合方針
```
operations/interfaces/
├── execution_interfaces.py    # Docker/Shell/Python実行
├── infrastructure_interfaces.py # ファイルシステム/永続化/時間
└── utility_interfaces.py      # ロガー/出力/正規表現
```

#### 3.3.3 作業内容
1. 関連性の高いインターフェースをグループ化
2. 使用頻度の低いインターフェースの削除検討
3. 実装との密結合部分の見直し

### Phase 4: 設定アクセスの簡素化（Day 4-5）

#### 3.4.1 問題点
- `.get()`禁止により冗長なコード
- 型安全性の過剰な追求
- 設定値アクセスの複雑性

#### 3.4.2 改善案
1. よく使用される設定パターンのヘルパーメソッド追加
2. デフォルト値処理の改善（CLAUDE.mdに準拠）
3. 設定検証の簡素化

#### 3.4.3 作業内容
1. 頻出パターンの特定と最適化
2. 設定アクセスユーティリティの作成
3. ドキュメントの更新

## 4. リスク管理

### 技術的リスク
1. **後方互換性の破壊**
   - 対策: 段階的な移行とテストによる検証
   
2. **循環インポートの発生**
   - 対策: 統合時の依存関係慎重な設計

3. **パフォーマンス劣化**
   - 対策: ベンチマークによる継続的な監視

### プロセスリスク
1. **CLAUDE.mdの無視**
   - 対策: 各フェーズでガイドライン遵守確認

2. **短期的解決への誘惑**
   - 対策: レビューとテストの徹底

## 5. 検証計画

### 各フェーズ終了時
1. **単体テスト実行**
   - `pytest`でPythonテスト
   - `cargo test`でRustテスト

2. **統合テスト**
   - E2Eテストの実行
   - 実際のワークフロー検証

3. **パフォーマンステスト**
   - 設定読み込み時間
   - リクエスト処理時間

### Week 2終了時
1. **全体テスト実行**
2. **コードカバレッジ確認**
3. **ドキュメント更新**
4. **Week 3計画の策定**

## 6. 期待される成果

### 定量的成果
- ファイル数: 150 → 120以下（20%削減）
- Request/Result関連: 15 → 5ファイル（67%削減）
- インターフェース: 8 → 3ファイル（63%削減）

### 定性的成果
- 新機能追加の容易性向上
- コードナビゲーションの改善
- 開発者の認知負荷軽減
- 保守性の向上

## 7. スケジュール

| 日程 | フェーズ | 成果物 |
|------|----------|--------|
| Day 1-2 | Request統合 | 統合されたRequest構造 |
| Day 2-3 | Result統合 | 統合されたResult構造 |
| Day 3-4 | インターフェース簡素化 | 簡素化されたインターフェース |
| Day 4-5 | 設定アクセス改善 | 改善された設定システム |
| Day 5 | 検証とドキュメント | 更新されたドキュメント |

## 8. 注意事項

### CLAUDE.md遵守事項
1. **デフォルト値使用禁止**: 全ての設定は明示的に指定
2. **副作用の制限**: infrastructure層のみに限定
3. **中長期視点**: 短期的ハックの排除
4. **エラーハンドリング**: フォールバック処理禁止

### 品質維持
1. **既存機能の保護**: 100%の機能維持
2. **テストファースト**: 変更前にテスト確認
3. **段階的移行**: 一度に大きな変更を避ける

---
計画策定完了: 2025-06-28 05:26