# Driver統合設計書 - 2025-06-28

## 現状分析結果

### 現在のDriver構造
現在のDriver構造は既に大幅に簡素化されており、以下の6つのコアファイルに集約されています：

```
src/infrastructure/drivers/
├── generic/
│   ├── base_driver.py      # 抽象インターフェースと共通機能
│   ├── execution_driver.py # シェルとPython実行を統合
│   ├── persistence_driver.py # データベース抽象化
│   └── unified_driver.py   # リクエストルーター
├── docker/
│   └── docker_driver.py    # コンテナ・イメージ管理
└── file/
    └── file_driver.py      # ファイルシステム操作
```

### 主要な発見事項

1. **既に統合が進んでいる**
   - 以前の分析では21ファイルが存在していたが、現在は6ファイルに削減済み
   - execution_driver.pyがシェルとPython実行を既に統合
   - unified_driver.pyが各ドライバーへのルーティングを担当

2. **依存関係**
   - UnifiedDriverが中心的な役割
   - DockerDriverがFileDriverとExecutionDriverに依存
   - 循環依存を避けるための遅延読み込みパターンを使用

3. **設定管理**
   - DIContainerを通じた依存性注入
   - infrastructure_defaults.jsonから設定を読み込み

## 追加統合の機会

### 1. インターフェースの統一化

現在、各ドライバーが独自のメソッドを持っているが、共通インターフェースで統一できる可能性がある：

```python
class UnifiedDriverInterface:
    def execute(self, request: BaseRequest) -> Result
    def validate(self, request: BaseRequest) -> bool
```

### 2. エラーハンドリングの統一

各ドライバーで異なるエラーハンドリングを統一：
- 共通の例外クラス階層
- 統一されたエラーレポート形式

### 3. 設定管理の改善

現在のデフォルト値使用を排除し、明示的な設定管理へ移行：
- execution_driver.pyの6箇所のデフォルト引数
- docker_driver.pyの設定値

## 推奨アクション

### フェーズ1: 現状の最適化（今回実施）

1. **CLAUDE.md違反の修正**
   - execution_driver.pyのデフォルト引数除去
   - フォールバック処理の排除
   - 設定ファイルからの明示的な値取得

2. **テストの整備**
   - 統合されたドライバーに対する包括的なテスト
   - モックの更新

### フェーズ2: 将来の統合（次回以降）

1. **インターフェース階層の整理**
   - BaseDriverInterfaceの定義強化
   - 各ドライバーの責務の明確化

2. **パフォーマンス最適化**
   - キャッシング戦略の統一
   - リソース管理の改善

## リスク評価

### 低リスク
- CLAUDE.md違反の修正
- テストの追加

### 中リスク
- エラーハンドリングの統一
- 設定管理の改善

### 高リスク
- インターフェースの大規模な変更
- 既存の動作への影響

## 結論

現在のDriver構造は既に大幅に改善されており、プロジェクト再生計画のWeek 1目標である「14個のDriver関連ディレクトリを4個に統合」は既に達成されている可能性が高い。

今回の作業では、既存構造の品質向上（CLAUDE.md違反の修正、テストカバレッジ向上）に注力することが最も効果的である。