# CPHプロジェクト - テスト修正・安定化計画
日時: 2025-06-28 06:18
計画策定者: Claude Code

## 1. 現状分析

### プロジェクト進捗状況
Week 2のリファクタリング（Request/Result/インターフェース統合）が完了し、以下の成果を達成：
- **ファイル削減**: 23ファイル → 13ファイル (43%削減)
- **構造簡素化**: Request/Result/インターフェースの統合完了
- **後方互換性**: レガシーラッパーによる既存インターフェース維持

### 現在の問題点
1. **テストの失敗**（10テスト）
   - file_request_simple.py: 7テスト失敗
   - unified_driver.py: 2テスト失敗（PythonとFileリクエスト）
   - contest_manager.py: 1テスト失敗

2. **技術的負債**
   - OperationResultクラスの引数不整合
   - 内部メソッドシグネチャの変更による影響
   - 一部のインポートパスの不整合

3. **テストカバレッジの低下リスク**
   - リファクタリング後の新構造に対するテスト不足
   - 統合されたモジュールの境界テスト不足

## 2. 目標設定

### 主要目標
1. **全テストの成功**: 253テスト全てをグリーンにする
2. **テストカバレッジの向上**: 現状維持または向上
3. **コード品質の確保**: CLAUDE.mdガイドライン準拠の徹底

### 成功指標
- テスト成功率: 100%
- 新規バグゼロ
- 既存機能の100%維持
- パフォーマンス劣化なし

## 3. 実施計画

### Phase 1: テスト失敗の詳細調査（30分）

#### 3.1.1 失敗テストの分析
1. **file_request_simple.py（7テスト）**
   - 失敗原因の特定
   - 影響範囲の確認
   - 修正方針の決定

2. **unified_driver.py（2テスト）**
   - PythonRequestテストの失敗原因
   - FileRequestテストの失敗原因
   - OperationResult初期化の問題調査

3. **contest_manager.py（1テスト）**
   - 失敗原因の特定
   - 依存関係の確認

### Phase 2: テスト修正実装（1時間）

#### 3.2.1 OperationResult関連の修正
1. **引数整合性の確保**
   - OperationResultクラスのシグネチャ見直し
   - 子クラスとの整合性確保
   - 必要に応じてファクトリーメソッドの追加

2. **レガシー互換性の強化**
   - LegacyShellResult/LegacyDockerResultの改善
   - 既存テストとの互換性確保

#### 3.2.2 個別テストの修正
1. **file_request_simple.py**
   - 内部メソッドの呼び出し修正
   - テストの期待値更新

2. **unified_driver.py**
   - リクエスト・レスポンス処理の修正
   - エラーハンドリングの改善

3. **contest_manager.py**
   - 依存関係の解決
   - 設定値の適切な注入

### Phase 3: テストカバレッジ強化（1時間）

#### 3.3.1 統合モジュールのテスト追加
1. **execution_requests.py**
   - 各リクエストタイプの境界テスト
   - エラーケースのテスト
   - パフォーマンステスト

2. **execution_results.py**
   - 各結果タイプの検証テスト
   - レガシーラッパーのテスト
   - エッジケースのテスト

3. **統合インターフェース**
   - インターフェース実装の検証
   - モック実装のテスト

#### 3.3.2 E2Eテストの確認
1. **基本ワークフローテスト**
   - Python/C++/Rustの実行確認
   - Docker環境での動作確認

2. **エラーシナリオテスト**
   - タイムアウト処理
   - 無効な入力処理
   - リソース制限の確認

### Phase 4: 品質保証（30分）

#### 3.4.1 静的解析
1. **Lintチェック**
   ```bash
   ruff check src/
   ```

2. **型チェック**
   ```bash
   mypy --strict src/
   ```

3. **循環インポートチェック**
   ```bash
   python detect_circular_imports.py
   ```

#### 3.4.2 パフォーマンス検証
1. **設定読み込み速度**
   - キャッシュあり/なしでの測定
   - 目標: <10μs（キャッシュ）、<1ms（非キャッシュ）

2. **リクエスト処理速度**
   - 各種リクエストタイプの処理時間測定
   - 前回との比較

### Phase 5: ドキュメント更新（30分）

#### 3.5.1 技術ドキュメント
1. **アーキテクチャ図の更新**
   - 新しいモジュール構造の反映
   - 依存関係の明確化

2. **APIドキュメント**
   - 統合されたインターフェースの説明
   - 使用例の更新

#### 3.5.2 結果報告書
1. **修正内容の詳細**
2. **テスト結果のサマリー**
3. **今後の推奨事項**

## 4. リスク管理

### 技術的リスク
1. **追加の破壊的変更**
   - 対策: 最小限の修正に留める
   - 対策: 十分なテストによる検証

2. **パフォーマンス劣化**
   - 対策: ベンチマークによる継続的監視
   - 対策: プロファイリングツールの活用

3. **新たな循環インポート**
   - 対策: 各修正後の循環インポートチェック
   - 対策: 遅延インポートの適切な使用

### プロセスリスク
1. **修正の複雑化**
   - 対策: 段階的な修正とテスト
   - 対策: ロールバック可能な実装

2. **時間超過**
   - 対策: タイムボックスの厳守
   - 対策: 優先順位に基づく実施

## 5. 検証計画

### 各フェーズ終了時
1. **テスト実行**
   ```bash
   pytest -xvs
   cargo test
   ```

2. **品質チェック**
   ```bash
   python scripts/run_src_check.sh
   ```

### 全体完了時
1. **フルテストスイート実行**
2. **カバレッジレポート生成**
3. **パフォーマンス比較**
4. **最終品質レポート作成**

## 6. スケジュール

| 時間 | フェーズ | 成果物 |
|------|----------|--------|
| 0:00-0:30 | Phase 1: 調査 | 失敗原因分析レポート |
| 0:30-1:30 | Phase 2: 修正 | 修正されたテスト |
| 1:30-2:30 | Phase 3: カバレッジ | 追加テスト |
| 2:30-3:00 | Phase 4: 品質保証 | 品質レポート |
| 3:00-3:30 | Phase 5: ドキュメント | 更新されたドキュメント |

## 7. 成功基準

### 必須達成項目
- [ ] 全テスト（253件）の成功
- [ ] Lintエラーゼロ
- [ ] 型チェックエラーゼロ
- [ ] 循環インポートなし
- [ ] パフォーマンス劣化なし

### 推奨達成項目
- [ ] テストカバレッジ向上
- [ ] ドキュメントの充実
- [ ] 今後のリファクタリング指針の明確化

## 8. 注意事項

### CLAUDE.md遵守事項
1. **デフォルト値使用禁止**: 全ての設定は明示的に指定
2. **副作用の制限**: infrastructure層のみに限定
3. **中長期視点**: 短期的ハックの排除
4. **エラーハンドリング**: フォールバック処理禁止
5. **引数デフォルト値禁止**: 呼び出し元で値を用意

### 品質方針
1. **最小限の変更**: 必要以上の修正を避ける
2. **後方互換性**: 既存の動作を維持
3. **テストファースト**: 修正前にテストで確認
4. **段階的実施**: 一度に大きな変更を避ける

---
計画策定完了: 2025-06-28 06:18