# CPHプロジェクト統合計画 - 2025/06/28 12:56

## プロジェクト現状分析

### 前回実行結果（12:32実行分）
- **テスト状況**: 623 passed, 12 skipped（成功率98.1%）
- **テストカバレッジ**: 全体52%（要改善）
- **低カバレッジモジュール**: 主要モジュールで14-35%
- **残タスク**: テストカバレッジ向上とアーキテクチャ簡素化

### 現在のコードベース状況
- **ソースファイル数**: 138個（src配下のPythonファイル）
- **テストファイル数**: 63個
- **ディレクトリ構造**: 過度に細分化された階層構造
- **技術的負債**: 過度な抽象化による開発者疲弊

## 基本方針（CLAUDE.md準拠）

### 厳守事項
1. **中長期を見据えた実装** - 短期的な解決を禁止
2. **副作用はinfrastructureのみ** - main.pyから注入
3. **デフォルト値・フォールバック処理の禁止**
4. **設定の明示的管理** - src/configuration/readme.md参照
5. **引数にデフォルト値を指定するのを禁止**

### プロジェクト再生宣言の理念
- **実用性重視**: 理論より開発者体験を優先
- **資産保護**: 既存の優秀な機能とテストを100%保持
- **段階的改善**: 4週間で73%のファイル削減
- **即効性**: 各週で体感できる改善を実現

## 実行計画（4週間）

### Phase 1: 緊急対応と基盤整備（〜2025/07/05）

#### Week 1: Driver系統合とテストカバレッジ改善

##### 1.1 Driver系統合（優先度：最高）
**目標**: 14個のDriver関連ディレクトリを4個のファイルに統合

**統合方針**:
```
現状:
src/infrastructure/drivers/
├── docker/
│   └── docker_driver.py
├── file/
│   └── file_driver.py
├── generic/
│   ├── base_driver.py
│   ├── execution_driver.py
│   ├── persistence_driver.py
│   └── unified_driver.py

統合後:
src/infrastructure/drivers/
├── docker_driver.py
├── file_driver.py
├── execution_driver.py
└── base_driver.py
```

**作業項目**:
- [ ] Driver依存関係の詳細分析
- [ ] 統合による影響範囲の特定
- [ ] 段階的な統合実施
- [ ] 各統合後のテスト実行確認

##### 1.2 テストカバレッジ改善（優先度：高）
**目標**: 全体カバレッジを52%→70%へ向上

**優先対応モジュール（カバレッジ20%未満）**:
1. `system_config_repository.py` (14%)
2. `docker_image_repository.py` (20%)
3. `formatters.py` (19%) - ✅ 完了

**作業項目**:
- [ ] 各モジュールの実装詳細確認
- [ ] 適切なモックとテストケース設計
- [ ] テスト実装と実行確認
- [ ] カバレッジレポートの更新

### Phase 2: Request/Result統合（2025/07/05〜2025/07/12）

#### Week 2: 型システムの統一化

##### 2.1 Request/Result型統合
**目標**: 分散したRequest/Result型を2ファイルに集約

**統合設計**:
```python
# src/operations/unified_requests.py
class BaseRequest
class DockerRequest(BaseRequest)
class FileRequest(BaseRequest)
class ShellRequest(BaseRequest)

# src/operations/unified_results.py
class BaseResult
class ExecutionResult(BaseResult)
class FileResult(BaseResult)
class CheckResult(BaseResult)
```

**効果測定指標**:
- 新機能追加時の編集ファイル数: 8個→3個
- インポート文の削減: 50%以上

### Phase 3: Provider/Adapter統合（2025/07/12〜2025/07/19）

#### Week 3: 小規模ファイルの統合

##### 3.1 極小ファイル統合
**目標**: 50行未満の47個のファイルを統合

**統合対象例**:
- TimeAdapter (18行)
- RegexProvider (25行)
- MockRegexProvider (30行)
- その他のシンプルなアダプター

**統合後の構造**:
```
src/infrastructure/
├── adapters.py  # 全アダプター統合
├── providers.py  # 全プロバイダー統合
└── utils.py     # ユーティリティ関数統合
```

### Phase 4: 最終統合と品質保証（2025/07/19〜2025/07/26）

#### Week 4: テスト環境とドキュメント整備

##### 4.1 Mock統合
**目標**: 6個のMockディレクトリを1ファイルに統合

##### 4.2 ドキュメント整備
- アーキテクチャ図の更新
- 開発者ガイドの作成
- APIリファレンスの整備

## 成功指標

### 定量的指標
| 項目 | 現状 | 目標 | 削減率 |
|------|------|------|--------|
| ソースファイル数 | 138個 | 40-50個 | 71% |
| ディレクトリ数 | 22個 | 10個以下 | 55% |
| テストカバレッジ | 52% | 70%以上 | +18% |
| 新機能追加の編集ファイル数 | 8個 | 2-3個 | 75% |
| バグ調査時のファイル移動 | 10回 | 3-4回 | 70% |

### 定性的指標
- **開発者体験**: 新規参加者が1日で概要把握可能
- **保守性**: バグ修正が30分以内に完了可能
- **拡張性**: 新言語追加が1日で完了可能

## リスク管理

### 技術的リスクと対策
1. **機能劣化リスク**
   - 対策: 各統合前後での完全なテスト実行
   - 対策: git bisectによる問題特定準備

2. **パフォーマンス低下**
   - 対策: cProfileによるプロファイリング
   - 対策: 統合前後のベンチマーク比較

3. **依存関係の複雑化**
   - 対策: 統合時の依存関係図作成
   - 対策: 循環依存の事前チェック

### プロジェクトリスクと対策
1. **スコープクリープ**
   - 対策: 週次目標の厳守
   - 対策: 新要求は次フェーズへ延期

2. **品質低下**
   - 対策: CLAUDE.mdの原則厳守
   - 対策: コードレビューの徹底

## 即時実行項目（本日〜今週末）

### 1. Driver分析と統合準備
```bash
# Driver関連ファイルの詳細分析
find src -name "*driver*.py" -type f -exec wc -l {} \; | sort -n

# 依存関係の可視化
python -m src_check.generate_dependency_graph --focus-on drivers
```

### 2. 優先テスト作成
- [ ] system_config_repository.pyのテスト設計・実装
- [ ] docker_image_repository.pyのテスト設計・実装

### 3. 進捗管理体制
- [ ] 日次進捗レポートのフォーマット作成
- [ ] 週次レビューの体制確立

## CPHプロジェクトの価値と目標

### ユーザー提供価値（要件定義より）
1. **時間の創出**: セットアップ時間の大幅短縮
2. **ストレスからの解放**: 環境依存エラーの最小化
3. **学習効率の向上**: 実行履歴からの振り返り支援

### 技術的価値
1. **Clean Architecture**: 企業レベルの設計品質
2. **型安全性**: TypeSafeConfigNodeManagerによる堅牢性
3. **拡張性**: 新言語・新機能の容易な追加

## コミットメント

CPH (Competitive Programming Helper)は競技プログラミング支援ツールとして、ユーザーが「問題を解く」ことに集中できる環境を提供する重要なプロジェクトです。

現在の過度な抽象化による複雑性を、4週間の段階的統合により解決し、以下を実現します：

1. **既存資産の100%保護**: 18,129行の優秀なロジックとテストを維持
2. **開発者体験の大幅向上**: ファイル数73%削減による生産性向上
3. **持続可能な成長**: 中長期的視点での拡張性確保

---

**作成日時**: 2025年6月28日 12:56  
**対象**: CPH (Competitive Programming Helper)  
**実行期間**: 4週間（2025年6月28日〜2025年7月26日）  
**次回レビュー**: 2025年7月1日（Week 1中間レビュー）