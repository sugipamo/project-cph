# Driver系統統合詳細計画

## 概要
CPHプロジェクトのDriver系統を現在の15ファイル構成から4ファイル構成へ段階的に統合する詳細計画。

## 現状分析結果

### ファイル構成（15ファイル）
```
src/infrastructure/drivers/
├── docker/
│   ├── docker_driver.py (179行) - 抽象基底クラス
│   ├── docker_driver_with_tracking.py (163行) - トラッキング機能付き
│   ├── local_docker_driver.py (実装未確認)
│   ├── mock_docker_driver.py (310行) - モック実装
│   └── utils/
│       └── docker_naming.py (75行) - ユーティリティ
├── file/
│   ├── file_driver.py (202行) - 抽象基底クラス
│   ├── local_file_driver.py (91行) - ローカル実装
│   └── mock_file_driver.py (194行) - モック実装
├── generic/
│   ├── base_driver.py (36行) - 全ドライバーの基底インターフェース
│   ├── persistence_driver.py (165行) - 永続化ドライバー
│   └── unified_driver.py (381行) - 統合ドライバー
├── python/
│   ├── python_driver.py (107行) - 抽象基底クラス
│   ├── local_python_driver.py (実装未確認)
│   └── mock_python_driver.py (140行) - モック実装
└── shell/
    ├── shell_driver.py (80行) - 抽象基底クラス
    ├── local_shell_driver.py (44行) - ローカル実装
    └── mock_shell_driver.py (120行) - モック実装
```

## 段階的統合計画

### 第1段階: モック実装の分離（Week 1 前半）
**目標**: 15ファイル → 10ファイル

#### 作業内容
1. `tests/mocks/drivers/`ディレクトリを作成
2. 全モック実装を移動:
   - `mock_docker_driver.py`
   - `mock_file_driver.py`
   - `mock_python_driver.py`
   - `mock_shell_driver.py`
3. インポートパスの更新
4. テスト実行による動作確認

#### 期待される効果
- プロダクションコードとテストコードの明確な分離
- src/配下のファイル数削減
- 保守性の向上

### 第2段階: 共通機能の抽出（Week 1 後半）
**目標**: 10ファイル → 8ファイル

#### 作業内容
1. `base_driver.py`の拡張:
   ```python
   # 共通設定管理
   class ConfigurableDriver(ExecutionDriverInterface):
       def _load_infrastructure_defaults(self)
       def _get_default_value(self, key: str)
   
   # 共通バリデーション
   class ValidatableDriver(ConfigurableDriver):
       def _validate_request(self, request)
       def _validate_path(self, path: str)
   ```

2. 各ドライバーから共通機能を削除
3. 継承関係の更新

#### 期待される効果
- コード重複の削減（約200行）
- 保守性の向上
- バグ修正の一元化

### 第3段階: 同種ドライバーの統合（Week 2）
**目標**: 8ファイル → 4ファイル

#### 最終的なファイル構成

1. **base_driver.py** (推定150行)
   ```python
   # インターフェース定義
   class ExecutionDriverInterface(ABC)
   class ConfigurableDriver(ExecutionDriverInterface)
   class ValidatableDriver(ConfigurableDriver)
   
   # 共通ユーティリティ
   class DriverUtils:
       @staticmethod
       def validate_path(path: str)
       @staticmethod
       def load_defaults(config_name: str)
   ```

2. **execution_drivers.py** (推定600行)
   ```python
   # Docker関連
   class DockerDriver(ValidatableDriver)
   class LocalDockerDriver(DockerDriver)
   class DockerDriverWithTracking(LocalDockerDriver)
   class DockerNaming  # utils統合
   
   # Shell関連
   class ShellDriver(ValidatableDriver)
   class LocalShellDriver(ShellDriver)
   
   # Python関連
   class PythonDriver(ValidatableDriver)
   class LocalPythonDriver(PythonDriver)
   ```

3. **io_drivers.py** (推定400行)
   ```python
   # File関連
   class FileDriver(ValidatableDriver)
   class LocalFileDriver(FileDriver)
   
   # Persistence関連
   class PersistenceDriver(ValidatableDriver)
   ```

4. **unified_driver.py** (現状維持: 381行)

## 実装の詳細手順

### 共通機能抽出の具体例

#### Before (各ドライバーに散在)
```python
# docker_driver.py
def _load_infrastructure_defaults(self):
    config_path = "path/to/config"
    # 20行の実装

# file_driver.py
def _load_infrastructure_defaults(self):
    config_path = "path/to/config"
    # ほぼ同じ20行の実装
```

#### After (base_driver.pyに集約)
```python
# base_driver.py
class ConfigurableDriver(ExecutionDriverInterface):
    def _load_infrastructure_defaults(self):
        # 統一された実装
        
# docker_driver.py
class DockerDriver(ConfigurableDriver):
    # _load_infrastructure_defaultsは継承
```

## リスク管理

### 識別されたリスク

1. **依存関係の破壊**
   - 対策: 各段階でのインポート検証
   - ツール: import_dependency_reorganizer

2. **テストの失敗**
   - 対策: 各段階での包括的テスト実行
   - 事前にテストカバレッジを確認

3. **パフォーマンス劣化**
   - 対策: ファイルサイズの監視
   - 1ファイル1000行を超えない

4. **CLAUDE.md違反**
   - 対策: 副作用の厳格な管理
   - infrastructureレイヤーの境界維持

## 成功指標

### 定量的指標
- ファイル数: 15 → 4 (73%削減)
- 総コード行数: 10%以上削減（重複排除による）
- インポート文: 30%削減

### 定性的指標
- 新規ドライバー追加時の編集ファイル数: 5 → 2
- コードナビゲーション時間: 50%短縮
- 保守性スコアの向上

## タイムライン

### Week 1 前半（3日間）
- Day 1: モック分離の準備とテスト
- Day 2: モック分離の実装
- Day 3: 動作確認とドキュメント更新

### Week 1 後半（2日間）
- Day 4: 共通機能の抽出
- Day 5: テストと調整

### Week 2（5日間）
- Day 1-2: execution_drivers.pyの作成
- Day 3-4: io_drivers.pyの作成
- Day 5: 統合テストと最終調整

## 次のアクション

1. モック分離の詳細設計
2. テストカバレッジの現状確認
3. 依存関係グラフの作成

---
作成日時: 2025年6月27日
作成者: Claude Code