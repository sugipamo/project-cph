# 202506281813 実行計画

## 現状分析

### プロジェクト状況
- **ブランチ**: feature/dependency-reorganization
- **プロジェクト目標**: CPH（Competitive Programming Helper）- 競技プログラミング環境統一ツール
- **再生計画**: 4週間でファイル数73%削減、開発者体験70%向上を目指す段階的統合
- **現在フェーズ**: Week 1 - Driver系統統合段階

### 前回作業（202506281749）からの状況
- **テストカバレッジ**: 64%（目標: 70-80%）
- **テスト状況**: 920件中914件成功、6件スキップ
- **主な成果**:
  - 低カバレッジモジュールの大幅改善（data_processors: 0%→100%、python_utils: 27%→97%）
  - スキップテストの50%を修正
  - アプリケーション層のインフラ依存を5ファイルで解消

### 残課題
1. **Driver統合**（プロジェクト再生計画Week 1の主要タスク）
2. **CLAUDE.md違反の修正**（デフォルト値・フォールバック処理）
3. **残りのインフラ依存修正**
4. **テストカバレッジ70%達成**

## 実行計画

### 1. Driver統合の実施（優先度: 最高）

プロジェクト再生計画のWeek 1目標に従い、14個のDriver関連ディレクトリを4個に統合します。

#### 1.1 現状調査と統合設計
- Driver関連ファイルの使用状況調査
- 統合後のインターフェース設計
- 移行計画の策定

#### 1.2 段階的統合の実施
- **第1段階**: generic/配下のbase_driver, execution_driver, persistence_driverの統合
- **第2段階**: docker/, file/配下のドライバー統合
- **第3段階**: テストの移行と動作確認

### 2. CLAUDE.md違反の修正（優先度: 高）

#### 2.1 デフォルト引数の除去
対象ファイル：
- execution_driver.py（6箇所）
- execution_requests.py（11箇所）
- ast_analyzer.py（1箇所）

#### 2.2 フォールバック処理の除去
対象ファイル：
- execution_driver.py（getattr使用箇所）
- step_runner.py（hardcoded fallback）
- di_config.py（.get()使用箇所）
- execution_requests.py（.get()使用箇所）
- ast_analyzer.py（or演算子使用箇所）

### 3. 残りのインフラ依存修正（優先度: 中）

未修正の6ファイル：
- execution_requests.py（provider系の直接インポート）
- contest_manager.py（SystemTimeProvider、DIKey等）
- config_manager.py（直接ファイル操作）
- services/config_loader_service.py（DIContainer直接使用）
- services/debug_service.py（DIContainer直接使用）
- execution_history.py

### 4. テストカバレッジ向上（優先度: 中）

#### 4.1 データレイヤーのテスト追加
- operation_repository.py（35%→70%）
- session_repository.py（35%→70%）

#### 4.2 ドメインレイヤーのテスト追加
- dependency.py（8%→60%）
- composite_structure.py（33%→70%）

## 作業順序と時間配分

### 第1フェーズ（2-3時間）: Driver統合準備
1. Driver使用状況の詳細調査
2. 統合設計ドキュメントの作成
3. 影響範囲の特定

### 第2フェーズ（3-4時間）: Driver統合実施
1. generic/配下の3ドライバー統合
2. docker/, file/ドライバー統合
3. テスト実行による動作確認

### 第3フェーズ（2-3時間）: CLAUDE.md違反修正
1. デフォルト引数の除去（設定ファイルからの取得に変更）
2. フォールバック処理の除去（明示的なエラーハンドリングに変更）
3. 修正後のテスト実行

### 第4フェーズ（1-2時間）: 品質確認とドキュメント化
1. 全体テストの実行
2. カバレッジレポートの生成
3. 残タスクの整理

## 成功基準

1. **Driver統合**
   - 14個のDriver関連ディレクトリを4個以下に削減
   - 全テストが成功（既存機能の保持）
   - ナビゲーション性50%改善の実現

2. **品質向上**
   - CLAUDE.md違反の70%以上を解消
   - テストカバレッジ66%以上（2%向上）
   - スキップテストの更なる削減

3. **保守性向上**
   - 新機能追加時の編集ファイル数削減の実証
   - ドキュメントの整備

## リスクと対策

### リスク1: Driver統合による既存機能の破損
- **対策**: 
  - 統合前の完全なテスト実行とベースライン記録
  - 段階的な統合による影響範囲の限定
  - 各段階でのテスト実行

### リスク2: CLAUDE.md違反修正による大規模な変更
- **対策**:
  - 設定ファイルの事前準備
  - 一つずつ慎重に修正し、都度テスト実行
  - 修正困難な箇所は残タスクとして記録

### リスク3: 時間不足による未完了
- **対策**:
  - Driver統合を最優先で実施
  - 完了できなかった項目は明確に文書化
  - 次回作業のための詳細な引き継ぎ

## 技術的注意事項

1. **Driver統合時の注意**
   - インターフェースの互換性維持
   - 依存性注入パターンの保持
   - テストモックの適切な更新

2. **CLAUDE.md違反修正時の注意**
   - 設定ファイルの構造確認
   - エラーハンドリングの適切な実装
   - 既存の動作を変更しない

3. **テスト追加時の注意**
   - 実装に基づいた現実的なテスト
   - モックの適切な使用
   - カバレッジだけでなく品質も重視

## 備考

- プロジェクト再生計画のWeek 1目標達成を最優先とする
- 作業中は定期的にgit statusとテスト実行を行い、進捗を確認
- Driver統合は慎重に実施し、既存機能の保持を確実にする
- 問題発生時は速やかに残タスクとして記録し、次回作業に引き継ぐ