# テスト失敗分析レポート

## 概要
合計19個のテストが失敗しています。以下、問題タイプ別に分類して分析しました。

## 1. LogFormatType関連の失敗 (4件)

### 問題の詳細
- `tests/utils/test_format_info.py` で4つのテストが失敗
- 原因: `LogFormatType` enumの値が変更された
  - テストは `RAW` と `CUSTOM` を期待
  - 実際のenumには `PLAIN`, `COLORED`, `JSON`, `STRUCTURED` のみ存在

### 失敗したテスト
1. `test_to_dict`: `CUSTOM` → `COLORED` への変更が必要
2. `test_from_dict`: `RAW` が存在しない
3. `test_apply_raw_format`: `LogFormatType.RAW` が存在しない
4. `test_apply_with_indent`: `LogFormatType.RAW` が存在しない

### 対応方針
- テストを新しいenum値に合わせて更新する必要がある
- `RAW` → `STRUCTURED` または `PLAIN` に置き換え
- `CUSTOM` → `COLORED` に置き換え

## 2. FileDriver API変更による失敗 (3件)

### 問題の詳細
- `tests/infrastructure/drivers/test_file_driver.py` で3つのテストが失敗
- 原因: FileDriverのメソッドシグネチャが変更された

### 失敗したテスト
1. `test_glob_no_root`: `glob()` メソッドが `root` パラメータを必須引数に変更
   - 旧: `glob(pattern)` 
   - 新: `glob(pattern, root)`

2. `test_hash_file`: `hash_file()` メソッドが `algorithm` パラメータを必須引数に変更
   - 旧: `hash_file(path)` (デフォルトでsha256)
   - 新: `hash_file(path, algorithm)`

3. `test_execute_command_write`: `create_file()` メソッドが `create_parents` パラメータを追加
   - 旧: `create_file(path, content)`
   - 新: `create_file(path, content, create_parents)`

### 対応方針
- テストを新しいAPIに合わせて更新
- 必須パラメータを明示的に指定

## 3. ContestManager例外処理の失敗 (11件)

### 問題の詳細
- `tests/application/test_contest_manager.py` で11個のテストが失敗
- 原因: FileRequestのインスタンス化時に `time_ops` パラメータが必須になった

### 失敗したテスト（例外処理関連）
1. `test_move_directory_contents_failure`
2. `test_move_directory_contents_exception`
3. `test_clear_contest_current_exception`
4. `test_copy_directory_contents_exception`
5. `test_copy_template_structure_exception`
6. `test_copy_template_recursive_exception`
7. `test_track_files_from_stock_exception`
8. `test_track_files_recursive_exception`
9. `test_handle_contest_change_exception`
10. `test_restore_from_contest_stock_exception`
11. `test_initialize_from_template_exception`

### 対応方針
- テスト内でFileRequestを作成する際に `time_ops` パラメータを追加
- `SystemTimeProvider()` のインスタンスを渡す

## 4. ShellRequest例外処理の失敗 (1件)

### 問題の詳細
- `tests/operations/requests/test_execution_requests.py` で1つのテストが失敗
- 原因: リトライロジックでの例外処理が期待通りに動作していない

### 失敗したテスト
- `test_execute_core_with_retry`: 最初の例外がキャッチされずに再スローされている

### 対応方針
- `_execute_core` メソッドの例外処理ロジックを確認
- リトライ時の例外処理が適切に実装されているか検証

## まとめ

### 優先度順の対応
1. **高優先度**: LogFormatType関連 - テストの単純な更新で対応可能
2. **中優先度**: FileDriver API変更 - テストにパラメータを追加するだけ
3. **低優先度**: ContestManager/ShellRequest - 実装の確認が必要

### 根本原因
- API変更時にテストの更新が漏れている
- デフォルト値の廃止（CLAUDE.mdの指示に従った結果）により、テストが古いAPIを使用している