# テスト基盤実装計画

## 概要
old_srcのtests/ディレクトリとモック実装を参考に、包括的なテスト基盤をRustに構築する計画。

## 背景と目的
- **現状**: 現在のRustプロジェクトにはテスト基盤が未整備
- **old_srcの実装**: 各種モックドライバーとテストユーティリティを提供
- **目的**: 高品質なコードベースの維持と、リファクタリングの安全性確保

## 実装すべき機能

### 1. モックフレームワーク
- 各インターフェースのモック実装
- 期待値の設定と検証
- 呼び出し回数の検証

### 2. テストフィクスチャ
- テストデータの生成
- 一時ファイル/ディレクトリの管理
- テスト用のDockerコンテナ管理

### 3. アサーションユーティリティ
- カスタムアサーション
- 出力の検証
- エラーパターンの検証

### 4. 統合テスト環境
- E2Eテストのサポート
- テスト環境の自動セットアップ
- 並列テストの実行

## 実装方針

### ディレクトリ構造
```
tests/
├── common/
│   ├── mod.rs
│   ├── fixtures.rs    # テストフィクスチャ
│   ├── mocks.rs      # モック実装
│   └── assertions.rs # アサーション
├── unit/             # ユニットテスト
├── integration/      # 統合テスト
└── e2e/             # E2Eテスト

src/infrastructure/test_support/
├── mod.rs
├── mock_drivers/    # モックドライバー
│   ├── mod.rs
│   ├── file_system.rs
│   ├── shell.rs
│   └── docker.rs
└── builders/        # テストビルダー
    ├── mod.rs
    └── config.rs
```

### 主要な型定義
```rust
// モックトレイト
trait Mock<T> {
    fn expect(&mut self) -> &mut Expectation<T>;
    fn checkpoint(&mut self);
    fn verify(&self) -> Result<()>;
}

// テストフィクスチャ
struct TestFixture {
    temp_dir: TempDir,
    config: TestConfig,
    mock_container: MockContainer,
}

impl TestFixture {
    fn new() -> Self;
    fn with_file(&mut self, path: &str, content: &str) -> &mut Self;
    fn with_config(&mut self, config: TestConfig) -> &mut Self;
    fn build(self) -> TestContext;
}

// アサーションヘルパー
trait OutputAssertions {
    fn assert_stdout_contains(&self, expected: &str);
    fn assert_stderr_is_empty(&self);
    fn assert_exit_code(&self, code: i32);
}
```

## 技術選定
- **mockall**: モックフレームワーク
- **tempfile**: 一時ファイル管理
- **assert_fs**: ファイルシステムアサーション
- **predicates**: 柔軟な検証
- **proptest**: プロパティベーステスト
- **criterion**: ベンチマーク

## 実装の詳細

### 1. モックドライバーの実装
```rust
#[derive(Default)]
struct MockFileSystem {
    files: HashMap<PathBuf, String>,
    expectations: Vec<Expectation>,
}

#[async_trait]
impl FileSystem for MockFileSystem {
    async fn read_file(&self, path: &Path) -> Result<String> {
        self.files.get(path)
            .cloned()
            .ok_or_else(|| anyhow!("File not found"))
    }
}
```

### 2. ビルダーパターンの活用
```rust
// テストシナリオのビルダー
TestScenario::new()
    .given_problem("two-sum")
    .with_test_case("1 2\n", "3\n")
    .with_test_case("5 7\n", "12\n")
    .when_submit("solution.cpp")
    .then_all_tests_pass();
```

### 3. スナップショットテスト
```rust
#[test]
fn test_workflow_output() {
    let output = execute_workflow(workflow);
    insta::assert_snapshot!(output);
}
```

## テスト戦略

### 1. テストピラミッド
- **ユニットテスト** (70%): 個別の関数やモジュール
- **統合テスト** (20%): モジュール間の連携
- **E2Eテスト** (10%): 全体的なワークフロー

### 2. テストカバレッジ
- 目標: 80%以上のカバレッジ
- 重要なビジネスロジック: 90%以上
- エラーハンドリング: 100%

### 3. 継続的テスト
- プルリクエストごとの自動テスト
- ナイトリービルドでの包括的テスト
- パフォーマンステストの定期実行

## 期待される効果
1. バグの早期発見
2. リファクタリングの安全性向上
3. ドキュメントとしてのテスト
4. 開発速度の向上（長期的）

## 実装優先度
**高**: コード品質の基盤となる機能であり、早期に整備することで後続の開発効率が向上するため