# CPHプロジェクト統合計画 - 2025/06/28 12:32

## プロジェクト現状分析

### 前回実行結果（11:57実行分）
- **テスト修正**: 593 passed, 12 skipped（成功率97.9%）
- **削除された古いテスト**: 2件（Step validation関連）
- **インポート修正**: src_check内の6件の相対インポートを修正
- **主要な技術的改善**:
  - DI設定の安定化（7件修正完了）
  - LogLevelをIntEnumに変更（型安全性向上）
  - RequestCreatorの具体実装追加

### 現在のコードベース状況
- **ソースファイル数**: 138個（src配下のPythonファイル）
- **テストファイル数**: 56個
- **ディレクトリ数**: 22個（プロジェクトルート）
- **カバレッジ**: 主要モジュールで0-40%（要改善）

## 統合計画の更新方針

### 基本原則の再確認（CLAUDE.mdより）
1. **中長期を見据えた実装** - 短期的な解決を禁止
2. **副作用はinfrastructureのみ** - main.pyから注入
3. **デフォルト値・フォールバック処理の禁止**
4. **設定の明示的管理** - src/configuration/readme.md参照

### プロジェクト再生宣言の精神
- **実用性重視**: 理論より開発者体験を優先
- **資産保護**: 既存の優秀な機能とテストを100%保持
- **段階的改善**: 4週間で73%のファイル削減
- **即効性**: 各週で体感できる改善を実現

## 実行計画（更新版）

### Phase 1: 緊急対応【完了済み】
- ✅ テスト成功率: 97.9%達成（593 passed, 12 skipped）
- ✅ src_checkインポート修正: 6件完了
- ✅ DI設定安定化: 全7件修正完了

### Phase 2: アーキテクチャ簡素化（2025/06/28〜2025/07/05）

#### Week 1: Driver系統合とテストカバレッジ改善

##### 2.1 Driver系統合（優先度：最高）
**目標**: 14個のDriver関連ディレクトリを4個に統合

1. **統合対象の分析**
   - [ ] 現在のDriver構造の詳細調査
   - [ ] 各Driverの責務と依存関係の整理
   - [ ] 統合パターンの設計

2. **段階的統合実施**
   - [ ] DockerDriver統合（docker_driver/関連）
   - [ ] FileDriver統合（file_driver/関連）
   - [ ] ShellDriver統合（shell_driver/関連）
   - [ ] PythonDriver統合（python_driver/関連）

3. **統合後の構造**
   ```
   src/core/drivers/
   ├── docker_driver.py
   ├── file_driver.py
   ├── shell_driver.py
   └── python_driver.py
   ```

##### 2.2 テストカバレッジ改善（優先度：高）
**0%カバレッジモジュールの優先対応**

1. **データ層テスト追加**
   - [ ] sqlite_state_repository.py - SQLite実装のテスト
   - [ ] state_repository.py - 抽象インターフェースのテスト

2. **インフラ層テスト追加**
   - [ ] ast_analyzer.py - AST解析機能のテスト
   - [ ] docker_naming_provider.py - Docker命名規則のテスト
   - [ ] file_provider.py - ファイル操作のテスト
   - [ ] module_info.py - モジュール情報管理のテスト

3. **ログ関連テスト追加**
   - [ ] log_format_type.py - ログフォーマットのテスト
   - [ ] log_types.py - ログタイプのテスト（既存テスト拡張）

#### Week 2: Request/Result統合（2025/07/05〜2025/07/12）

##### 2.3 Request/Result型統合
**目標**: 分散したRequest/Result型を2ファイルに集約

1. **統合設計**
   - [ ] 全Request型の調査と共通インターフェース抽出
   - [ ] Result型の統一設計
   - [ ] 後方互換性の確保方法検討

2. **実装**
   - [ ] src/core/operations/requests.py作成
   - [ ] src/core/operations/results.py作成
   - [ ] 既存コードの移行

3. **効果測定**
   - [ ] 新機能追加時の編集ファイル数: 8個→3個

### Phase 3: 品質向上と最適化（2025/07/12〜2025/07/19）

#### Week 3: Provider/Adapter統合とE2Eテスト

##### 3.1 小規模ファイル統合
**目標**: 50行未満の47個のファイルを統合

1. **統合対象**
   - [ ] TimeAdapter等の極小アダプター
   - [ ] 単純なプロバイダークラス
   - [ ] ユーティリティ関数群

2. **統合先**
   ```
   src/core/adapters.py（新規作成）
   src/core/providers.py（既存拡張）
   ```

##### 3.2 E2Eテスト強化
1. **ワークフロー全体のテスト**
   - [ ] Python問題の解決フロー
   - [ ] C++問題の解決フロー
   - [ ] Docker環境での実行フロー

2. **エラーハンドリングテスト**
   - [ ] ネットワークエラー時の挙動
   - [ ] ファイルシステムエラー時の挙動
   - [ ] Docker関連エラー時の挙動

### Phase 4: 最終統合と文書化（2025/07/19〜2025/07/26）

#### Week 4: テスト環境整理と文書化

##### 4.1 Mock統合
**目標**: 6個のMockディレクトリを1ファイルに統合

1. **統合実施**
   - [ ] tests/mocks.py作成
   - [ ] 既存Mockの移行
   - [ ] __oldtests/の整理

##### 4.2 ドキュメント整備
1. **技術文書**
   - [ ] 新アーキテクチャ概要
   - [ ] 開発者ガイド
   - [ ] APIリファレンス

2. **運用文書**
   - [ ] セットアップガイド
   - [ ] トラブルシューティング
   - [ ] パフォーマンスチューニング

## 成功指標（更新版）

### 定量的指標
- **ファイル数**: 150個 → 40-50個（73%削減）
- **テストカバレッジ**: 主要モジュール80%以上
- **テスト成功率**: 100%維持
- **新機能追加の編集ファイル数**: 8個 → 2-3個
- **バグ調査時のファイル移動**: 10回 → 3-4回

### 定性的指標
- **開発者体験**: 新規参加者が1日で概要把握可能
- **保守性**: バグ修正が迅速に実行可能
- **拡張性**: 新言語追加が容易
- **品質**: 企業レベルの品質維持

## 即時アクション（本日実施）

### 1. Driver構造の詳細分析
```bash
# Driver関連ファイルの調査
find src -name "*driver*" -type f | sort
```

### 2. 0%カバレッジモジュールのテスト作成開始
- sqlite_state_repository.pyのテスト設計
- ast_analyzer.pyのテスト設計

### 3. 週次進捗管理の準備
- 進捗トラッキングシートの作成
- 日次スタンドアップの記録フォーマット準備

## リスク管理（更新版）

### 技術的リスク
1. **Driver統合時の機能劣化**
   - 対策: 各統合前後でのテスト実行
   - 対策: 段階的な統合とロールバック準備

2. **パフォーマンス低下**
   - 対策: 統合前後のベンチマーク測定
   - 対策: プロファイリングによるボトルネック特定

### プロジェクトリスク
1. **スコープクリープ**
   - 対策: 週次目標の厳守
   - 対策: 新要求の次フェーズへの延期

2. **技術的負債の蓄積**
   - 対策: CLAUDE.mdの原則厳守
   - 対策: コードレビューの徹底

## コミットメント

CPHプロジェクトは競技プログラミング支援ツールとして高い潜在価値を持つ。現在の課題は過度な抽象化による複雑性であり、これを4週間の段階的統合により解決する。

我々は：
- 既存の優秀なロジックとテストを100%保護する
- 実用性を最優先に開発者体験を大幅に向上させる
- 中長期的な視点で持続可能なアーキテクチャを構築する

---

**作成日時**: 2025年6月28日 12:32  
**対象**: CPH (Competitive Programming Helper)  
**期間**: 4週間（2025年6月28日〜2025年7月26日）  
**次回レビュー**: 2025年7月1日（Week 1中間レビュー）