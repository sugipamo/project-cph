# CPH プロジェクト改善計画書
作成日時: 2025-06-28 11:31

## 現状分析

### プロジェクト概要
- **プロジェクト名**: CPH (Competitive Programming Helper)
- **目的**: 競技プログラミング環境の統一化による開発効率向上
- **現在のブランチ**: feature/dependency-reorganization

### 現在の課題
1. **モジュール構造の不整合**
   - インポートエラーが10個以上残存
   - `src.infrastructure.drivers.docker_driver`等のモジュールが見つからない
   - 循環インポートの根本解決が不完全

2. **テスト実行の問題**
   - Pythonテスト: 415個中10個のコレクションエラー
   - 主な原因: モジュールパスの不整合

3. **アーキテクチャの複雑性**
   - 75ディレクトリ、150ファイルという過度な分割
   - 新機能追加時に8ファイルの編集が必要
   - 開発者の理解コストが高い

## 今回の作業目標

### 優先度1: テスト環境の正常化
1. **インポートエラーの解消**
   - 存在しないモジュールパスの修正
   - 正しいモジュール構造への統一

2. **全テストの成功**
   - 415個のテストを全て実行可能な状態にする
   - テストカバレッジの確認

### 優先度2: 依存関係の整理
1. **循環インポートの完全解消**
   - 依存関係グラフの可視化
   - レイヤー間の依存違反の修正

2. **モジュール構造の簡素化**
   - 不要な分割の統合
   - 論理的なグループ化

## 実施内容

### フェーズ1: インポートエラーの解消（即時対応）
1. **モジュールパスの調査と修正**
   ```
   - src.infrastructure.drivers.docker_driver → 正しいパスへ
   - src.domain.config_node_service → src.domain.services.config_node_service
   - その他のエラーモジュールの修正
   ```

2. **テスト実行の確認**
   - 各修正後にテストを実行
   - エラー数の減少を確認

### フェーズ2: アーキテクチャの改善（段階的実施）
1. **drivers構造の統一**
   - docker_driver.pyの正しい配置確認
   - driversディレクトリ構造の整理

2. **依存関係の整理**
   - 上位レイヤーから下位レイヤーへの一方向依存
   - インターフェースを介した疎結合化

### フェーズ3: テストカバレッジの向上
1. **既存テストの修正**
   - 古いインポートパスの更新
   - モックの適切な使用

2. **新規テストの追加**
   - カバレッジが低い部分の特定
   - 重要なビジネスロジックのテスト強化

## 実装方針の遵守

### CLAUDE.mdの指示事項
1. **デフォルト値の使用禁止**
   - 全ての値は明示的に提供
   - 設定はconfiguration配下で管理

2. **副作用の制限**
   - infrastructureレイヤーのみ
   - main.pyからの依存性注入

3. **中長期を見据えた実装**
   - 短期的な解決の回避
   - 根本的な問題解決

4. **フォールバック処理の禁止**
   - 明示的なエラーハンドリング

## 成功指標

1. **即時目標**
   - テストコレクションエラー: 10 → 0
   - 全415テストの実行可能化

2. **短期目標**
   - 循環インポート: 0件
   - テストカバレッジ: 80%以上

3. **中期目標**
   - ファイル数: 150 → 50以下
   - 新機能追加時の編集ファイル数: 8 → 3以下

## リスクと対策

### リスク
1. **機能劣化のリスク**
   - 既存機能の破壊
   - パフォーマンスの低下

2. **互換性の喪失**
   - 既存ユーザーへの影響
   - APIの変更

### 対策
1. **段階的な実施**
   - 小さな変更の積み重ね
   - 各段階でのテスト実行

2. **後方互換性の維持**
   - 互換性レイヤーの提供
   - 非推奨警告の活用

## 次のアクション

1. **モジュールパスの調査**（15分）
   - docker_driver.pyの正確な位置確認
   - 他のエラーモジュールの調査

2. **インポートエラーの修正**（30分）
   - 10個のコレクションエラーを順次解消
   - テスト実行による確認

3. **テスト成功率の向上**（45分）
   - 全テストの実行
   - 失敗テストの原因調査と修正

4. **進捗報告書の作成**（10分）
   - 履歴/202506281131_結果.mdへの記録

## 備考

本計画は要件定義に基づき、現在のプロジェクト状態を改善するための実践的なアプローチを採用しています。CLAUDE.mdの指示事項を厳守し、中長期的な視点での改善を目指します。