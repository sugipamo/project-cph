# 202506280040 実行計画

## 現在の状況

### ブランチ情報
- **現在のブランチ**: feature/dependency-reorganization
- **メインブランチ**: main
- **直近のコミット**: e5de29a - cargo testを実行し、問題があれば対応してください。古い実装に基づくテストは削除してよい、また、テストカバレッジが低いものがあればテストを追加してください。

### プロジェクト概要
CPH (Competitive Programming Helper) は競技プログラミングを支援する統合環境ツールです。Python、C++、Rustに対応し、Docker環境での一貫した実行を保証します。

### 現在の課題
1. **過度な抽象化**: 75ディレクトリ、150ファイルによる複雑性
2. **開発効率の低下**: 新機能追加に8ファイルの編集が必要
3. **低テストカバレッジ**: 12%（112テスト合格）
4. **保守性の問題**: バグ調査に10回のファイル移動が必要
5. **循環依存の存在**: 遅延インポートによる暫定対応が散見される

## プロジェクト再生計画の進捗

### 4週間計画の概要（プロジェクト再生宣言より）
- **Week 1**: Driver系統統合（27ファイル削減）
- **Week 2**: Request/Result統合（13ファイル削減）  
- **Week 3**: Provider/Adapter統合（8ファイル削除）
- **Week 4**: テスト環境整理

### 現在の進捗状況
feature/dependency-reorganizationブランチで依存関係の再編成作業が進行中。cargo testの実行と問題対応を繰り返している段階。

## 技術構成

### アーキテクチャ
- **Clean Architecture**: レイヤー分離は良好だが過度に複雑
- **主要レイヤー**:
  - Presentation Layer (CLI)
  - Application Layer (Services)
  - Domain Layer (Business Logic)
  - Infrastructure Layer (Drivers)

### 主要技術
- **言語**: Python 3.8+
- **実行環境**: Docker
- **データストア**: SQLite
- **設定管理**: JSON形式（ConfigNodeシステム）
- **品質管理**: src_check/ディレクトリに分離

## 開発原則（CLAUDE.mdより）

### 重要な制約
1. **デフォルト値の使用禁止**: すべての設定はJSONから取得
2. **中長期視点での実装**: 短期的な解決を避ける
3. **副作用の制限**: src/infrastructureのみで許可
4. **フォールバック処理禁止**: エラーを適切に処理
5. **引数のデフォルト値禁止**: 呼び出し元で値を明示
6. **循環インポートの禁止**: 遅延インポートによる解決は認めない

### 品質管理
- 品質管理コード：src_check/
- 本番コード：src/
- 明確な責務分離を維持

## 直近の作業内容分析

### 依存関係の問題
1. **循環依存の根本原因**
   - 過度な抽象化による相互依存
   - 責務の境界が不明確
   - インターフェースの過剰な細分化

2. **密結合の問題**
   - モジュール間の依存関係が複雑
   - 単一責任原則の違反
   - 依存性逆転の原則が不徹底

### テスト環境の課題
- cargo testの実行が繰り返されているが、根本的な改善に至っていない
- テストカバレッジの向上が必要
- 統合テストの不足

## 今後の作業計画

### フェーズ1: 依存関係の根本解決（優先度：最高）

#### 1.1 循環依存の完全排除
- 現在の循環依存箇所の特定と文書化
- 依存関係グラフの作成
- 責務の再配置による循環解消
- 遅延インポートの完全削除

#### 1.2 モジュール境界の再定義
- 各レイヤーの責務を明確化
- インターフェースの統合と簡素化
- 依存方向の厳格な管理

### フェーズ2: Driver統合（Week 1計画の実行）

#### 2.1 統合対象の分析
- 14個のDriver関連ディレクトリの機能マッピング
- 共通機能の抽出
- 統合後の構造設計

#### 2.2 段階的統合
1. **BaseDriver統合**
   - base_driver.py
   - unified_driver.py
   - persistence_driver.py
   → 単一のbase_driver.pyへ

2. **DockerDriver統合**
   - docker_command_utils.py
   - docker_driver.py
   → docker_driver.pyへ統合

3. **FileDriver統合**
   - integrated_file_driver.py
   - 関連ユーティリティ
   → file_driver.pyへ統合

4. **ShellPythonDriver維持**
   - 現状のまま保持

### フェーズ3: テスト戦略の実装

#### 3.1 単体テストの充実
- 各統合モジュールの単体テスト作成
- モックを活用した独立したテスト
- カバレッジ目標：各モジュール80%以上

#### 3.2 統合テストの整備
- エンドツーエンドのシナリオテスト
- Docker環境でのテスト
- パフォーマンステスト

### フェーズ4: Request/Result統合（Week 2計画）

#### 4.1 統合準備
- Request/Resultパターンの分析
- 共通インターフェースの設計
- 後方互換性の確保

#### 4.2 実装
- 13ファイルを3-4ファイルへ統合
- テストによる動作確認
- ドキュメント更新

## 実装方針

### 段階的アプローチ
1. **小さな変更の積み重ね**
   - 1日1-2モジュールのペース
   - 各変更後の完全なテスト実行
   - 問題発生時の即座のロールバック

2. **品質の維持**
   - 既存テストの全パス維持
   - 新規コードの100%テストカバレッジ
   - コードレビューの徹底

3. **CLAUDE.md原則の厳守**
   - 中長期視点での設計
   - 短期的な解決の完全排除
   - 適切な責務配置の確認

## 期待される成果

### 定量的目標
- ファイル数：150個 → 40個以下（73%削減）
- 新機能追加時の編集ファイル数：8個 → 2-3個
- テストカバレッジ：12% → 80%以上
- 循環依存：完全に0

### 定性的目標
- 開発者の認知負荷を大幅に削減
- 新規参加者の学習時間を70%短縮
- バグ調査と修正の効率化
- 保守性の大幅向上

## リスクと対策

### 主要リスク
1. **機能の損失**: 統合時の見落としによる機能喪失
   - 対策：包括的なテストスイートの事前準備

2. **パフォーマンス劣化**: 最適化の喪失
   - 対策：ベンチマークの継続的実行

3. **互換性の破壊**: 既存の使用方法が変わる可能性
   - 対策：段階的な移行とドキュメント化

4. **循環依存の再発**: 不適切な設計による問題の再発
   - 対策：依存関係チェックツールの導入

## 成功の判断基準

1. **技術的指標**
   - すべてのテストがパス
   - 循環依存が0
   - テストカバレッジ80%以上

2. **保守性指標**
   - 新機能追加が3ファイル以内で完結
   - バグ修正が1-2ファイルで完結
   - 新規開発者の理解時間が1日以内

3. **品質指標**
   - パフォーマンスの維持または向上
   - エラー率の低下
   - コードの可読性向上

## まとめ

CPHプロジェクトは理念と機能は優れているものの、実装の複雑さが実用性を損なっています。本計画では、CLAUDE.mdの原則を厳守しながら、段階的かつ着実に改善を進めます。特に循環依存の完全排除と責務の適切な配置に注力し、「理論的に完璧だが使いにくい」から「実用的で保守しやすい」ツールへの転換を図ります。

短期的な解決に頼らず、中長期的な視点で持続可能なアーキテクチャを構築することで、競技プログラミングコミュニティに真に価値のあるツールを提供します。