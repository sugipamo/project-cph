# CPHプロジェクト - Phase 1完了後の実装計画

**作成日**: 2025年6月27日 19:37  
**作成者**: Claude Code  
**ブランチ**: feature/dependency-reorganization  
**前回作業**: テストカバレッジ改善とCLAUDE.md違反の修正

## 現状サマリー

### 完了した作業
1. **テストカバレッジ分析**: 全112テストが合格、カバレッジ12%と判明
2. **循環依存の特定**: 3件の循環依存を検出
3. **CLAUDE.md違反の修正**: 設定システムとインフラ層のデフォルト値違反を修正
4. **遅延インポートの特定**: 7ファイルでTYPE_CHECKINGを使用した短期的解決を検出

### 残存する課題
1. **循環依存の解消**: 特に`config_node <-> config_node_logic`の密結合
2. **遅延インポートの除去**: 短期的解決から長期的解決への移行
3. **テストカバレッジの向上**: 12%から目標95%への改善
4. **アーキテクチャの簡素化**: 過度な抽象化の解消

## 優先実装計画

### Phase 1-A: 循環依存の完全解消（今回実施）

#### 1. config_node/config_node_logic の分離
**問題**: 相互参照による密結合
**解決方針**:
- ConfigNodeをデータクラスとして純粋化
- ロジック部分を別のサービスクラスに移動
- 依存方向を一方向に整理

#### 2. format_info/types の整理
**問題**: 型定義の相互参照
**解決方針**:
- 基本型定義を独立したモジュールに抽出
- 依存関係を明確化

#### 3. output_manager/types の依存解消
**問題**: アプリケーション層からユーティリティへの逆依存
**解決方針**:
- インターフェース定義をドメイン層に移動
- 実装をアプリケーション層に保持

### Phase 1-B: 遅延インポートの除去

#### 対象ファイル（優先順）:
1. `domain/config_node_logic.py` - 循環依存解消と同時に対応
2. `domain/step_runner.py` - ワークフロー実行の中核
3. `operations/results/result_factory.py` - 結果処理の基盤
4. `utils/types.py` - 型定義の整理
5. `application/sqlite_manager.py` - 永続化層の改善
6. `logging/unified_logger.py` - ログ出力の整理

### Phase 1-C: 重要モジュールのテスト追加

#### 優先テスト対象:
1. **設定システム** (configuration/*)
   - 設定読み込みの網羅的テスト
   - デフォルト値排除の確認テスト

2. **ワークフローエンジン** (domain/workflow.py, step_runner.py)
   - ステップ実行の正常系/異常系
   - 並列/逐次実行のテスト

3. **CLIインターフェース** (presentation/cli_app.py)
   - コマンド解析の網羅的テスト
   - エラーハンドリングの確認

## 実装手順

### Step 1: 循環依存の解消（30分）
1. config_nodeの純粋データクラス化
2. config_node_serviceの作成とロジック移動
3. 依存関係の整理と確認

### Step 2: 遅延インポートの段階的除去（45分）
1. 各ファイルの依存関係分析
2. インターフェース/実装の分離
3. 適切な層への配置

### Step 3: テストの追加（60分）
1. 設定システムの単体テスト作成
2. ワークフローエンジンの統合テスト作成
3. CLIの機能テスト作成

## 成功基準

### 今回の作業での達成目標:
- [ ] 循環依存: 0件
- [ ] 遅延インポート: 0件
- [ ] テストカバレッジ: 30%以上
- [ ] すべてのテストが合格
- [ ] CLAUDE.md原則への完全準拠

### 検証方法:
1. `src_check/generate_dependency_graph.py`で循環依存の確認
2. `grep -r "TYPE_CHECKING" src/`で遅延インポートの確認
3. `pytest --cov`でカバレッジ測定
4. `cargo test`で全テスト実行

## リスクと対策

### リスク:
1. **大規模リファクタリングによる機能破壊**
   - 対策: 小さな変更単位での実装とテスト

2. **依存関係の複雑化**
   - 対策: 各変更後の依存グラフ確認

3. **テスト追加による実行時間増大**
   - 対策: 並列実行可能なテスト設計

## 次回予定

### Phase 2: アーキテクチャの簡素化
- Driver統合（27ファイル→4ファイル）
- Request/Result型の統一
- Provider/Adapterの統合

---

**次回レビュー**: 本日作業完了後  
**目標完了時刻**: 2025年6月27日 21:00