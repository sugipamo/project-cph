# CPHアーキテクチャ簡素化計画

## 概要
現在134ファイルに分散したコードベースを段階的に統合し、60-70ファイルに削減する計画。
開発者体験の向上と保守性の改善を目的とする。

## 現状分析

### 問題点
- ファイル数: 134個（過度な分割）
- 新機能追加時: 5-8ファイルの編集が必要
- テストカバレッジ: 46%（目標80%）
- 高結合モジュール: main, di_container, di_config

### アーキテクチャ状態
- 7層のClean Architecture
- レイヤー間の依存違反が存在
- DIコンテナの初期化順序問題

## 段階的統合プラン

### Week 1: 基本型の統合（即座に実施可能）

#### 1. Logging型統合（3→1）
**対象ファイル**:
- `src/logging/log_format_type.py` (7行)
- `src/logging/log_types.py` (20行)
- `src/utils/types.py` (28行)

**統合先**: `src/logging/types.py`

**影響範囲**: 
- インポートパスの変更が必要なファイル: 約15-20個
- 循環依存の解消も同時に実現

#### 2. Execution型統合（3→1）
**対象ファイル**:
- `src/application/execution_history.py` (13行)
- `src/application/execution_types.py` (29行)
- `src/domain/workflow_result.py` (15行)

**統合先**: `src/application/execution_types.py`

**影響範囲**:
- インポートパスの変更が必要なファイル: 約10-15個

#### 3. Configuration型統合（2→1）
**対象ファイル**:
- `src/configuration/output_config.py` (11行)
- `src/configuration/execution_config.py` (13行)

**統合先**: `src/configuration/config_types.py`

**影響範囲**:
- インポートパスの変更が必要なファイル: 約5-10個

### Week 2: Driver系統統合（27→4）

#### 1. FileDriver統合
**現状**: file/ディレクトリ下に多数の小規模ファイル

**統合案**:
- `file_driver.py`: コアファイル操作
- `file_validators.py`: バリデーション関連
- `file_utilities.py`: ユーティリティ関数
- `file_types.py`: 型定義

#### 2. DockerDriver統合
**現状**: docker/ディレクトリ下に分散

**統合案**:
- `docker_driver.py`: コアDocker操作（既存）
- `docker_types.py`: 型定義とヘルパー

#### 3. ExecutionDriver統合
**現状**: generic/ディレクトリ下に分散

**統合案**:
- `execution_driver.py`: Shell/Python実行（既存）
- `execution_types.py`: 実行関連の型定義

### Week 3: Request/Result統合（13→2）

#### 1. Request統合
**現状**: operations/requests/下に多数のファイル

**統合案**:
- `execution_requests.py`: 全実行リクエスト型
- `request_factory.py`: ファクトリー（既存）

#### 2. Result統合
**現状**: operations/results/下に分散

**統合案**:
- `execution_results.py`: 全実行結果型
- `result_factory.py`: ファクトリー（既存）

### Week 4: Provider/Adapter統合（47→10）

#### 1. Infrastructure Providers
**統合案**:
- `system_providers.py`: OS, JSON, Time, Sysプロバイダー
- `mock_providers.py`: テスト用モックプロバイダー
- `docker_naming_provider.py`: Docker命名規則（既存）

#### 2. Adapters/Utilities
**統合案**:
- `logging_adapters.py`: 各種ロガーアダプター
- `file_utilities.py`: ファイルユーティリティ
- `validation_utilities.py`: バリデーション関連

## 実装順序と優先度

### Phase 1（即座に実施）
1. Logging型統合 - **最優先**（循環依存解消）
2. 小規模ファイルの統合テスト作成

### Phase 2（1週間以内）
1. Execution型統合
2. Configuration型統合
3. 統合後のテスト実行と修正

### Phase 3（2週間以内）
1. Driver系統合の開始
2. 影響範囲の大きいものから段階的に実施

### Phase 4（1ヶ月以内）
1. Request/Result統合
2. Provider/Adapter統合
3. 全体的なリファクタリング

## 成功指標

### 定量的指標
- ファイル数: 134個 → 60-70個（50%削減）
- 新機能追加時の編集ファイル数: 5-8個 → 2-3個
- テストカバレッジ: 46% → 80%
- テスト実行時間: 2秒以内を維持

### 定性的指標
- ナビゲーションの容易さ
- 新規開発者の学習時間短縮
- コードレビューの効率化

## リスクと対策

### リスク1: 大規模な変更による既存機能の破壊
**対策**: 
- 段階的な統合
- 各フェーズでのテスト実行
- git branchでの作業

### リスク2: インポートパスの大量変更
**対策**:
- 自動化ツールの活用
- 段階的な移行
- 互換性レイヤーの一時的な提供

### リスク3: チーム内の合意形成
**対策**:
- 小規模な統合から開始
- 効果の可視化
- 定期的なレビュー

## 次のアクション

1. **本日中**: Logging型統合の実施
2. **今週中**: Phase 1完了とPhase 2の開始
3. **定期レビュー**: 週次で進捗確認と計画調整