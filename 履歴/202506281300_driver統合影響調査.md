# Driver統合の影響範囲調査結果

## 1. drivers配下のdriverファイル一覧

### 現在のdriver構成
```
src/infrastructure/drivers/
├── generic/
│   ├── base_driver.py         # 基底クラス
│   ├── unified_driver.py      # 統合ドライバー（削除対象）
│   ├── persistence_driver.py  # 永続化ドライバー（統合対象）
│   └── execution_driver.py    # 実行ドライバー
├── docker/
│   └── docker_driver.py       # Dockerドライバー
└── file/
    └── file_driver.py         # ファイルドライバー
```

## 2. UnifiedDriverの使用箇所

### 本番コード
- `src/configuration/di_config.py`: UnifiedDriverのインスタンス生成
- `src/domain/services/workflow_execution_service.py`: unified_driverの解決

### テストコード
- `tests/infrastructure/specialized_drivers/test_unified_driver.py`: UnifiedDriverのテスト

### UnifiedDriverの主要機能
- 各種リクエスト（Docker、File、Shell、Python）を適切なドライバーにルーティング
- `execute_operation_request()`メソッドでリクエストタイプに応じた処理
- 各ドライバーへの委譲メソッド（mkdir、rmtree等）

## 3. PersistenceDriverの使用箇所

### 本番コード
- `src/configuration/di_config.py`: SQLitePersistenceDriverのインポート

### テストコード
- `tests/infrastructure/specialized_drivers/test_persistence_driver.py`: PersistenceDriverのテスト
- `tests/configuration/test_di_config_simple.py`: テスト内で使用

### PersistenceDriverの主要機能
- ExecutionDriverInterfaceとPersistenceInterfaceを実装
- SQLiteデータベースへのアクセス機能
- リポジトリパターンのサポート

## 4. BaseDriver（ExecutionDriverInterface）の使用箇所

### 継承関係
- `DockerDriver`: BaseDriverImplementationを継承
- `FileDriver`: BaseDriverImplementationを継承
- `ExecutionDriver`: BaseDriverImplementationを継承
- `PersistenceDriver`: ExecutionDriverInterfaceを継承

### BaseDriverの主要機能
- `execute_command()`: 抽象メソッド
- `validate()`: リクエスト検証
- インフラストラクチャデフォルト値の管理
- ロギング機能

## 5. 各driverのpublicインターフェース

### DockerDriver
- `execute_command()`: Dockerリクエストの実行
- `validate()`: リクエスト検証
- `run_container()`, `stop_container()`, `build_docker_image()` 等のDocker操作

### FileDriver
- `execute_command()`: ファイル操作リクエストの実行
- `validate()`: リクエスト検証
- `read_file()`, `create_file()`, `copy()`, `move()`, `remove()`, `mkdir()` 等のファイル操作

### ExecutionDriver
- `execute_command()`: Shell/Pythonリクエストの実行
- `validate()`: リクエスト検証
- `execute_shell_command()`, `run_python_script()`, `run_python_code()`

### PersistenceDriver
- `execute_command()`: 永続化リクエストの実行
- `validate()`: リクエスト検証
- `get_connection()`, `execute_query()`, `execute_persistence_command()`, `get_repository()`

## 6. 影響を受けるモジュール

### UnifiedDriver削除の影響
1. **di_config.py**: UnifiedDriverの生成処理の変更が必要
2. **workflow_execution_service.py**: unified_driverの解決方法の変更が必要
3. **test_unified_driver.py**: テストの削除または移行が必要

### PersistenceDriverの統合の影響
1. **di_config.py**: SQLitePersistenceDriverのインポートパスの変更が必要
2. **test_persistence_driver.py**: テストの移行が必要

## 7. 推奨される統合アプローチ

### UnifiedDriverの機能移行
1. ルーティング機能を各ドライバーまたは新しいコーディネーターに移行
2. ファイル操作の委譲メソッドを削除（直接FileDriverを使用）
3. DIコンテナで個別のドライバーを解決するように変更

### PersistenceDriverの統合
1. PersistenceDriverの機能をbase_driver.pyに移行
2. SQLitePersistenceDriverを別ファイルとして保持
3. インターフェースの整合性を保つ

## 8. テストファイルへの影響
- UnifiedDriverのテストは削除または他のテストに統合
- PersistenceDriverのテストはbase_driverのテストに統合
- モックドライバーは現状維持（MockDockerDriver、MockFileDriver等）