# CPHプロジェクト依存関係再編成計画 - 202506280151

## 現状認識

### プロジェクトの現在地
- **ブランチ**: feature/dependency-reorganization
- **直近の作業**: テストカバレッジ向上とテスト修正
- **現在の課題**: 過度な抽象化による開発効率の低下

### これまでの経緯
1. **プロジェクト再生宣言** (2025年6月25日)
   - 75個のディレクトリ、150個のファイルの複雑性を指摘
   - 4週間での段階的統合計画を策定
   
2. **Week 1: Driver系統統合** (進行中)
   - 14個のDriver関連ディレクトリを4個への統合を目標
   - infrastructure/drivers配下の再編成を実施中

3. **直近の作業** (202506280124)
   - cargo testの実行と問題対応
   - 古い実装に基づくテストの削除
   - テストカバレッジの向上

## 要件定義からの学び

### CPHの本質的価値
1. **競技プログラミング環境の統一**
   - 言語の壁を越える（Python、C++、Rust）
   - 環境差異からの解放
   - 繰り返し作業の自動化

2. **ユーザー提供価値**
   - 時間の創出（セットアップ、テスト実行の自動化）
   - ストレスからの解放（環境依存エラーの最小化）
   - 学習効率の向上（実行履歴からの振り返り）

3. **基本ワークフロー**
   - `cph new`: 新規問題の準備
   - `cph test`: テスト実行
   - `cph submit`: 提出準備
   - `cph run`: 単体実行

## 統合計画の更新

### 現在の重点課題
1. **循環インポート問題**
   - CLAUDE.mdの指摘通り、遅延インポートによる強引な解決は避ける
   - 責務の配置を根本から見直す

2. **密結合の解消**
   - 意図的な密結合を排除
   - 中長期を見据えた実装への転換

3. **設定管理の改善**
   - デフォルト値の使用禁止の徹底
   - src/configuration/readme.mdに従った設定取得

### Week 1修正計画: Driver系統統合

#### 現在の問題点
```
src/infrastructure/drivers/
├── docker/          # docker_driver.pyとdocker_command_utils.pyが分離
├── file/            # integrated_file_driver.pyが単独
├── generic/         # base_driver、persistence_driver、unified_driverが散在
└── shell_python_driver.py  # ルートレベルに配置
```

#### 統合方針（CLAUDE.md準拠）
1. **責務の明確化**
   - DockerDriver: コンテナ管理専用
   - FileDriver: ファイルシステム操作専用
   - ExecutionDriver: コマンド実行専用
   - PersistenceDriver: データ永続化専用

2. **副作用の集約**
   - すべてのドライバーをmain.pyから注入
   - infrastructureレイヤーのみに副作用を限定

3. **設定の外部化**
   - ドライバー内でのデフォルト値使用を完全排除
   - configurationレイヤーからの設定注入

#### 実装手順
1. **依存関係の分析**
   - 各ドライバーの相互依存を洗い出し
   - 循環参照の特定と解消

2. **インターフェースの再設計**
   - operations/interfacesの活用
   - 抽象化レベルの適正化

3. **段階的移行**
   - テストを維持しながら1ファイルずつ統合
   - 各段階でcargo test実行

### Week 2-4の展望

#### Week 2: Request/Result統合
- operations/requests配下の統一
- ファクトリーパターンの簡素化
- 型安全性の維持

#### Week 3: Provider/Adapter統合
- 50行未満のファイルを機能別に集約
- 学習コストの大幅削減
- 名前空間の整理

#### Week 4: テスト環境整理
- Mock系統の統合
- テストカバレッジ90%以上の維持
- CI/CDパイプラインの最適化

## リスク管理

### 特に注意すべき点
1. **CLAUDE.mdの遵守**
   - 短期的な解決の誘惑に負けない
   - 中長期的な視点での実装

2. **機能の完全性**
   - 統合による機能損失は絶対に避ける
   - テストによる品質保証

3. **パフォーマンス**
   - 統合によるオーバーヘッドを監視
   - 実行速度の劣化を防ぐ

## 次のアクション

### 即時実施（本日中）
1. Driver系統の依存関係グラフを作成
2. 循環インポートの完全な洗い出し
3. 統合の影響範囲の特定

### 短期実施（3日以内）
1. BaseDriverインターフェースの再設計
2. 各ドライバーの責務の明文化
3. 統合テストスイートの準備

### 継続実施
1. 日次でのテスト実行とカバレッジ確認
2. 週次での進捗レビュー
3. CLAUDE.md準拠の確認

## 成功の定義

### 定量的指標
- ドライバー関連ファイル: 14個 → 4個（71%削減）
- 新機能追加時の編集: 現在8ファイル → 3ファイル以下
- テストカバレッジ: 90%以上を維持
- 実行速度: 現状維持または改善

### 定性的指標
- コードの可読性向上
- 新規開発者の理解時間短縮
- 保守作業の効率化
- CLAUDE.mdの理念の実現

## まとめ

本計画は、CPHプロジェクトの依存関係再編成の第一歩として、Driver系統の統合に焦点を当てています。CLAUDE.mdの指摘を真摯に受け止め、短期的な解決ではなく、中長期的な視点での健全なアーキテクチャを構築します。

過度な抽象化を解消しながらも、Clean Architectureの利点を維持し、開発者にとって使いやすく、保守しやすいツールへと進化させることが目標です。

計画開始日: 2025年6月28日
第1フェーズ完了予定: 2025年7月5日（1週間）
全体完了予定: 2025年7月23日（4週間）