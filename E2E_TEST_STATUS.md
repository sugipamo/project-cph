# E2Eテスト現状報告

## 📊 テスト結果サマリー

### 現在の状況 (4/7 PASS)
- ✅ **環境クリーンアップ**: PASS
- ❌ **新しいコンテスト問題を開く**: FAIL
- ✅ **コードにエラーを追加**: PASS
- ❌ **別のコンテストに切り替え**: FAIL
- ✅ **テスト実行**: PASS
- ❌ **元のコンテストに復元**: FAIL
- ✅ **エラーありでのテスト実行**: PASS

### 改善の推移
- **開始時**: 2/7 PASS (29%)
- **現在**: 4/7 PASS (57%)
- **目標**: 7/7 PASS (100%)

## 🔍 失敗している問題の詳細

### 1. 新しいコンテスト問題を開く (FAIL)
**症状**: `contest_current/test` ディレクトリが存在しない
```
[INFO] ファイル確認: contest_current/test -> 不存在 (期待と異なる)
```

**原因**: 
- ワークフローでテストファイルがworkspaceからcontest_currentに移動されていない
- `oj download`でテストファイルはworkspace/testに正しくダウンロードされている
- しかし、移動ステップが実行されていない、または失敗している

### 2. 別のコンテストに切り替え (FAIL)
**症状**: 同様にテストディレクトリが移動されない
```
[INFO] ファイル確認: contest_current/test -> 不存在 (期待と異なる)
```

**原因**: 上記と同じテストファイル移動の問題

### 3. 元のコンテストに復元 (FAIL)
**症状**: `raise Exception()`が復元されない
```
[INFO] ファイル内容確認: contest_current/main.py
[INFO] 内容: N, M = list(map(int, input().split()))
A = list(map(int, input().split()))
[INFO] 期待内容チェック: 不一致  # raise Exception()が無い
```

**原因**: 
- `contest_stock`には正しく`raise Exception()`が保存されている
- 復元時に「📁 Restored from contest_stock」メッセージは表示される
- しかし、その後のワークフロー実行で何かがファイルを上書きしている

## 🔧 試行した修正とその結果

### 1. メソッドシグネチャ修正 ✅
- `ProblemWorkspaceService.switch_to_problem()`: 引数の不整合を修正
- `FilePreparationService.move_files_by_patterns()`: 引数の不整合を修正
- `WorkspaceDriver`: エラーメッセージの適切な処理
- **結果**: "No error output"エラーは解決

### 2. ファイルパターンサービス修正 ⚠️
- Legacy fallbackの実装を追加
- デバッグログの追加
- **結果**: パターンサービスはlegacy fallbackに戻るが、ファイル移動は機能しない

### 3. ワークフロー設定の変更 ❌
```json
// 変更前
{
  "type": "file_preparation",
  "operation_type": "move_test_files"
}

// 変更後
{
  "type": "shell",
  "cmd": ["mv", "{workspace_path}/test", "{contest_current_path}/"]
}
```
- **結果**: シンプルなshellコマンドでも移動が失敗

### 4. アーカイブパス修正 ⚠️
- `contest_stock_path`の重複パス構築を修正
- **結果**: アーカイブは正しく動作するが、復元後に上書きされる問題は未解決

## 🏗️ 現在のアーキテクチャの問題

### 1. ワークフロー実行順序の問題
```
1. workspace_switch (復元成功)
2. python (ブラウザ開く)
3. shell (cursor起動)
4. shell/oj (テストファイルダウンロード) <- ここで問題発生？
```

### 2. ファイル移動の複雑性
- `ProblemWorkspaceService`
- `FilePreparationService`
- `FilePatternService`
- ワークフロー設定
- 複数の層でファイル操作が重複・競合

### 3. デバッグの困難さ
- 複数のサービスが相互作用
- エラーログが不十分
- 実際の実行フローが追跡困難

## 📝 検証された事実

### ✅ 正常に動作している部分
1. **アーカイブ機能**: ファイルは正しく`contest_stock`に保存される
2. **復元機能**: 復元メッセージは表示され、一時的には正しく復元される
3. **基本ワークフロー**: ステップ実行自体は成功している
4. **テストファイルダウンロード**: `oj download`は正常にworkspace/testに保存

### ❌ 失敗している部分
1. **テストディレクトリ移動**: workspace/test → contest_current/test
2. **ファイル内容保持**: 復元後のmain.pyが上書きされる
3. **ワークフロー統合**: 個別の機能は動作するが、統合時に問題発生

## 🎯 根本原因の仮説

### 仮説1: ワークフロー実行順序
復元後に`oj download`や他のステップがファイルを上書きしている

### 仮説2: ファイルパターンサービスの設定不備
パターンマッチングが失敗し、ファイル移動が実行されない

### 仮説3: パス解決の問題
相対パスと絶対パスの混在により、正しいファイル操作ができない

## 🚨 緊急対応が必要な問題

1. **テストディレクトリ移動の完全な失敗**
   - 現在どのアプローチでも移動できていない
   - E2Eテストの基本機能に影響

2. **ファイル復元の不安定性**
   - アーカイブは成功するが復元が不完全
   - ユーザーの作業内容が失われるリスク

3. **デバッグ情報の不足**
   - 実際に何が起きているか追跡困難
   - 根本原因の特定が困難

## 💡 推奨される次のステップ

1. **シンプルなデバッグアプローチ**
   - 各ステップの前後でファイル状態をログ出力
   - 実際のファイル移動コマンドの実行結果を確認

2. **最小限の動作確認**
   - 複雑なパターンサービスを一旦無視
   - 直接的なファイル操作で動作確認

3. **段階的な機能回復**
   - まずテストディレクトリ移動のみ修正
   - その後ファイル復元問題に取り組む