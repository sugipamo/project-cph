# 依存関係ベースフォルダ構造整理 課題対応方針

## 1. 循環依存への対応

### 問題
- モジュールA→B→A のような循環依存がある場合、階層配置が不可能
- Pythonでは循環インポートはランタイムエラーの原因

### 対応方針

#### 1.1 検出と報告
```python
# 実装方針例
def detect_circular_dependencies():
    # DFSベースの循環検出
    # 検出した循環をユーザーに報告
    # 整理処理を中断
```

#### 1.2 循環依存解決手順
1. **手動解決優先**: 循環検出時は処理を停止し、ユーザーに解決を促す
2. **共通モジュール抽出**: 循環の原因となる共通部分を別モジュールに分離
3. **依存関係の再設計**: インターフェース分離や依存性注入の活用

#### 1.3 一時的回避策
- **WARNING扱い**: 循環があるファイルは移動対象から除外
- **ログ出力**: 循環依存の詳細をファイルに記録
- **dry-run**: 循環検出時の影響範囲を事前表示

---

## 2. インポートパス更新の自動化

### 問題
- ファイル移動後のインポート文の自動更新が複雑
- 相対/絶対インポートの判定と変換
- 外部参照（テストファイル等）への影響

### 対応方針

#### 2.1 インポート最優先アプローチ
```python
# 移動と同時にインポート更新を実行
def move_and_update_imports(file_path, new_path):
    # 1. 移動前にインポート関係を全解析
    # 2. ファイル移動
    # 3. 即座にインポートパス更新
    # 4. インポートエラー検証
    # 5. エラーがあれば即座にロールバック

def validate_imports():
    # syntax checkでインポートエラーを検出
    # 問題があれば移動を取り消し
```

#### 2.2 インポート更新戦略
1. **絶対インポート統一**: `from src.module import func` 形式に統一
2. **アトミック更新**: 1ファイル移動毎に即座にインポート更新+検証
3. **高速ロールバック**: エラー検出時の即座復元
4. **事前シミュレーション**: dry-runでインポート更新をテスト

#### 2.3 更新対象の制限
- **src/以下のみ**: プロジェクト内ファイルに限定
- **テストファイル除外**: `test_*.py`, `*_test.py` は対象外
- **設定ファイル除外**: 設定関連ファイルは手動対応

---

## 3. 深い階層による可読性低下への対策

### 問題
- 依存関係が深い場合、過度に深いフォルダ構造
- パス名が長くなり、開発体験が悪化
- IDEでのナビゲーションが困難

### 対応方針

#### 3.1 階層深度制限
```python
MAX_DEPTH = 4  # src/から最大4階層まで

def limit_depth(dependency_level):
    if dependency_level > MAX_DEPTH:
        return MAX_DEPTH  # 最深階層にまとめて配置
    return dependency_level
```

#### 3.2 グループ化戦略
- **同一深度グループ**: 依存度が同じファイルを1つのフォルダにまとめる
- **機能別グループ**: 関連性の高いモジュールを近くに配置
- **フラット化オプション**: 設定で階層化を無効にできる機能

#### 3.3 可読性向上施策
1. **フォルダ命名規則**: `depth_N/` のような深度表示
2. **READMEファイル**: 各階層に構造説明を自動生成
3. **IDE設定**: 推奨フォルダ表示設定をドキュメント化

---

## 4. 実装優先順位（インポート解決最優先）

### Phase 1: インポート解決基盤
- [ ] ASTベースインポート解析エンジン
- [ ] インポートパス更新アルゴリズム
- [ ] インポートエラー検証機能

### Phase 2: 安全な移動実装
- [ ] 依存関係解析エンジン
- [ ] ファイル移動+即座のインポート更新
- [ ] バックアップ機能

### Phase 3: 高度な機能
- [ ] 循環依存検出
- [ ] 階層深度制限
- [ ] グループ化オプション

---

## 5. 設定項目

```json
{
  "max_depth": 4,
  "enable_import_update": true,  // デフォルトでインポート更新ON
  "import_validation": true,     // 移動後の即座検証
  "atomic_operations": true,     // ファイル毎のアトミック処理
  "backup_enabled": true,
  "exclude_patterns": ["test_*.py", "*_test.py"],
  "grouping_strategy": "depth",  // "depth" | "functional" | "flat"
  "circular_dependency_action": "stop"  // "stop" | "warn" | "skip"
}
```

---

## 6. リスク軽減策

### 6.1 実行前チェック
- Gitコミット状態の確認
- テストの実行状況確認
- バックアップディレクトリの容量確認

### 6.2 実行中監視
- 各ステップの成功/失敗状況
- インポートエラーの発生監視
- ファイル整合性チェック

### 6.3 ロールバック機能
- 移動前状態への復元
- 部分的な変更の取り消し
- エラー発生時の自動復旧

---

## 7. 今後の検討事項

- **外部ツール連携**: Black, isort との統合
- **IDE拡張**: VSCode拡張での階層表示
- **メトリクス収集**: 整理前後の複雑度測定
- **チーム運用**: 複数開発者での運用ガイドライン